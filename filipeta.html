<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Reservas - Sistema de Relat√≥rios PDF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a6fa5;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .app-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload {
            border: 2px dashed #3498db;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background-color: white;
        }

        .file-upload:hover {
            background-color: #e8f4fc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .file-upload input {
            display: none;
        }

        .upload-label {
            font-size: 1.4rem;
            color: #3498db;
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .file-info {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 1.2rem;
            padding: 16px 32px;
        }

        .btn-pdf:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            color: white;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card:nth-child(2) {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .summary-card:nth-child(3) {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .summary-card:nth-child(4) {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .data-preview {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-preview th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-preview td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .data-preview tr:hover {
            background-color: #f8f9fa;
        }

        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .status-aprovada {
            color: #27ae60;
            font-weight: bold;
        }

        .status-cancelada {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-pendente {
            color: #f39c12;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .pdf-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .pdf-option-group {
            margin-bottom: 25px;
        }

        .pdf-option-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
        }

        .notification-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .report-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-type-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .report-type-btn.active {
            border-color: #3498db;
            background-color: #e8f4fc;
            color: #3498db;
            font-weight: bold;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .totais-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .totais-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .total-item {
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .total-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .total-value {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .pdf-options-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .report-type-selector {
                flex-direction: column;
            }
            
            .report-type-btn {
                min-width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/locale/pt-br.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¶ SISTEMA DE RELAT√ìRIOS B2B RESERVAS</h1>
            <p class="subtitle">Gere filipetas de vendas POS e relat√≥rios detalhados</p>
        </header>

        <section class="app-section">
            <h2>üìÅ 1. CARREGAR ARQUIVO</h2>
            <div class="file-upload" id="dropArea">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                <label for="fileInput" class="upload-label">
                    üìÇ CLIQUE PARA SELECIONAR OU ARRASTE SEU ARQUIVO
                </label>
                <p class="file-info">Formatos suportados: CSV, Excel (XLSX, XLS)</p>
                <p id="fileName" class="file-info">‚ö†Ô∏è Nenhum arquivo selecionado</p>
            </div>
            
            <div id="dataPreview" class="data-preview">
                <h3>üìã Pr√©-visualiza√ß√£o dos Dados</h3>
                <table id="previewTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Data Transacao</th>
                            <th>Valor Total</th>
                            <th>Valor L√≠quido</th>
                            <th>Cart√£o</th>
                            <th>Di√°rias</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
                <div id="dataStats" class="data-stats"></div>
                <div id="totaisPreview" class="totais-container" style="display: none;">
                    <h4>üìä Totais por Campo</h4>
                    <div id="totaisGrid" class="totais-grid"></div>
                </div>
            </div>
        </section>

        <section class="app-section">
            <h2>üîç 2. FILTRAR DADOS</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterStatus">üìä Status</label>
                    <select id="filterStatus">
                        <option value="">Todos os Status</option>
                        <option value="Aprovada">‚úÖ Aprovada</option>
                        <option value="Cancelada">‚ùå Cancelada</option>
                        <option value="Pendente">‚è≥ Pendente</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterDataInicio">üìÖ Data Transa√ß√£o (De)</label>
                    <input type="date" id="filterDataInicio">
                </div>

                <div class="filter-group">
                    <label for="filterDataFim">üìÖ Data Transa√ß√£o (At√©)</label>
                    <input type="date" id="filterDataFim">
                </div>

                <div class="filter-group">
                    <label for="filterValorMin">üí∞ Valor M√≠nimo (R$)</label>
                    <input type="number" id="filterValorMin" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterValorMax">üí∞ Valor M√°ximo (R$)</label>
                    <input type="number" id="filterValorMax" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterBandeira">üí≥ Bandeira do Cart√£o</label>
                    <select id="filterBandeira">
                        <option value="">Todas as Bandeiras</option>
                        <option value="VISA">VISA</option>
                        <option value="MASTERCARD">MASTERCARD</option>
                        <option value="ELO">ELO</option>
                        <option value="AMEX">AMERICAN EXPRESS</option>
                    </select>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-primary" id="btnFiltrar">üîç APLICAR FILTROS</button>
                <button class="btn-secondary" id="btnLimparFiltros">üóëÔ∏è LIMPAR FILTROS</button>
                <button class="btn-danger" id="btnExportarExcel">üíæ EXPORTAR CSV</button>
            </div>
        </section>

        <section class="app-section">
            <h2>üìä 3. RESUMO DO RELAT√ìRIO</h2>
            <div class="summary-grid" id="resumo">
                <div class="summary-card">
                    <div class="summary-value" id="totalTransacoes">0</div>
                    <div class="summary-label">Transa√ß√µes</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorTotal">R$ 0,00</div>
                    <div class="summary-label">Valor Total</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorLiquido">R$ 0,00</div>
                    <div class="summary-label">Valor L√≠quido</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="diariasTotal">0</div>
                    <div class="summary-label">Di√°rias Totais</div>
                </div>
            </div>
        </section>

        <section class="app-section">
            <h2>üìÑ 4. GERAR RELAT√ìRIOS</h2>
            
            <div class="report-type-selector">
                <div class="report-type-btn active" id="btnFilipeta">üè∑Ô∏è FILIPETA POS</div>
                <div class="report-type-btn" id="btnRelatorioDetalhado">üìä RELAT√ìRIO DETALHADO</div>
                <div class="report-type-btn" id="btnResumoAprovadas">‚úÖ RESUMO APROVADAS</div>
                <div class="report-type-btn" id="btnFilipetaImpressora">üñ®Ô∏è FILIPETA IMPRESSORA</div>
            </div>
            
            <p style="margin-bottom: 20px; font-size: 1.1rem; color: #2c3e50;">
                <strong>üéØ Filipeta POS:</strong> Relat√≥rio simplificado para confer√™ncia di√°ria.<br>
                <strong>üìä Relat√≥rio Detalhado:</strong> Todos os campos em formato paisagem.<br>
                <strong>‚úÖ Resumo Aprovadas:</strong> Todas transa√ß√µes aprovadas para impress√£o.<br>
                <strong>üñ®Ô∏è Filipeta Impressora:</strong> Formato longo para m√°quina de filipeta.
            </p>
            
            <div class="buttons">
                <button class="btn-pdf" id="btnGerarPDF">üìä GERAR RELAT√ìRIO</button>
                <button class="btn-primary" id="btnConfigPDF">‚öôÔ∏è CONFIGURA√á√ïES</button>
                <button class="btn-secondary" id="btnGerarTodasFilipetas">üñ®Ô∏è FILIPETAS INDIVIDUAIS</button>
            </div>
        </section>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è CONFIGURA√á√ïES DO RELAT√ìRIO</h2>
                <span class="close-modal" id="closeModal">√ó</span>
            </div>
            
            <div class="pdf-options-grid">
                <div class="pdf-option-group">
                    <label for="pdfTitle">üìù T√≠tulo do Relat√≥rio:</label>
                    <input type="text" id="pdfTitle" value="RELAT√ìRIO DE VENDAS B2B RESERVAS">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfSubtitle">üìù Subt√≠tulo:</label>
                    <input type="text" id="pdfSubtitle" value="Filipeta POS - Transa√ß√µes Detalhadas">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfDataRelatorio">üìÖ Data do Relat√≥rio:</label>
                    <input type="date" id="pdfDataRelatorio" value="">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfFontSize">üî§ Tamanho da Fonte:</label>
                    <select id="pdfFontSize">
                        <option value="8">Pequeno (8pt)</option>
                        <option value="9" selected>Normal (9pt)</option>
                        <option value="10">Grande (10pt)</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfIncludeSummary">üìä Incluir Resumo:</label>
                    <select id="pdfIncludeSummary">
                        <option value="true" selected>‚úÖ Sim</option>
                        <option value="false">‚ùå N√£o</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfOrientation">üìê Orienta√ß√£o:</label>
                    <select id="pdfOrientation">
                        <option value="portrait">üìÑ Retrato</option>
                        <option value="landscape" selected>üèûÔ∏è Paisagem</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons" style="margin-top: 30px; border: none;">
                <button class="btn-pdf" id="btnGerarPDFConfirmar">üìä GERAR PDF</button>
                <button class="btn-secondary" id="btnCancelarPDF">‚Ü©Ô∏è CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; font-size: 1.2rem;">Processando dados...</p>
    </div>

    <script>
        // Configura√ß√µes
        dayjs.locale('pt-br');
        window.jsPDF = window.jspdf.jsPDF;
        
        // Campos esperados EXATAMENTE como na planilha
        const CAMPOS_ESPERADOS = [
            'Status',
            'Data Transacao',
            'Data Recebimento',
            'Total Diarias',
            'Valor Extras',
            'Valor Taxas',
            'Valor Impostos',
            'Valor total da transacao',
            'Tarifa',
            'Comissoes',
            'Taxa de Servico B2B',
            'Valor Adquirencia',
            'Valor Liquido',
            'N√∫mero do Cartao',
            'Bandeira do Cartao'
        ];
        
        // Campos que s√£o num√©ricos - CADA UM COM SEU PR√ìPRIO TOTAL
        const CAMPOS_NUMERICOS = [
            'Total Diarias',
            'Valor Extras',
            'Valor Taxas',
            'Valor Impostos',
            'Valor total da transacao',
            'Comissoes',
            'Taxa de Servico B2B',
            'Valor Adquirencia',
            'Valor Liquido'
        ];
        
        // Vari√°veis globais
        let dadosOriginais = [];
        let dadosFiltrados = [];
        let tipoRelatorioAtual = 'filipeta';
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const fileName = document.getElementById('fileName');
        const dataPreview = document.getElementById('dataPreview');
        const previewBody = document.getElementById('previewBody');
        const dataStats = document.getElementById('dataStats');
        const totaisPreview = document.getElementById('totaisPreview');
        const totaisGrid = document.getElementById('totaisGrid');
        const pdfModal = document.getElementById('pdfModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Filtros
        const filterStatus = document.getElementById('filterStatus');
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        const filterValorMin = document.getElementById('filterValorMin');
        const filterValorMax = document.getElementById('filterValorMax');
        const filterBandeira = document.getElementById('filterBandeira');
        
        // Bot√µes
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnLimparFiltros = document.getElementById('btnLimparFiltros');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnGerarPDF = document.getElementById('btnGerarPDF');
        const btnConfigPDF = document.getElementById('btnConfigPDF');
        const btnGerarTodasFilipetas = document.getElementById('btnGerarTodasFilipetas');
        const btnGerarPDFConfirmar = document.getElementById('btnGerarPDFConfirmar');
        const btnCancelarPDF = document.getElementById('btnCancelarPDF');
        const closeModal = document.getElementById('closeModal');
        
        // Configura√ß√µes PDF
        const pdfTitle = document.getElementById('pdfTitle');
        const pdfSubtitle = document.getElementById('pdfSubtitle');
        const pdfDataRelatorio = document.getElementById('pdfDataRelatorio');
        const pdfFontSize = document.getElementById('pdfFontSize');
        const pdfIncludeSummary = document.getElementById('pdfIncludeSummary');
        const pdfOrientation = document.getElementById('pdfOrientation');
        
        // Resumo
        const totalTransacoes = document.getElementById('totalTransacoes');
        const valorTotal = document.getElementById('valorTotal');
        const valorLiquido = document.getElementById('valorLiquido');
        const diariasTotal = document.getElementById('diariasTotal');
        
        // Bot√µes de tipo de relat√≥rio
        const btnFilipeta = document.getElementById('btnFilipeta');
        const btnRelatorioDetalhado = document.getElementById('btnRelatorioDetalhado');
        const btnResumoAprovadas = document.getElementById('btnResumoAprovadas');
        const btnFilipetaImpressora = document.getElementById('btnFilipetaImpressora');
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', inicializarApp);
        fileInput.addEventListener('change', handleFileUpload);
        btnFiltrar.addEventListener('click', aplicarFiltros);
        btnLimparFiltros.addEventListener('click', limparFiltros);
        btnExportarExcel.addEventListener('click', exportarParaExcel);
        btnGerarPDF.addEventListener('click', abrirModalPDF);
        btnConfigPDF.addEventListener('click', abrirModalPDF);
        btnGerarTodasFilipetas.addEventListener('click', gerarTodasFilipetas);
        btnGerarPDFConfirmar.addEventListener('click', gerarPDF);
        btnCancelarPDF.addEventListener('click', fecharModalPDF);
        closeModal.addEventListener('click', fecharModalPDF);
        
        btnFilipeta.addEventListener('click', () => selecionarTipoRelatorio('filipeta'));
        btnRelatorioDetalhado.addEventListener('click', () => selecionarTipoRelatorio('detalhado'));
        btnResumoAprovadas.addEventListener('click', () => selecionarTipoRelatorio('aprovadas'));
        btnFilipetaImpressora.addEventListener('click', () => selecionarTipoRelatorio('filipetaImpressora'));
        
        window.addEventListener('click', (e) => { if (e.target === pdfModal) fecharModalPDF(); });
        
        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '#e8f4fc');
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '');
        });
        
        dropArea.addEventListener('drop', handleDrop);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                fileInput.files = files;
                handleFileUpload();
            }
        }
        
        // Inicializa√ß√£o
        function inicializarApp() {
            // Configurar datas padr√£o para novembro 2025 (como na planilha de exemplo)
            filterDataInicio.value = '2025-11-01';
            filterDataFim.value = '2025-11-30';
            
            // Configurar data do relat√≥rio como data atual
            const hoje = new Date().toISOString().split('T')[0];
            pdfDataRelatorio.value = hoje;
            
            console.log('‚úÖ Sistema B2B PDF inicializado!');
        }
        
        // Fun√ß√£o principal para processar upload
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            fileName.textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            fileName.style.color = '#27ae60';
            
            mostrarLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const extensao = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                    const data = e.target.result;
                    
                    if (extensao === '.csv') {
                        processarCSV(data);
                    } else {
                        processarExcel(data);
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                    console.error('Erro no processamento:', error);
                    limparDados();
                } finally {
                    mostrarLoading(false);
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Processar Excel CORRETAMENTE - SEM REMOVER PONTOS DOS N√öMEROS
        function processarExcel(data) {
            try {
                const workbook = XLSX.read(data, { 
                    type: 'array', 
                    cellDates: true,
                    raw: true // IMPORTANTE: manter raw true para n√£o converter automaticamente
                });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                
                if (jsonData.length < 2) {
                    mostrarNotificacao('Arquivo vazio ou inv√°lido', 'error');
                    return;
                }
                
                const cabecalhos = jsonData[0];
                dadosOriginais = [];
                
                // Mapear √≠ndices dos campos
                const indicesCampos = {};
                cabecalhos.forEach((cabecalho, index) => {
                    const nomeNormalizado = normalizarNomeCampo(cabecalho);
                    indicesCampos[nomeNormalizado] = index;
                });
                
                for (let i = 1; i < jsonData.length; i++) {
                    const linha = jsonData[i];
                    if (!linha || linha.length === 0) continue;
                    
                    const registro = {};
                    
                    // Processar cada campo esperado
                    CAMPOS_ESPERADOS.forEach(campo => {
                        const nomeNormalizado = normalizarNomeCampo(campo);
                        const indice = indicesCampos[nomeNormalizado];
                        
                        let valor = '';
                        if (indice !== undefined && linha[indice] !== undefined) {
                            valor = linha[indice];
                            
                            // Converter datas
                            if (valor instanceof Date) {
                                valor = dayjs(valor).format('DD/MM/YYYY HH:mm:ss');
                            } else if (valor !== null && valor !== undefined) {
                                valor = String(valor).trim();
                            }
                        }
                        
                        registro[campo] = valor;
                    });
                    
                    // Validar registro m√≠nimo
                    if (registro['Data Transacao'] && registro['Valor total da transacao']) {
                        // Converter valores num√©ricos CORRETAMENTE
                        converterValoresNumericosFIXO(registro);
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado', 'error');
                    return;
                }
                
                console.log('Primeiros 3 registros processados:', dadosOriginais.slice(0, 3));
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                calcularTotaisIndividuais();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao('Erro ao processar arquivo Excel', 'error');
                console.error('Erro no Excel:', error);
            }
        }
        
        // Fun√ß√£o para normalizar nomes de campos
        function normalizarNomeCampo(nome) {
            return String(nome)
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Converter valores num√©ricos CORRETAMENTE - SEM REMOVER PONTOS
        function converterValoresNumericosFIXO(registro) {
            CAMPOS_NUMERICOS.forEach(campo => {
                if (registro[campo] !== undefined && registro[campo] !== null && registro[campo] !== '') {
                    let valorStr = String(registro[campo]).trim();
                    
                    // Se j√° for n√∫mero, usar direto
                    if (typeof registro[campo] === 'number') {
                        registro[`${campo}_NUM`] = registro[campo];
                        return;
                    }
                    
                    // Remover s√≠mbolos de moeda e espa√ßos
                    valorStr = valorStr.replace(/[R$\s]/g, '').trim();
                    
                    // Se estiver vazio ap√≥s remo√ß√£o, definir como 0
                    if (valorStr === '') {
                        registro[`${campo}_NUM`] = 0;
                        return;
                    }
                    
                    // Verificar formato
                    const temVirgula = valorStr.includes(',');
                    const temPonto = valorStr.includes('.');
                    
                    let valorNumerico;
                    
                    if (temVirgula && !temPonto) {
                        // Formato: "1234,56" - v√≠rgula decimal
                        valorStr = valorStr.replace(',', '.');
                        valorNumerico = parseFloat(valorStr);
                    } else if (!temVirgula && temPonto) {
                        // Formato: "1234.56" - ponto decimal (formato internacional)
                        // Contar pontos para verificar se √© separador de milhar
                        const partes = valorStr.split('.');
                        
                        if (partes.length === 2) {
                            // Apenas um ponto - √© decimal
                            valorNumerico = parseFloat(valorStr);
                        } else if (partes.length > 2) {
                            // M√∫ltiplos pontos - pode ser formato com separador de milhar (ex: 1.234.567,89)
                            // Mas no formato brasileiro, isso seria com v√≠rgula decimal
                            // Vamos tratar como n√∫mero sem pontos e depois verificar casas decimais
                            const semPontos = valorStr.replace(/\./g, '');
                            // Assumir 2 casas decimais se o √∫ltimo segmento tiver 2 d√≠gitos
                            const ultimoSegmento = partes[partes.length - 1];
                            if (ultimoSegmento.length === 2) {
                                // √â provavelmente formato com separador de milhar e 2 casas decimais
                                const numeroInteiro = semPontos.slice(0, -2);
                                const decimais = semPontos.slice(-2);
                                valorNumerico = parseFloat(numeroInteiro + '.' + decimais);
                            } else {
                                valorNumerico = parseFloat(semPontos);
                            }
                        } else {
                            valorNumerico = parseFloat(valorStr);
                        }
                    } else if (temVirgula && temPonto) {
                        // Formato: "1.234,56" - ponto √© separador de milhar, v√≠rgula √© decimal
                        valorStr = valorStr.replace(/\./g, '').replace(',', '.');
                        valorNumerico = parseFloat(valorStr);
                    } else {
                        // Nenhum separador - n√∫mero inteiro
                        valorNumerico = parseFloat(valorStr);
                    }
                    
                    if (!isNaN(valorNumerico)) {
                        registro[`${campo}_NUM`] = valorNumerico;
                        console.log(`Campo ${campo}: "${registro[campo]}" -> ${valorNumerico}`);
                    } else {
                        registro[`${campo}_NUM`] = 0;
                        console.warn(`N√£o foi poss√≠vel converter ${campo}: "${registro[campo]}"`);
                    }
                } else {
                    registro[`${campo}_NUM`] = 0;
                }
            });
        }
        
        // Processar CSV
        function processarCSV(content) {
            try {
                const linhas = content.split('\n');
                if (linhas.length < 2) {
                    mostrarNotificacao('CSV vazio ou inv√°lido', 'error');
                    return;
                }
                
                const separador = linhas[0].includes(';') ? ';' : ',';
                const cabecalhos = parseCSVLine(linhas[0], separador);
                
                // Mapear √≠ndices
                const indicesCampos = {};
                cabecalhos.forEach((cabecalho, index) => {
                    const nomeNormalizado = normalizarNomeCampo(cabecalho);
                    indicesCampos[nomeNormalizado] = index;
                });
                
                dadosOriginais = [];
                
                for (let i = 1; i < linhas.length; i++) {
                    if (linhas[i].trim() === '') continue;
                    
                    const valores = parseCSVLine(linhas[i], separador);
                    const registro = {};
                    
                    // Processar cada campo esperado
                    CAMPOS_ESPERADOS.forEach(campo => {
                        const nomeNormalizado = normalizarNomeCampo(campo);
                        const indice = indicesCampos[nomeNormalizado];
                        
                        let valor = '';
                        if (indice !== undefined && valores[indice] !== undefined) {
                            valor = valores[indice].trim();
                        }
                        
                        registro[campo] = valor;
                    });
                    
                    if (registro['Data Transacao'] && registro['Valor total da transacao']) {
                        converterValoresNumericosFIXO(registro);
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado', 'error');
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                calcularTotaisIndividuais();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao('Erro ao processar CSV', 'error');
                console.error('Erro no CSV:', error);
            }
        }
        
        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.replace(/^"+|"+$/g, ''));
        }
        
        // Mostrar pr√©via dos dados
        function mostrarPreviaDados() {
            if (dadosOriginais.length === 0) {
                dataPreview.style.display = 'none';
                return;
            }
            
            dataPreview.style.display = 'block';
            previewBody.innerHTML = '';
            
            const limite = Math.min(10, dadosOriginais.length);
            
            for (let i = 0; i < limite; i++) {
                const registro = dadosOriginais[i];
                const tr = document.createElement('tr');
                
                let statusClass = '';
                if (registro.Status === 'Aprovada') statusClass = 'status-aprovada';
                else if (registro.Status === 'Cancelada') statusClass = 'status-cancelada';
                else if (registro.Status === 'Pendente') statusClass = 'status-pendente';
                
                tr.innerHTML = `
                    <td class="${statusClass}">${registro.Status || 'N/A'}</td>
                    <td>${registro['Data Transacao'] || 'N/A'}</td>
                    <td class="currency">R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}</td>
                    <td class="currency">R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}</td>
                    <td>${registro['N√∫mero do Cartao'] || 'N/A'}</td>
                    <td>${formatarNumero(registro['Total Diarias_NUM'] || 0)}</td>
                `;
                
                previewBody.appendChild(tr);
            }
            
            atualizarEstatisticasPrevia();
        }
        
        // Calcular totais individuais para CADA CAMPO
        function calcularTotaisIndividuais() {
            if (dadosFiltrados.length === 0) {
                totaisPreview.style.display = 'none';
                return;
            }
            
            totaisPreview.style.display = 'block';
            
            // Calcular totais para cada campo num√©rico
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                const total = dadosFiltrados.reduce((soma, registro) => {
                    return soma + (registro[`${campo}_NUM`] || 0);
                }, 0);
                totais[campo] = total;
            });
            
            // Exibir totais
            let html = '';
            
            // Agrupar por categoria
            const grupos = {
                'Di√°rias': ['Total Diarias'],
                'Valores Principais': ['Valor total da transacao', 'Valor Liquido'],
                'Taxas e Impostos': ['Valor Taxas', 'Valor Impostos'],
                'Comiss√µes': ['Comissoes', 'Taxa de Servico B2B', 'Valor Adquirencia'],
                'Extras': ['Valor Extras']
            };
            
            for (const [grupo, campos] of Object.entries(grupos)) {
                html += `<div style="grid-column: 1 / -1; font-weight: bold; margin-top: 10px; color: #2c3e50;">${grupo}</div>`;
                
                campos.forEach(campo => {
                    if (totais[campo] !== undefined) {
                        const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                        const valorFormatado = isMoeda ? 
                            `R$ ${formatarMoeda(totais[campo])}` : 
                            formatarNumero(totais[campo]);
                        
                        html += `
                            <div class="total-item">
                                <div class="total-label">${campo}</div>
                                <div class="total-value">${valorFormatado}</div>
                            </div>
                        `;
                    }
                });
            }
            
            totaisGrid.innerHTML = html;
        }
        
        // Atualizar estat√≠sticas da pr√©via
        function atualizarEstatisticasPrevia() {
            const total = dadosOriginais.length;
            const aprovadas = dadosOriginais.filter(r => r.Status === 'Aprovada').length;
            const canceladas = dadosOriginais.filter(r => r.Status === 'Cancelada').length;
            const valorTotalSum = dadosOriginais.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorMedio = total > 0 ? valorTotalSum / total : 0;
            
            dataStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total de Transa√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${aprovadas}</div>
                    <div class="stat-label">Aprovadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${canceladas}</div>
                    <div class="stat-label">Canceladas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">R$ ${formatarMoeda(valorMedio)}</div>
                    <div class="stat-label">Valor M√©dio</div>
                </div>
            `;
        }
        
        // Fun√ß√µes de formata√ß√£o
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatarNumero(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Atualizar filtros de bandeira
        function atualizarFiltrosBandeira() {
            const bandeiras = new Set();
            dadosOriginais.forEach(r => {
                if (r['Bandeira do Cartao']) bandeiras.add(r['Bandeira do Cartao'].trim());
            });
            
            while (filterBandeira.options.length > 1) filterBandeira.remove(1);
            
            Array.from(bandeiras).sort().forEach(bandeira => {
                const option = document.createElement('option');
                option.value = bandeira;
                option.textContent = bandeira;
                filterBandeira.appendChild(option);
            });
        }
        
        // Limpar dados
        function limparDados() {
            dadosOriginais = [];
            dadosFiltrados = [];
            dataPreview.style.display = 'none';
            totaisPreview.style.display = 'none';
            atualizarResumo();
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('Carregue um arquivo primeiro', 'error');
                return;
            }
            
            dadosFiltrados = dadosOriginais.filter(registro => {
                if (filterStatus.value && registro.Status !== filterStatus.value) return false;
                
                if (filterBandeira.value && registro['Bandeira do Cartao'] !== filterBandeira.value) return false;
                
                const dataTransacao = parsearData(registro['Data Transacao']);
                if (filterDataInicio.value && dataTransacao) {
                    const dataInicio = new Date(filterDataInicio.value);
                    if (dataTransacao < dataInicio) return false;
                }
                
                if (filterDataFim.value && dataTransacao) {
                    const dataFim = new Date(filterDataFim.value);
                    dataFim.setHours(23, 59, 59, 999);
                    if (dataTransacao > dataFim) return false;
                }
                
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                if (filterValorMin.value && valorTotal < parseFloat(filterValorMin.value)) return false;
                if (filterValorMax.value && valorTotal > parseFloat(filterValorMax.value)) return false;
                
                return true;
            });
            
            atualizarResumo();
            calcularTotaisIndividuais();
            mostrarNotificacao(`${dadosFiltrados.length} transa√ß√µes encontradas`, 'success');
        }
        
        // Parsear data
        function parsearData(dataString) {
            if (!dataString) return null;
            try {
                if (dataString.includes('/')) {
                    const [datePart, timePart] = dataString.split(' ');
                    const [day, month, year] = datePart.split('/');
                    if (timePart) {
                        const [hours, minutes, seconds] = timePart.split(':');
                        return new Date(year, month - 1, day, hours || 0, minutes || 0, seconds || 0);
                    }
                    return new Date(year, month - 1, day);
                } else if (dataString.includes('-')) {
                    return new Date(dataString);
                }
                return null;
            } catch (error) {
                console.error('Erro ao parsear data:', error);
                return null;
            }
        }
        
        // Limpar filtros
        function limparFiltros() {
            filterStatus.value = '';
            filterDataInicio.value = '2025-11-01';
            filterDataFim.value = '2025-11-30';
            filterValorMin.value = '';
            filterValorMax.value = '';
            filterBandeira.value = '';
            
            dadosFiltrados = [...dadosOriginais];
            atualizarResumo();
            calcularTotaisIndividuais();
            mostrarNotificacao('Filtros limpos', 'success');
        }
        
        // Atualizar resumo
        function atualizarResumo() {
            if (dadosFiltrados.length === 0) {
                totalTransacoes.textContent = '0';
                valorTotal.textContent = 'R$ 0,00';
                valorLiquido.textContent = 'R$ 0,00';
                diariasTotal.textContent = '0';
                return;
            }
            
            const total = dadosFiltrados.length;
            const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            const diariasSum = dadosFiltrados.reduce((sum, r) => sum + (r['Total Diarias_NUM'] || 0), 0);
            
            totalTransacoes.textContent = total.toLocaleString('pt-BR');
            valorTotal.textContent = `R$ ${formatarMoeda(valorTotalSum)}`;
            valorLiquido.textContent = `R$ ${formatarMoeda(valorLiquidoSum)}`;
            diariasTotal.textContent = formatarNumero(diariasSum);
        }
        
        // Exportar para Excel
        function exportarParaExcel() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para exportar', 'error');
                return;
            }
            
            const colunasExport = CAMPOS_ESPERADOS;
            const cabecalhos = colunasExport.join(';');
            const linhas = dadosFiltrados.map(registro => {
                return colunasExport.map(coluna => {
                    let valor = registro[coluna] || '';
                    if (valor.includes(';')) valor = `"${valor}"`;
                    return valor;
                }).join(';');
            });
            
            const conteudoCSV = [cabecalhos, ...linhas].join('\n');
            const blob = new Blob(['\uFEFF' + conteudoCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_b2b_${dayjs().format('YYYY-MM-DD')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('CSV exportado com sucesso!', 'success');
        }
        
        // Selecionar tipo de relat√≥rio
        function selecionarTipoRelatorio(tipo) {
            tipoRelatorioAtual = tipo;
            
            [btnFilipeta, btnRelatorioDetalhado, btnResumoAprovadas, btnFilipetaImpressora].forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tipo === 'filipeta') btnFilipeta.classList.add('active');
            if (tipo === 'detalhado') btnRelatorioDetalhado.classList.add('active');
            if (tipo === 'aprovadas') btnResumoAprovadas.classList.add('active');
            if (tipo === 'filipetaImpressora') btnFilipetaImpressora.classList.add('active');
            
            const btnTexto = {
                'filipeta': 'GERAR FILIPETA POS',
                'detalhado': 'GERAR RELAT√ìRIO DETALHADO',
                'aprovadas': 'GERAR RESUMO APROVADAS',
                'filipetaImpressora': 'üñ®Ô∏è GERAR FILIPETA IMPRESSORA'
            };
            
            btnGerarPDF.innerHTML = `üìä ${btnTexto[tipo]}`;
        }
        
        // Abrir modal PDF
        function abrirModalPDF() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('Carregue um arquivo primeiro', 'error');
                return;
            }
            // Configurar data atual se n√£o estiver definida
            if (!pdfDataRelatorio.value) {
                const hoje = new Date().toISOString().split('T')[0];
                pdfDataRelatorio.value = hoje;
            }
            pdfModal.style.display = 'block';
        }
        
        // Fechar modal PDF
        function fecharModalPDF() {
            pdfModal.style.display = 'none';
        }
        
        // Gerar PDF principal
        function gerarPDF() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para gerar relat√≥rio', 'error');
                return;
            }
            
            fecharModalPDF();
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    switch(tipoRelatorioAtual) {
                        case 'filipeta': gerarPDFFilipeta(); break;
                        case 'detalhado': gerarPDFDetalhado(); break;
                        case 'aprovadas': gerarPDFResumoAprovadas(); break;
                        case 'filipetaImpressora': gerarPDFFilipetaImpressora(); break;
                        default: gerarPDFFilipeta();
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Obter data do relat√≥rio formatada
        function obterDataRelatorio() {
            const dataRelatorio = pdfDataRelatorio.value;
            if (dataRelatorio) {
                return dayjs(dataRelatorio).format('DD/MM/YYYY');
            }
            return dayjs().format('DD/MM/YYYY');
        }
        
        // Gerar PDF Filipeta POS
        function gerarPDFFilipeta() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            const doc = new jsPDF({
                orientation: pdfOrientation.value,
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üè¶ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('FILIPETA DE VENDAS POS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.text(`Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 15, yPos - 10, { align: 'right' });
            yPos += 10;
            
            // Calcular totais individuais
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = dadosFiltrados.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Adicionar resumo de totais se configurado
            if (pdfIncludeSummary.value === 'true') {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAIS POR CATEGORIA:', 15, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                // Mostrar alguns totais principais
                const principaisTotais = [
                    ['Valor Total', totais['Valor total da transacao']],
                    ['Valor L√≠quido', totais['Valor Liquido']],
                    ['Di√°rias Totais', totais['Total Diarias']],
                    ['Comiss√µes', totais['Comissoes']],
                    ['Taxa B2B', totais['Taxa de Servico B2B']],
                    ['Adquirente', totais['Valor Adquirencia']]
                ];
                
                principaisTotais.forEach(([label, valor]) => {
                    const isMoeda = label.includes('Valor') || label.includes('Comiss') || label.includes('Taxa') || label.includes('Adquirente');
                    const valorFormatado = isMoeda ? 
                        `R$ ${formatarMoeda(valor)}` : 
                        formatarNumero(valor);
                    
                    doc.text(`‚Ä¢ ${label}: ${valorFormatado}`, 20, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // Tabela principal
            const headers = ['#', 'Data/Hora', 'Status', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = dadosFiltrados.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    registro.Status || '',
                    `R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`,
                    `R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255, fontSize: 9, fontStyle: 'bold' },
                bodyStyles: { fontSize: 8, cellPadding: 2 },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            const fileName = `filipeta_pos_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Filipeta gerada: ${fileName}`, 'success');
        }
        
        // Gerar PDF Detalhado com TODOS os totais individuais
        function gerarPDFDetalhado() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üè¶ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DETALHADO COMPLETO', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.text(`Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 12;
            
            // Calcular TODOS os totais individuais
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = dadosFiltrados.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Tabela com todos os campos
            const headers = CAMPOS_ESPERADOS;
            const data = dadosFiltrados.map((registro, index) => {
                return headers.map(campo => {
                    let valor = registro[campo] || '';
                    
                    // Formatar valores num√©ricos
                    if (CAMPOS_NUMERICOS.includes(campo)) {
                        const valorNum = registro[`${campo}_NUM`];
                        if (valorNum !== undefined) {
                            const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                            valor = isMoeda ? 
                                `R$ ${formatarMoeda(valorNum)}` : 
                                formatarNumero(valorNum);
                        }
                    }
                    
                    return valor;
                });
            });
            
            // Adicionar linha de TOTAIS no final
            const linhaTotais = headers.map(campo => {
                if (CAMPOS_NUMERICOS.includes(campo)) {
                    const total = totais[campo];
                    const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                    return isMoeda ? 
                        `R$ ${formatarMoeda(total)}` : 
                        formatarNumero(total);
                } else if (campo === 'Status') {
                    return 'TOTAIS';
                } else {
                    return '';
                }
            });
            
            data.push(linhaTotais);
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontSize: 8, fontStyle: 'bold' },
                bodyStyles: { fontSize: 7, cellPadding: 2 },
                margin: { left: 10, right: 10 },
                // Estilo especial para a √∫ltima linha (totais)
                didParseCell: function(data) {
                    if (data.row.index === data.table.body.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [241, 196, 15]; // Amarelo para totais
                        data.cell.styles.textColor = [0, 0, 0];
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                    doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 10, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            });
            
            const fileName = `relatorio_detalhado_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Relat√≥rio detalhado gerado: ${fileName}`, 'success');
        }
        
        // Gerar PDF Resumo Aprovadas
        function gerarPDFResumoAprovadas() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('‚úÖ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DE TRANSA√á√ïES APROVADAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.text(`Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;
            
            // Calcular totais das aprovadas
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = transacoesAprovadas.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Adicionar resumo de totais
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAIS DAS APROVADAS:', 15, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Listar totais principais
            const principaisCampos = [
                'Valor total da transacao',
                'Valor Liquido',
                'Total Diarias',
                'Comissoes',
                'Taxa de Servico B2B',
                'Valor Adquirencia',
                'Valor Impostos',
                'Valor Taxas',
                'Valor Extras'
            ];
            
            let xPos = 15;
            let colCount = 0;
            
            principaisCampos.forEach(campo => {
                const total = totais[campo] || 0;
                const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                const valorFormatado = isMoeda ? 
                    `R$ ${formatarMoeda(total)}` : 
                    formatarNumero(total);
                
                const label = campo.length > 20 ? campo.substring(0, 20) + '...' : campo;
                
                doc.text(`‚Ä¢ ${label}:`, xPos, yPos);
                doc.text(valorFormatado, xPos + 45, yPos);
                
                colCount++;
                if (colCount % 5 === 0) {
                    xPos += 60;
                    yPos = 30;
                } else {
                    yPos += 5;
                }
            });
            
            yPos += 10;
            
            // Tabela simplificada
            const headers = ['#', 'Data', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = transacoesAprovadas.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    `R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`,
                    `R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            // Adicionar linha de totais
            const totalValor = totais['Valor total da transacao'];
            const totalLiquido = totais['Valor Liquido'];
            data.push([
                'TOTAIS',
                '',
                `R$ ${formatarMoeda(totalValor)}`,
                `R$ ${formatarMoeda(totalLiquido)}`,
                '',
                ''
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [46, 204, 113], textColor: 255, fontSize: 9 },
                bodyStyles: { fontSize: 8 },
                margin: { left: 15, right: 15 },
                didParseCell: function(data) {
                    if (data.row.index === data.table.body.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [241, 196, 15];
                        data.cell.styles.textColor = [0, 0, 0];
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                    doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 10, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            });
            
            const fileName = `aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Resumo de aprovadas gerado: ${fileName}`, 'success');
        }
        
        // NOVA FUN√á√ÉO: Gerar PDF para Impressora de Filipeta
        function gerarPDFFilipetaImpressora() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            // Formato longo para m√°quina de filipeta (80mm de largura, comprimento vari√°vel)
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 297] // Largura fixa 80mm, altura A4 (pode ser maior)
            });
            
            const pageWidth = 80;
            let yPos = 10;
            const margin = 5;
            const contentWidth = pageWidth - 2 * margin;
            
            // Configurar fonte menor para caber mais conte√∫do
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            
            // Cabe√ßalho do relat√≥rio
            doc.text('B2B RESERVAS - RELAT√ìRIO FILIPETA', pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.text(`Data do Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 4;
            
            doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Linha divis√≥ria
            doc.setDrawColor(0, 0, 0);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 5;
            
            // Resumo r√°pido
            const totalTransacoes = dadosFiltrados.length;
            const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO R√ÅPIDO:', margin, yPos);
            yPos += 4;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Transa√ß√µes: ${totalTransacoes}`, margin, yPos);
            doc.text(`Valor Total: R$ ${formatarMoeda(valorTotalSum)}`, margin + 35, yPos);
            yPos += 4;
            
            doc.text(`Valor L√≠quido: R$ ${formatarMoeda(valorLiquidoSum)}`, margin, yPos);
            yPos += 6;
            
            // Linha divis√≥ria
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // Listar todas as transa√ß√µes (formato compacto)
            doc.setFont('helvetica', 'bold');
            doc.text('DETALHES DAS TRANSA√á√ïES:', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            
            dadosFiltrados.forEach((registro, index) => {
                // Verificar se precisa de nova p√°gina
                if (yPos > 280) {
                    doc.addPage([80, 297]);
                    yPos = 10;
                }
                
                // N√∫mero da transa√ß√£o
                doc.setFont('helvetica', 'bold');
                doc.text(`#${index + 1}:`, margin, yPos);
                
                // Status com cor
                const status = registro.Status || '';
                let statusColor = [0, 0, 0];
                if (status === 'Aprovada') statusColor = [46, 204, 113];
                else if (status === 'Cancelada') statusColor = [231, 76, 60];
                else if (status === 'Pendente') statusColor = [241, 196, 15];
                
                doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                doc.text(status, margin + 10, yPos);
                doc.setTextColor(0, 0, 0);
                
                yPos += 4;
                
                // Data e valores
                doc.setFont('helvetica', 'normal');
                doc.text(`Data: ${registro['Data Transacao'] || 'N/A'}`, margin, yPos);
                doc.text(`Total: R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`, margin + 35, yPos);
                yPos += 3.5;
                
                doc.text(`L√≠quido: R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`, margin, yPos);
                doc.text(`Cart√£o: ${registro['N√∫mero do Cartao'] ? registro['N√∫mero do Cartao'].substring(0, 8) + '...' : 'N/A'}`, margin + 35, yPos);
                yPos += 3.5;
                
                // Detalhes financeiros compactos
                doc.setFontSize(6);
                const detalhes = [
                    `Di√°rias: ${formatarNumero(registro['Total Diarias_NUM'] || 0)}`,
                    `Comiss√µes: R$ ${formatarMoeda(registro['Comissoes_NUM'] || 0)}`,
                    `B2B: R$ ${formatarMoeda(registro['Taxa de Servico B2B_NUM'] || 0)}`,
                    `Adquirente: R$ ${formatarMoeda(registro['Valor Adquirencia_NUM'] || 0)}`
                ];
                
                detalhes.forEach(detalhe => {
                    doc.text(detalhe, margin, yPos);
                    yPos += 2.5;
                });
                
                doc.setFontSize(7);
                
                // Linha divis√≥ria entre transa√ß√µes
                if (index < dadosFiltrados.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 5;
                } else {
                    yPos += 3;
                }
            });
            
            // Linha final
            doc.setDrawColor(0, 0, 0);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 5;
            
            // Totais finais
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TOTAIS FINAIS:', margin, yPos);
            yPos += 4;
            
            doc.setFont('helvetica', 'normal');
            
            // Calcular totais para todos os campos num√©ricos
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = dadosFiltrados.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Mostrar totais principais
            const totaisPrincipais = [
                ['Valor Total Transa√ß√µes', totais['Valor total da transacao']],
                ['Valor L√≠quido Total', totais['Valor Liquido']],
                ['Di√°rias Totais', totais['Total Diarias']],
                ['Total Comiss√µes', totais['Comissoes']],
                ['Total Taxa B2B', totais['Taxa de Servico B2B']],
                ['Total Adquirente', totais['Valor Adquirencia']]
            ];
            
            totaisPrincipais.forEach(([label, valor]) => {
                const isMoeda = label.includes('Valor') || label.includes('Comiss') || label.includes('Taxa') || label.includes('Adquirente');
                const valorFormatado = isMoeda ? 
                    `R$ ${formatarMoeda(valor)}` : 
                    formatarNumero(valor);
                
                doc.text(`${label}: ${valorFormatado}`, margin, yPos);
                yPos += 3.5;
            });
            
            // Rodap√©
            yPos = 290;
            doc.setFontSize(6);
            doc.setFont('helvetica', 'italic');
            doc.text('Sistema B2B Reservas - Relat√≥rio de Filipeta', pageWidth / 2, yPos, { align: 'center' });
            yPos += 3;
            doc.text(`Total de ${dadosFiltrados.length} transa√ß√µes listadas`, pageWidth / 2, yPos, { align: 'center' });
            
            const fileName = `filipeta_impressora_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Filipeta para impressora gerada: ${fileName}`, 'success');
        }
        
        // Gerar filipetas individuais
        function gerarTodasFilipetas() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para gerar filipetas', 'error');
                return;
            }
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 150]
                    });
                    
                    dadosFiltrados.forEach((registro, index) => {
                        if (index > 0) doc.addPage([80, 150]);
                        
                        doc.setFont('helvetica');
                        doc.setFontSize(12);
                        doc.text('B2B RESERVAS', 40, 10, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.text('COMPROVANTE DE VENDA', 40, 15, { align: 'center' });
                        
                        let yPos = 25;
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Transa√ß√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Data Transacao'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Status:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro.Status || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor Total:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor L√≠quido:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Cart√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['N√∫mero do Cartao'] || '', 25, yPos);
                        yPos += 7;
                        
                        // Detalhes financeiros
                        doc.setFontSize(7);
                        doc.text('Detalhes Financeiros:', 5, yPos);
                        yPos += 4;
                        
                        doc.text(`‚Ä¢ Di√°rias: ${formatarNumero(registro['Total Diarias_NUM'] || 0)}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Comiss√µes: R$ ${formatarMoeda(registro['Comissoes_NUM'] || 0)}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Taxa B2B: R$ ${formatarMoeda(registro['Taxa de Servico B2B_NUM'] || 0)}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Adquirente: R$ ${formatarMoeda(registro['Valor Adquirencia_NUM'] || 0)}`, 10, yPos);
                        yPos += 5;
                        
                        // Rodap√©
                        doc.setFontSize(6);
                        doc.text('Sistema B2B Reservas - Comprovante n√£o fiscal', 40, 140, { align: 'center' });
                        doc.text(dayjs().format('DD/MM/YYYY HH:mm:ss'), 40, 143, { align: 'center' });
                        doc.text(`Transa√ß√£o ${index + 1} de ${dadosFiltrados.length}`, 40, 146, { align: 'center' });
                    });
                    
                    const fileName = `filipetas_${dayjs().format('YYYY-MM-DD')}.pdf`;
                    doc.save(fileName);
                    mostrarNotificacao(`${dadosFiltrados.length} filipetas geradas!`, 'success');
                    
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Fun√ß√µes utilit√°rias
        function mostrarLoading(mostrar) {
            loadingOverlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) notifAnterior.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${tipo}`;
            notification.innerHTML = `<strong>${tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong> ${mensagem}`;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
    </script>
</body>
</html>
