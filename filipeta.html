<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Reservas - Sistema de Relat√≥rios PDF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a6fa5;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .app-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload {
            border: 2px dashed #3498db;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background-color: white;
        }

        .file-upload:hover {
            background-color: #e8f4fc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .file-upload input {
            display: none;
        }

        .upload-label {
            font-size: 1.4rem;
            color: #3498db;
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .file-info {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 1.2rem;
            padding: 16px 32px;
        }

        .btn-pdf:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }

        .btn-print {
            background: linear-gradient(135deg, #f39c12, #d35400);
            color: white;
        }

        .btn-print:hover {
            background: linear-gradient(135deg, #d35400, #a35200);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            color: white;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card:nth-child(2) {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .summary-card:nth-child(3) {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .summary-card:nth-child(4) {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .summary-card:nth-child(5) {
            background: linear-gradient(135deg, #1abc9c, #16a085);
        }

        .summary-card:nth-child(6) {
            background: linear-gradient(135deg, #f39c12, #d35400);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .data-preview {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-preview th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-preview td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .data-preview tr:hover {
            background-color: #f8f9fa;
        }

        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .status-aprovada {
            color: #27ae60;
            font-weight: bold;
        }

        .status-cancelada {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-pendente {
            color: #f39c12;
            font-weight: bold;
        }

        .status-recebido {
            color: #3498db;
            font-weight: bold;
        }

        .status-a-receber {
            color: #9b59b6;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .pdf-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .pdf-option-group {
            margin-bottom: 25px;
        }

        .pdf-option-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
        }

        .notification-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .report-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-type-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .report-type-btn.active {
            border-color: #3498db;
            background-color: #e8f4fc;
            color: #3498db;
            font-weight: bold;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .totais-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .totais-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .total-item {
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .total-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .total-value {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .ordenacao-indicador {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #e8f4fc;
            border-radius: 4px;
            font-size: 0.9rem;
            border-left: 4px solid #3498db;
        }

        .filter-group select#filterOrdenar {
            background-color: #f8f9fa;
            border: 2px solid #3498db;
            font-weight: 600;
        }

        .filter-group select#filterOrdenar option {
            font-weight: normal;
        }

        .recebimento-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #1abc9c;
        }

        .recebimento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .recebimento-header h3 {
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .recebimento-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .recebimento-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .recebimento-stat.recebido {
            border-left: 4px solid #1abc9c;
        }

        .recebimento-stat.a-receber {
            border-left: 4px solid #9b59b6;
        }

        .recebimento-stat.vencido {
            border-left: 4px solid #e74c3c;
        }

        .recebimento-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .recebimento-stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .cartoes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .cartao-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .cartao-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .cartao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .cartao-numero {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .cartao-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .cartao-status.recebido {
            background-color: #d4edda;
            color: #155724;
        }

        .cartao-status.a-receber {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .cartao-status.vencido {
            background-color: #f8d7da;
            color: #721c24;
        }

        .cartao-detalhes {
            margin-top: 10px;
        }

        .cartao-detalhe {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .cartao-detalhe-label {
            color: #7f8c8d;
        }

        .cartao-detalhe-value {
            color: #2c3e50;
            font-weight: 600;
        }

        /* Estilos espec√≠ficos para impress√£o */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-recebimentos,
            .print-recebimentos * {
                visibility: visible;
            }
            
            .print-recebimentos {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            
            .print-table th,
            .print-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            
            .print-table th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            
            .print-totals {
                margin: 20px 0;
                padding: 15px;
                background-color: #f9f9f9;
                border: 1px solid #ddd;
            }
            
            .print-card {
                border: 1px solid #ddd;
                padding: 10px;
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
        }

        .print-only {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .pdf-options-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .report-type-selector {
                flex-direction: column;
            }
            
            .report-type-btn {
                min-width: 100%;
            }
            
            .cartoes-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/locale/pt-br.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¶ SISTEMA DE RELAT√ìRIOS B2B RESERVAS</h1>
            <p class="subtitle">Gere filipetas de vendas POS e relat√≥rios detalhados</p>
        </header>

        <section class="app-section">
            <h2>üìÅ 1. CARREGAR ARQUIVO</h2>
            <div class="file-upload" id="dropArea">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                <label for="fileInput" class="upload-label">
                    üìÇ CLIQUE PARA SELECIONAR OU ARRASTE SEU ARQUIVO
                </label>
                <p class="file-info">Formatos suportados: CSV, Excel (XLSX, XLS)</p>
                <p id="fileName" class="file-info">‚ö†Ô∏è Nenhum arquivo selecionado</p>
            </div>
            
            <div id="dataPreview" class="data-preview">
                <h3>üìã Pr√©-visualiza√ß√£o dos Dados</h3>
                <div id="indicadorOrdenacao" class="ordenacao-indicador">Ordem original do arquivo</div>
                <table id="previewTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Data Transacao</th>
                            <th>Data Recebimento</th>
                            <th>Valor Total</th>
                            <th>Valor L√≠quido</th>
                            <th>Cart√£o</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
                <div id="dataStats" class="data-stats"></div>
                <div id="totaisPreview" class="totais-container" style="display: none;">
                    <h4>üìä Totais por Campo</h4>
                    <div id="totaisGrid" class="totais-grid"></div>
                </div>
            </div>
        </section>

        <section class="app-section">
            <h2>üîç 2. FILTRAR DADOS</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterStatus">üìä Status</label>
                    <select id="filterStatus">
                        <option value="">Todos os Status</option>
                        <option value="Aprovada">‚úÖ Aprovada</option>
                        <option value="Cancelada">‚ùå Cancelada</option>
                        <option value="Pendente">‚è≥ Pendente</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterDataInicio">üìÖ Data Transa√ß√£o (De)</label>
                    <input type="date" id="filterDataInicio">
                </div>

                <div class="filter-group">
                    <label for="filterDataFim">üìÖ Data Transa√ß√£o (At√©)</label>
                    <input type="date" id="filterDataFim">
                </div>

                <div class="filter-group">
                    <label for="filterValorMin">üí∞ Valor M√≠nimo (R$)</label>
                    <input type="number" id="filterValorMin" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterValorMax">üí∞ Valor M√°ximo (R$)</label>
                    <input type="number" id="filterValorMax" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterBandeira">üí≥ Bandeira do Cart√£o</label>
                    <select id="filterBandeira">
                        <option value="">Todas as Bandeiras</option>
                        <option value="VISA">VISA</option>
                        <option value="MASTERCARD">MASTERCARD</option>
                        <option value="ELO">ELO</option>
                        <option value="AMEX">AMERICAN EXPRESS</option>
                    </select>
                </div>

                <!-- NOVO: Controle de Ordena√ß√£o -->
                <div class="filter-group">
                    <label for="filterOrdenar">üìà Ordenar por Data</label>
                    <select id="filterOrdenar">
                        <option value="padrao">Padr√£o (como no arquivo)</option>
                        <option value="antiga_recente">Mais Antiga ‚Üí Mais Recente</option>
                        <option value="recente_antiga">Mais Recente ‚Üí Mais Antiga</option>
                    </select>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-primary" id="btnFiltrar">üîç APLICAR FILTROS</button>
                <button class="btn-secondary" id="btnLimparFiltros">üóëÔ∏è LIMPAR FILTROS</button>
                <button class="btn-danger" id="btnExportarExcel">üíæ EXPORTAR CSV</button>
            </div>
        </section>

        <section class="app-section">
            <h2>üìä 3. RESUMO DO RELAT√ìRIO (APENAS APROVADAS)</h2>
            <div class="summary-grid" id="resumo">
                <div class="summary-card">
                    <div class="summary-value" id="totalTransacoes">0</div>
                    <div class="summary-label">Transa√ß√µes Aprovadas</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorTotal">R$ 0,00</div>
                    <div class="summary-label">Valor Total</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorLiquido">R$ 0,00</div>
                    <div class="summary-label">Valor L√≠quido</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="diariasTotal">0</div>
                    <div class="summary-label">Di√°rias Totais</div>
                </div>
                <!-- NOVOS CART√ïES PARA RECEBIMENTOS -->
                <div class="summary-card">
                    <div class="summary-value" id="totalRecebido">R$ 0,00</div>
                    <div class="summary-label">J√° Recebido</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="totalAReceber">R$ 0,00</div>
                    <div class="summary-label">A Receber</div>
                </div>
            </div>
        </section>

        <!-- NOVA SE√á√ÉO: AN√ÅLISE DE RECEBIMENTOS -->
        <section class="app-section">
            <h2>üí∞ 4. AN√ÅLISE DE RECEBIMENTOS (APENAS APROVADAS)</h2>
            <div id="recebimentosContainer" class="recebimento-card" style="display: none;">
                <div class="recebimento-header">
                    <h3>üìÖ Status dos Recebimentos</h3>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">
                        Data de refer√™ncia: <span id="dataReferencia"></span>
                    </div>
                </div>
                
                <div class="recebimento-stats">
                    <div class="recebimento-stat recebido">
                        <div class="recebimento-stat-value" id="statsRecebido">R$ 0,00</div>
                        <div class="recebimento-stat-label">J√° Recebido</div>
                    </div>
                    <div class="recebimento-stat a-receber">
                        <div class="recebimento-stat-value" id="statsAReceber">R$ 0,00</div>
                        <div class="recebimento-stat-label">A Receber</div>
                    </div>
                    <div class="recebimento-stat vencido">
                        <div class="recebimento-stat-value" id="statsVencido">R$ 0,00</div>
                        <div class="recebimento-stat-label">Vencido</div>
                    </div>
                </div>
                
                <div class="recebimento-header">
                    <h3>üí≥ Cart√µes com Recebimentos</h3>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">
                        <span id="totalCartoes">0</span> cart√£o(s)
                    </div>
                </div>
                
                <div id="cartoesContainer" class="cartoes-container">
                    <!-- Cart√µes ser√£o inseridos aqui dinamicamente -->
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px;">
                    <h4>üìã Detalhamento por Cart√£o</h4>
                    <div id="detalhamentoCartoes" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th style="padding: 8px; background-color: #2c3e50; color: white;">Cart√£o</th>
                                    <th style="padding: 8px; background-color: #2c3e50; color: white;">Status Recebimento</th>
                                    <th style="padding: 8px; background-color: #2c3e50; color: white; text-align: right;">Valor Total</th>
                                    <th style="padding: 8px; background-color: #2c3e50; color: white;">Data Recebimento</th>
                                    <th style="padding: 8px; background-color: #2c3e50; color: white;">Dias</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDetalhamento">
                                <!-- Linhas ser√£o inseridas aqui dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- NOVO: Bot√£o de impress√£o -->
                <div class="buttons" style="margin-top: 25px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <button class="btn-print" id="btnImprimirRecebimentos">
                        üñ®Ô∏è IMPRIMIR RELAT√ìRIO DE RECEBIMENTOS
                    </button>
                </div>
            </div>
            
            <div id="semRecebimentos" style="display: none; padding: 20px; text-align: center; color: #7f8c8d; background-color: #f8f9fa; border-radius: 8px;">
                <p style="font-size: 1.1rem;">üì≠ Nenhum dado de recebimento dispon√≠vel para an√°lise.</p>
                <p style="font-size: 0.9rem;">Verifique se o arquivo cont√©m a coluna "Data Recebimento".</p>
            </div>
        </section>

        <section class="app-section">
            <h2>üìÑ 5. GERAR RELAT√ìRIOS</h2>
            
            <div class="report-type-selector">
                <div class="report-type-btn active" id="btnFilipeta">üè∑Ô∏è FILIPETA POS</div>
                <div class="report-type-btn" id="btnRelatorioDetalhado">üìä RELAT√ìRIO DETALHADO</div>
                <div class="report-type-btn" id="btnResumoAprovadas">‚úÖ RESUMO APROVADAS</div>
                <div class="report-type-btn" id="btnFilipetaImpressora">üñ®Ô∏è FILIPETA IMPRESSORA</div>
                <div class="report-type-btn" id="btnRelatorioRecebimentos">üí∞ RELAT√ìRIO RECEBIMENTOS</div>
            </div>
            
            <p style="margin-bottom: 20px; font-size: 1.1rem; color: #2c3e50;">
                <strong>üéØ Filipeta POS:</strong> Relat√≥rio simplificado para confer√™ncia di√°ria.<br>
                <strong>üìä Relat√≥rio Detalhado:</strong> Todos os campos em formato paisagem.<br>
                <strong>‚úÖ Resumo Aprovadas:</strong> Todas transa√ß√µes aprovadas para impress√£o.<br>
                <strong>üñ®Ô∏è Filipeta Impressora:</strong> Formato longo para m√°quina de filipeta.<br>
                <strong>üí∞ Relat√≥rio Recebimentos:</strong> An√°lise detalhada de recebimentos por cart√£o.
            </p>
            
            <div class="buttons">
                <button class="btn-pdf" id="btnGerarPDF">üìä GERAR RELAT√ìRIO</button>
                <button class="btn-primary" id="btnConfigPDF">‚öôÔ∏è CONFIGURA√á√ïES</button>
                <button class="btn-secondary" id="btnGerarTodasFilipetas">üñ®Ô∏è FILIPETAS INDIVIDUAIS</button>
            </div>
        </section>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è CONFIGURA√á√ïES DO RELAT√ìRIO</h2>
                <span class="close-modal" id="closeModal">√ó</span>
            </div>
            
            <div class="pdf-options-grid">
                <div class="pdf-option-group">
                    <label for="pdfTitle">üìù T√≠tulo do Relat√≥rio:</label>
                    <input type="text" id="pdfTitle" value="RELAT√ìRIO DE VENDAS B2B RESERVAS">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfSubtitle">üìù Subt√≠tulo:</label>
                    <input type="text" id="pdfSubtitle" value="Filipeta POS - Transa√ß√µes Detalhadas">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfDataRelatorio">üìÖ Data do Relat√≥rio:</label>
                    <input type="date" id="pdfDataRelatorio" value="">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfFontSize">üî§ Tamanho da Fonte:</label>
                    <select id="pdfFontSize">
                        <option value="8">Pequeno (8pt)</option>
                        <option value="9" selected>Normal (9pt)</option>
                        <option value="10">Grande (10pt)</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfIncludeSummary">üìä Incluir Resumo:</label>
                    <select id="pdfIncludeSummary">
                        <option value="true" selected>‚úÖ Sim</option>
                        <option value="false">‚ùå N√£o</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfOrientation">üìê Orienta√ß√£o:</label>
                    <select id="pdfOrientation">
                        <option value="portrait">üìÑ Retrato</option>
                        <option value="landscape" selected>üèûÔ∏è Paisagem</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons" style="margin-top: 30px; border: none;">
                <button class="btn-pdf" id="btnGerarPDFConfirmar">üìä GERAR PDF</button>
                <button class="btn-secondary" id="btnCancelarPDF">‚Ü©Ô∏è CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; font-size: 1.2rem;">Processando dados...</p>
    </div>

    <script>
        // Configura√ß√µes
        dayjs.locale('pt-br');
        window.jsPDF = window.jspdf.jsPDF;
        
        // Campos esperados EXATAMENTE como na planilha
        const CAMPOS_ESPERADOS = [
            'Status',
            'Data Transacao',
            'Data Recebimento',
            'Total Diarias',
            'Valor Extras',
            'Valor Taxas',
            'Valor Impostos',
            'Valor total da transacao',
            'Tarifa',
            'Comissoes',
            'Taxa de Servico B2B',
            'Valor Adquirencia',
            'Valor Liquido',
            'N√∫mero do Cartao',
            'Bandeira do Cartao'
        ];
        
        // Campos que s√£o num√©ricos - CADA UM COM SEU PR√ìPRIO TOTAL
        const CAMPOS_NUMERICOS = [
            'Total Diarias',
            'Valor Extras',
            'Valor Taxas',
            'Valor Impostos',
            'Valor total da transacao',
            'Comissoes',
            'Taxa de Servico B2B',
            'Valor Adquirencia',
            'Valor Liquido'
        ];
        
        // Vari√°veis globais
        let dadosOriginais = [];
        let dadosFiltrados = [];
        let tipoRelatorioAtual = 'filipeta';
        let ordenarPor = 'padrao'; // NOVO: Vari√°vel para controle de ordena√ß√£o
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const fileName = document.getElementById('fileName');
        const dataPreview = document.getElementById('dataPreview');
        const previewBody = document.getElementById('previewBody');
        const dataStats = document.getElementById('dataStats');
        const totaisPreview = document.getElementById('totaisPreview');
        const totaisGrid = document.getElementById('totaisGrid');
        const pdfModal = document.getElementById('pdfModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Filtros
        const filterStatus = document.getElementById('filterStatus');
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        const filterValorMin = document.getElementById('filterValorMin');
        const filterValorMax = document.getElementById('filterValorMax');
        const filterBandeira = document.getElementById('filterBandeira');
        const filterOrdenar = document.getElementById('filterOrdenar'); // NOVO: Elemento de ordena√ß√£o
        
        // Bot√µes
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnLimparFiltros = document.getElementById('btnLimparFiltros');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnGerarPDF = document.getElementById('btnGerarPDF');
        const btnConfigPDF = document.getElementById('btnConfigPDF');
        const btnGerarTodasFilipetas = document.getElementById('btnGerarTodasFilipetas');
        const btnGerarPDFConfirmar = document.getElementById('btnGerarPDFConfirmar');
        const btnCancelarPDF = document.getElementById('btnCancelarPDF');
        const closeModal = document.getElementById('closeModal');
        const btnImprimirRecebimentos = document.getElementById('btnImprimirRecebimentos'); // NOVO: Bot√£o de impress√£o
        
        // Configura√ß√µes PDF
        const pdfTitle = document.getElementById('pdfTitle');
        const pdfSubtitle = document.getElementById('pdfSubtitle');
        const pdfDataRelatorio = document.getElementById('pdfDataRelatorio');
        const pdfFontSize = document.getElementById('pdfFontSize');
        const pdfIncludeSummary = document.getElementById('pdfIncludeSummary');
        const pdfOrientation = document.getElementById('pdfOrientation');
        
        // Resumo
        const totalTransacoes = document.getElementById('totalTransacoes');
        const valorTotal = document.getElementById('valorTotal');
        const valorLiquido = document.getElementById('valorLiquido');
        const diariasTotal = document.getElementById('diariasTotal');
        const totalRecebido = document.getElementById('totalRecebido');
        const totalAReceber = document.getElementById('totalAReceber');
        
        // Bot√µes de tipo de relat√≥rio
        const btnFilipeta = document.getElementById('btnFilipeta');
        const btnRelatorioDetalhado = document.getElementById('btnRelatorioDetalhado');
        const btnResumoAprovadas = document.getElementById('btnResumoAprovadas');
        const btnFilipetaImpressora = document.getElementById('btnFilipetaImpressora');
        const btnRelatorioRecebimentos = document.getElementById('btnRelatorioRecebimentos'); // NOVO: Bot√£o para relat√≥rio de recebimentos
        
        // Elementos para an√°lise de recebimentos (NOVO)
        const recebimentosContainer = document.getElementById('recebimentosContainer');
        const semRecebimentos = document.getElementById('semRecebimentos');
        const statsRecebido = document.getElementById('statsRecebido');
        const statsAReceber = document.getElementById('statsAReceber');
        const statsVencido = document.getElementById('statsVencido');
        const dataReferencia = document.getElementById('dataReferencia');
        const totalCartoes = document.getElementById('totalCartoes');
        const cartoesContainer = document.getElementById('cartoesContainer');
        const tabelaDetalhamento = document.getElementById('tabelaDetalhamento');
        const detalhamentoCartoes = document.getElementById('detalhamentoCartoes');
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', inicializarApp);
        fileInput.addEventListener('change', handleFileUpload);
        btnFiltrar.addEventListener('click', aplicarFiltros);
        btnLimparFiltros.addEventListener('click', limparFiltros);
        btnExportarExcel.addEventListener('click', exportarParaExcel);
        btnGerarPDF.addEventListener('click', abrirModalPDF);
        btnConfigPDF.addEventListener('click', abrirModalPDF);
        btnGerarTodasFilipetas.addEventListener('click', gerarTodasFilipetas);
        btnGerarPDFConfirmar.addEventListener('click', gerarPDF);
        btnCancelarPDF.addEventListener('click', fecharModalPDF);
        closeModal.addEventListener('click', fecharModalPDF);
        
        btnFilipeta.addEventListener('click', () => selecionarTipoRelatorio('filipeta'));
        btnRelatorioDetalhado.addEventListener('click', () => selecionarTipoRelatorio('detalhado'));
        btnResumoAprovadas.addEventListener('click', () => selecionarTipoRelatorio('aprovadas'));
        btnFilipetaImpressora.addEventListener('click', () => selecionarTipoRelatorio('filipetaImpressora'));
        btnRelatorioRecebimentos.addEventListener('click', () => selecionarTipoRelatorio('recebimentos')); // NOVO: Listener para relat√≥rio de recebimentos
        
        // NOVO: Event listener para bot√£o de impress√£o de recebimentos
        btnImprimirRecebimentos.addEventListener('click', imprimirRelatorioRecebimentos);
        
        // NOVO: Event listener para ordena√ß√£o
        filterOrdenar.addEventListener('change', aplicarOrdenacao);
        
        window.addEventListener('click', (e) => { if (e.target === pdfModal) fecharModalPDF(); });
        
        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '#e8f4fc');
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '');
        });
        
        dropArea.addEventListener('drop', handleDrop);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                fileInput.files = files;
                handleFileUpload();
            }
        }
        
        // Inicializa√ß√£o
        function inicializarApp() {
            // Configurar datas padr√£o para novembro 2025 (como na planilha de exemplo)
            filterDataInicio.value = '2025-11-01';
            filterDataFim.value = '2025-11-30';
            
            // Configurar data do relat√≥rio como data atual
            const hoje = new Date().toISOString().split('T')[0];
            pdfDataRelatorio.value = hoje;
            
            // Atualizar data de refer√™ncia
            dataReferencia.textContent = formatarDataParaExibicao(new Date());
            
            console.log('‚úÖ Sistema B2B PDF inicializado!');
        }
        
        // Fun√ß√£o principal para processar upload
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            fileName.textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            fileName.style.color = '#27ae60';
            
            mostrarLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const extensao = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                    const data = e.target.result;
                    
                    if (extensao === '.csv') {
                        processarCSV(data);
                    } else {
                        processarExcel(data);
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                    console.error('Erro no processamento:', error);
                    limparDados();
                } finally {
                    mostrarLoading(false);
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Processar Excel CORRETAMENTE - SEM REMOVER PONTOS DOS N√öMEROS
        function processarExcel(data) {
            try {
                const workbook = XLSX.read(data, { 
                    type: 'array', 
                    cellDates: true,
                    raw: true // IMPORTANTE: manter raw true para n√£o converter automaticamente
                });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                
                if (jsonData.length < 2) {
                    mostrarNotificacao('Arquivo vazio ou inv√°lido', 'error');
                    return;
                }
                
                const cabecalhos = jsonData[0];
                dadosOriginais = [];
                
                // Mapear √≠ndices dos campos
                const indicesCampos = {};
                cabecalhos.forEach((cabecalho, index) => {
                    const nomeNormalizado = normalizarNomeCampo(cabecalho);
                    indicesCampos[nomeNormalizado] = index;
                });
                
                for (let i = 1; i < jsonData.length; i++) {
                    const linha = jsonData[i];
                    if (!linha || linha.length === 0) continue;
                    
                    const registro = {};
                    
                    // Processar cada campo esperado
                    CAMPOS_ESPERADOS.forEach(campo => {
                        const nomeNormalizado = normalizarNomeCampo(campo);
                        const indice = indicesCampos[nomeNormalizado];
                        
                        let valor = '';
                        if (indice !== undefined && linha[indice] !== undefined) {
                            valor = linha[indice];
                            
                            // Converter datas
                            if (valor instanceof Date) {
                                valor = dayjs(valor).format('DD/MM/YYYY');
                            } else if (valor !== null && valor !== undefined) {
                                valor = String(valor).trim();
                            }
                        }
                        
                        registro[campo] = valor;
                    });
                    
                    // Validar registro m√≠nimo
                    if (registro['Data Transacao'] && registro['Valor total da transacao']) {
                        // Converter valores num√©ricos CORRETAMENTE
                        converterValoresNumericosFIXO(registro);
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado', 'error');
                    return;
                }
                
                console.log('Primeiros 3 registros processados:', dadosOriginais.slice(0, 3));
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                calcularTotaisIndividuais();
                analisarRecebimentos(); // NOVO: Analisar recebimentos
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao('Erro ao processar arquivo Excel', 'error');
                console.error('Erro no Excel:', error);
            }
        }
        
        // Fun√ß√£o para normalizar nomes de campos
        function normalizarNomeCampo(nome) {
            return String(nome)
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Converter valores num√©ricos CORRETAMENTE - SEM REMOVER PONTOS
        function converterValoresNumericosFIXO(registro) {
            CAMPOS_NUMERICOS.forEach(campo => {
                if (registro[campo] !== undefined && registro[campo] !== null && registro[campo] !== '') {
                    let valorStr = String(registro[campo]).trim();
                    
                    // Se j√° for n√∫mero, usar direto
                    if (typeof registro[campo] === 'number') {
                        registro[`${campo}_NUM`] = registro[campo];
                        return;
                    }
                    
                    // Remover s√≠mbolos de moeda e espa√ßos
                    valorStr = valorStr.replace(/[R$\s]/g, '').trim();
                    
                    // Se estiver vazio ap√≥s remo√ß√£o, definir como 0
                    if (valorStr === '') {
                        registro[`${campo}_NUM`] = 0;
                        return;
                    }
                    
                    // Verificar formato
                    const temVirgula = valorStr.includes(',');
                    const temPonto = valorStr.includes('.');
                    
                    let valorNumerico;
                    
                    if (temVirgula && !temPonto) {
                        // Formato: "1234,56" - v√≠rgula decimal
                        valorStr = valorStr.replace(',', '.');
                        valorNumerico = parseFloat(valorStr);
                    } else if (!temVirgula && temPonto) {
                        // Formato: "1234.56" - ponto decimal (formato internacional)
                        // Contar pontos para verificar se √© separador de milhar
                        const partes = valorStr.split('.');
                        
                        if (partes.length === 2) {
                            // Apenas um ponto - √© decimal
                            valorNumerico = parseFloat(valorStr);
                        } else if (partes.length > 2) {
                            // M√∫ltiplos pontos - pode ser formato com separador de milhar (ex: 1.234.567,89)
                            // Mas no formato brasileiro, isso seria com v√≠rgula decimal
                            // Vamos tratar como n√∫mero sem pontos e depois verificar casas decimais
                            const semPontos = valorStr.replace(/\./g, '');
                            // Assumir 2 casas decimais se o √∫ltimo segmento tiver 2 d√≠gitos
                            const ultimoSegmento = partes[partes.length - 1];
                            if (ultimoSegmento.length === 2) {
                                // √â provavelmente formato com separador de milhar e 2 casas decimais
                                const numeroInteiro = semPontos.slice(0, -2);
                                const decimais = semPontos.slice(-2);
                                valorNumerico = parseFloat(numeroInteiro + '.' + decimais);
                            } else {
                                valorNumerico = parseFloat(semPontos);
                            }
                        } else {
                            valorNumerico = parseFloat(valorStr);
                        }
                    } else if (temVirgula && temPonto) {
                        // Formato: "1.234,56" - ponto √© separador de milhar, v√≠rgula √© decimal
                        valorStr = valorStr.replace(/\./g, '').replace(',', '.');
                        valorNumerico = parseFloat(valorStr);
                    } else {
                        // Nenhum separador - n√∫mero inteiro
                        valorNumerico = parseFloat(valorStr);
                    }
                    
                    if (!isNaN(valorNumerico)) {
                        registro[`${campo}_NUM`] = valorNumerico;
                        console.log(`Campo ${campo}: "${registro[campo]}" -> ${valorNumerico}`);
                    } else {
                        registro[`${campo}_NUM`] = 0;
                        console.warn(`N√£o foi poss√≠vel converter ${campo}: "${registro[campo]}"`);
                    }
                } else {
                    registro[`${campo}_NUM`] = 0;
                }
            });
        }
        
        // Processar CSV
        function processarCSV(content) {
            try {
                const linhas = content.split('\n');
                if (linhas.length < 2) {
                    mostrarNotificacao('CSV vazio ou inv√°lido', 'error');
                    return;
                }
                
                const separador = linhas[0].includes(';') ? ';' : ',';
                const cabecalhos = parseCSVLine(linhas[0], separador);
                
                // Mapear √≠ndices
                const indicesCampos = {};
                cabecalhos.forEach((cabecalho, index) => {
                    const nomeNormalizado = normalizarNomeCampo(cabecalho);
                    indicesCampos[nomeNormalizado] = index;
                });
                
                dadosOriginais = [];
                
                for (let i = 1; i < linhas.length; i++) {
                    if (linhas[i].trim() === '') continue;
                    
                    const valores = parseCSVLine(linhas[i], separador);
                    const registro = {};
                    
                    // Processar cada campo esperado
                    CAMPOS_ESPERADOS.forEach(campo => {
                        const nomeNormalizado = normalizarNomeCampo(campo);
                        const indice = indicesCampos[nomeNormalizado];
                        
                        let valor = '';
                        if (indice !== undefined && valores[indice] !== undefined) {
                            valor = valores[indice].trim();
                        }
                        
                        registro[campo] = valor;
                    });
                    
                    if (registro['Data Transacao'] && registro['Valor total da transacao']) {
                        converterValoresNumericosFIXO(registro);
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado', 'error');
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                calcularTotaisIndividuais();
                analisarRecebimentos(); // NOVO: Analisar recebimentos
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao('Erro ao processar CSV', 'error');
                console.error('Erro no CSV:', error);
            }
        }
        
        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.replace(/^"+|"+$/g, ''));
        }
        
        // Mostrar pr√©via dos dados
        function mostrarPreviaDados() {
            if (dadosFiltrados.length === 0) {
                dataPreview.style.display = 'none';
                return;
            }
            
            dataPreview.style.display = 'block';
            previewBody.innerHTML = '';
            
            // Atualizar indicador de ordena√ß√£o
            const indicadorOrdenacao = document.getElementById('indicadorOrdenacao');
            let textoOrdenacao = '';
            
            switch(ordenarPor) {
                case 'antiga_recente': 
                    textoOrdenacao = '‚úì Ordenado: Mais Antiga ‚Üí Mais Recente'; 
                    break;
                case 'recente_antiga': 
                    textoOrdenacao = '‚úì Ordenado: Mais Recente ‚Üí Mais Antiga'; 
                    break;
                default: 
                    textoOrdenacao = 'Ordem original do arquivo';
            }
            
            if (indicadorOrdenacao) {
                indicadorOrdenacao.textContent = textoOrdenacao;
            }
            
            const limite = Math.min(10, dadosFiltrados.length);
            
            for (let i = 0; i < limite; i++) {
                const registro = dadosFiltrados[i];
                const tr = document.createElement('tr');
                
                let statusClass = '';
                if (registro.Status === 'Aprovada') statusClass = 'status-aprovada';
                else if (registro.Status === 'Cancelada') statusClass = 'status-cancelada';
                else if (registro.Status === 'Pendente') statusClass = 'status-pendente';
                
                tr.innerHTML = `
                    <td class="${statusClass}">${registro.Status || 'N/A'}</td>
                    <td>${registro['Data Transacao'] || 'N/A'}</td>
                    <td>${registro['Data Recebimento'] || 'N/A'}</td>
                    <td class="currency">R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}</td>
                    <td class="currency">R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}</td>
                    <td>${registro['N√∫mero do Cartao'] || 'N/A'}</td>
                `;
                
                previewBody.appendChild(tr);
            }
            
            atualizarEstatisticasPrevia();
        }
        
        // Calcular totais individuais para CADA CAMPO - APENAS APROVADAS
        function calcularTotaisIndividuais() {
            if (dadosFiltrados.length === 0) {
                totaisPreview.style.display = 'none';
                return;
            }
            
            totaisPreview.style.display = 'block';
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(registro => registro.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                totaisGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #7f8c8d;">
                        üì≠ Nenhuma transa√ß√£o aprovada encontrada
                    </div>
                `;
                return;
            }
            
            // Calcular totais para cada campo num√©rico (APENAS APROVADAS)
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                const total = transacoesAprovadas.reduce((soma, registro) => {
                    return soma + (registro[`${campo}_NUM`] || 0);
                }, 0);
                totais[campo] = total;
            });
            
            // Exibir totais
            let html = '';
            
            // Agrupar por categoria
            const grupos = {
                'Di√°rias': ['Total Diarias'],
                'Valores Principais': ['Valor total da transacao', 'Valor Liquido'],
                'Taxas e Impostos': ['Valor Taxas', 'Valor Impostos'],
                'Comiss√µes': ['Comissoes', 'Taxa de Servico B2B', 'Valor Adquirencia'],
                'Extras': ['Valor Extras']
            };
            
            for (const [grupo, campos] of Object.entries(grupos)) {
                html += `<div style="grid-column: 1 / -1; font-weight: bold; margin-top: 10px; color: #2c3e50;">${grupo}</div>`;
                
                campos.forEach(campo => {
                    if (totais[campo] !== undefined) {
                        const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                        const valorFormatado = isMoeda ? 
                            `R$ ${formatarMoeda(totais[campo])}` : 
                            formatarNumero(totais[campo]);
                        
                        html += `
                            <div class="total-item">
                                <div class="total-label">${campo}</div>
                                <div class="total-value">${valorFormatado}</div>
                            </div>
                        `;
                    }
                });
            }
            
            totaisGrid.innerHTML = html;
        }
        
        // Atualizar estat√≠sticas da pr√©via
        function atualizarEstatisticasPrevia() {
            const total = dadosFiltrados.length;
            const aprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada').length;
            const canceladas = dadosFiltrados.filter(r => r.Status === 'Cancelada').length;
            const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorMedio = total > 0 ? valorTotalSum / total : 0;
            
            dataStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total de Transa√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${aprovadas}</div>
                    <div class="stat-label">Aprovadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${canceladas}</div>
                    <div class="stat-label">Canceladas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">R$ ${formatarMoeda(valorMedio)}</div>
                    <div class="stat-label">Valor M√©dio</div>
                </div>
            `;
        }
        
        // Fun√ß√µes de formata√ß√£o
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatarNumero(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatarDataParaExibicao(data) {
            return dayjs(data).format('DD/MM/YYYY');
        }
        
        // Atualizar filtros de bandeira
        function atualizarFiltrosBandeira() {
            const bandeiras = new Set();
            dadosOriginais.forEach(r => {
                if (r['Bandeira do Cartao']) bandeiras.add(r['Bandeira do Cartao'].trim());
            });
            
            while (filterBandeira.options.length > 1) filterBandeira.remove(1);
            
            Array.from(bandeiras).sort().forEach(bandeira => {
                const option = document.createElement('option');
                option.value = bandeira;
                option.textContent = bandeira;
                filterBandeira.appendChild(option);
            });
        }
        
        // Limpar dados
        function limparDados() {
            dadosOriginais = [];
            dadosFiltrados = [];
            ordenarPor = 'padrao';
            dataPreview.style.display = 'none';
            totaisPreview.style.display = 'none';
            recebimentosContainer.style.display = 'none';
            semRecebimentos.style.display = 'block';
            filterOrdenar.value = 'padrao';
            atualizarResumo();
        }
        
        // Parsear data melhorada para ordena√ß√£o
        function parsearData(dataString) {
            if (!dataString) return null;
            try {
                // Se j√° for um objeto Date
                if (dataString instanceof Date) return dataString;
                
                // Se for string, tentar formatos
                if (dataString.includes('/')) {
                    const [datePart, timePart] = dataString.split(' ');
                    const [day, month, year] = datePart.split('/');
                    let fullYear = year;
                    if (year.length === 2) fullYear = `20${year}`;
                    
                    if (timePart) {
                        const [hours, minutes, seconds] = timePart.split(':');
                        return new Date(fullYear, month - 1, day, hours || 0, minutes || 0, seconds || 0);
                    }
                    return new Date(fullYear, month - 1, day);
                } else if (dataString.includes('-')) {
                    // Formato YYYY-MM-DD ou YYYY-MM-DD HH:mm:ss
                    return new Date(dataString);
                } else {
                    // Tentar converter diretamente
                    return new Date(dataString);
                }
            } catch (error) {
                console.warn('Erro ao parsear data:', dataString, error);
                return null;
            }
        }
        
        // NOVA FUN√á√ÉO: Analisar recebimentos - APENAS APROVADAS
        function analisarRecebimentos() {
            if (dadosFiltrados.length === 0) {
                recebimentosContainer.style.display = 'none';
                semRecebimentos.style.display = 'block';
                return;
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            let totalRecebidoValor = 0;
            let totalAReceberValor = 0;
            let totalVencidoValor = 0;
            
            // Agrupar por cart√£o - APENAS APROVADAS
            const cartoesMap = new Map();
            
            dadosFiltrados.forEach(registro => {
                // FILTRAR APENAS TRANSA√á√ïES APROVADAS
                if (registro.Status !== 'Aprovada') return;
                
                const numeroCartao = registro['N√∫mero do Cartao'] || 'Sem Cart√£o';
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                const dataRecebimentoStr = registro['Data Recebimento'];
                const dataRecebimento = parsearData(dataRecebimentoStr);
                
                // Inicializar dados do cart√£o se n√£o existir
                if (!cartoesMap.has(numeroCartao)) {
                    cartoesMap.set(numeroCartao, {
                        numero: numeroCartao,
                        bandeira: registro['Bandeira do Cartao'] || 'N/A',
                        valorTotal: 0,
                        valorRecebido: 0,
                        valorAReceber: 0,
                        valorVencido: 0,
                        transacoes: []
                    });
                }
                
                const cartao = cartoesMap.get(numeroCartao);
                cartao.valorTotal += valorTotal;
                cartao.transacoes.push({
                    dataTransacao: registro['Data Transacao'],
                    dataRecebimento: dataRecebimentoStr,
                    valorTotal: valorTotal,
                    valorLiquido: registro['Valor Liquido_NUM'] || 0,
                    status: registro.Status || 'N/A',
                    statusRecebimento: 'a_receber' // Default
                });
                
                // Verificar status do recebimento
                if (dataRecebimento) {
                    // Normalizar para comparar apenas datas (sem horas)
                    const dataReceb = new Date(dataRecebimento);
                    dataReceb.setHours(0, 0, 0, 0);
                    
                    if (dataReceb <= hoje) {
                        // J√° recebido
                        totalRecebidoValor += valorTotal;
                        cartao.valorRecebido += valorTotal;
                        cartao.transacoes[cartao.transacoes.length - 1].statusRecebimento = 'recebido';
                    } else {
                        // A receber
                        totalAReceberValor += valorTotal;
                        cartao.valorAReceber += valorTotal;
                        cartao.transacoes[cartao.transacoes.length - 1].statusRecebimento = 'a_receber';
                        
                        // Verificar se est√° vencido (mais de 30 dias da data de transa√ß√£o)
                        const dataTransacao = parsearData(registro['Data Transacao']);
                        if (dataTransacao) {
                            const diferencaDias = Math.floor((hoje - dataTransacao) / (1000 * 60 * 60 * 24));
                            if (diferencaDias > 30) {
                                totalVencidoValor += valorTotal;
                                cartao.valorVencido += valorTotal;
                                cartao.transacoes[cartao.transacoes.length - 1].statusRecebimento = 'vencido';
                            }
                        }
                    }
                } else {
                    // Sem data de recebimento - considerar como a receber
                    totalAReceberValor += valorTotal;
                    cartao.valorAReceber += valorTotal;
                }
            });
            
            // Atualizar totais no resumo - APENAS APROVADAS
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            const valorTotalAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            const diariasAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Total Diarias_NUM'] || 0), 0);
            
            totalTransacoes.textContent = transacoesAprovadas.length.toLocaleString('pt-BR');
            valorTotal.textContent = `R$ ${formatarMoeda(valorTotalAprovadas)}`;
            valorLiquido.textContent = `R$ ${formatarMoeda(valorLiquidoAprovadas)}`;
            diariasTotal.textContent = formatarNumero(diariasAprovadas);
            
            // Atualizar totais de recebimento
            totalRecebido.textContent = `R$ ${formatarMoeda(totalRecebidoValor)}`;
            totalAReceber.textContent = `R$ ${formatarMoeda(totalAReceberValor)}`;
            
            // Atualizar estat√≠sticas detalhadas
            statsRecebido.textContent = `R$ ${formatarMoeda(totalRecebidoValor)}`;
            statsAReceber.textContent = `R$ ${formatarMoeda(totalAReceberValor)}`;
            statsVencido.textContent = `R$ ${formatarMoeda(totalVencidoValor)}`;
            
            // Atualizar total de cart√µes
            totalCartoes.textContent = cartoesMap.size;
            
            // Limpar container de cart√µes
            cartoesContainer.innerHTML = '';
            
            // Limpar tabela de detalhamento
            tabelaDetalhamento.innerHTML = '';
            
            // Ordenar cart√µes por valor total (decrescente)
            const cartoesArray = Array.from(cartoesMap.values());
            cartoesArray.sort((a, b) => b.valorTotal - a.valorTotal);
            
            // Adicionar cart√µes √† interface
            cartoesArray.forEach(cartao => {
                // Determinar status principal do cart√£o
                let statusPrincipal = 'a_receber';
                if (cartao.valorRecebido > 0 && cartao.valorAReceber === 0) {
                    statusPrincipal = 'recebido';
                } else if (cartao.valorVencido > 0) {
                    statusPrincipal = 'vencido';
                }
                
                // Criar card do cart√£o
                const cartaoCard = document.createElement('div');
                cartaoCard.className = 'cartao-card';
                
                cartaoCard.innerHTML = `
                    <div class="cartao-header">
                        <div class="cartao-numero">${formatarNumeroCartao(cartao.numero)}</div>
                        <div class="cartao-status ${statusPrincipal}">
                            ${statusPrincipal === 'recebido' ? '‚úÖ Recebido' : 
                              statusPrincipal === 'vencido' ? '‚ö†Ô∏è Vencido' : '‚è≥ A Receber'}
                        </div>
                    </div>
                    <div class="cartao-detalhes">
                        <div class="cartao-detalhe">
                            <span class="cartao-detalhe-label">Bandeira:</span>
                            <span class="cartao-detalhe-value">${cartao.bandeira}</span>
                        </div>
                        <div class="cartao-detalhe">
                            <span class="cartao-detalhe-label">Valor Total:</span>
                            <span class="cartao-detalhe-value">R$ ${formatarMoeda(cartao.valorTotal)}</span>
                        </div>
                        <div class="cartao-detalhe">
                            <span class="cartao-detalhe-label">J√° Recebido:</span>
                            <span class="cartao-detalhe-value" style="color: #27ae60;">R$ ${formatarMoeda(cartao.valorRecebido)}</span>
                        </div>
                        <div class="cartao-detalhe">
                            <span class="cartao-detalhe-label">A Receber:</span>
                            <span class="cartao-detalhe-value" style="color: #9b59b6;">R$ ${formatarMoeda(cartao.valorAReceber)}</span>
                        </div>
                        <div class="cartao-detalhe">
                            <span class="cartao-detalhe-label">Vencido:</span>
                            <span class="cartao-detalhe-value" style="color: #e74c3c;">R$ ${formatarMoeda(cartao.valorVencido)}</span>
                        </div>
                        <div class="cartao-detalhe">
                            <span class="cartao-detalhe-label">Transa√ß√µes:</span>
                            <span class="cartao-detalhe-value">${cartao.transacoes.length}</span>
                        </div>
                    </div>
                `;
                
                cartoesContainer.appendChild(cartaoCard);
                
                // Adicionar √† tabela de detalhamento
                cartao.transacoes.forEach(transacao => {
                    const tr = document.createElement('tr');
                    
                    let statusClass = '';
                    let statusText = '';
                    if (transacao.statusRecebimento === 'recebido') {
                        statusClass = 'status-recebido';
                        statusText = '‚úÖ Recebido';
                    } else if (transacao.statusRecebimento === 'vencido') {
                        statusClass = 'status-cancelada';
                        statusText = '‚ö†Ô∏è Vencido';
                    } else {
                        statusClass = 'status-a-receber';
                        statusText = '‚è≥ A Receber';
                    }
                    
                    // Calcular dias desde a transa√ß√£o
                    const dataTransacao = parsearData(transacao.dataTransacao);
                    let diasTexto = 'N/A';
                    if (dataTransacao) {
                        const hoje = new Date();
                        const diferencaDias = Math.floor((hoje - dataTransacao) / (1000 * 60 * 60 * 24));
                        diasTexto = `${diferencaDias} dias`;
                    }
                    
                    tr.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${formatarNumeroCartao(cartao.numero)}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;" class="${statusClass}">${statusText}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">R$ ${formatarMoeda(transacao.valorTotal)}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${transacao.dataRecebimento || 'N/A'}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${diasTexto}</td>
                    `;
                    
                    tabelaDetalhamento.appendChild(tr);
                });
            });
            
            // Mostrar container de recebimentos se houver transa√ß√µes aprovadas
            if (cartoesArray.length > 0) {
                recebimentosContainer.style.display = 'block';
                semRecebimentos.style.display = 'none';
            } else {
                recebimentosContainer.style.display = 'none';
                semRecebimentos.style.display = 'block';
                semRecebimentos.innerHTML = `
                    <p style="font-size: 1.1rem;">üì≠ Nenhuma transa√ß√£o aprovada com dados de recebimento dispon√≠vel.</p>
                    <p style="font-size: 0.9rem;">Verifique se o arquivo cont√©m transa√ß√µes com status "Aprovada" e coluna "Data Recebimento".</p>
                `;
            }
        }
        
        // Fun√ß√£o para formatar n√∫mero do cart√£o
        function formatarNumeroCartao(numero) {
            if (!numero || numero === 'Sem Cart√£o') return 'Sem Cart√£o';
            
            // Limpar caracteres n√£o num√©ricos
            const apenasNumeros = numero.replace(/\D/g, '');
            
            if (apenasNumeros.length <= 4) {
                return `**** **** **** ${apenasNumeros}`;
            } else if (apenasNumeros.length <= 8) {
                return `**** **** ${apenasNumeros.slice(-4)}`;
            } else if (apenasNumeros.length <= 12) {
                return `**** ${apenasNumeros.slice(-8, -4)} ${apenasNumeros.slice(-4)}`;
            } else {
                return `${apenasNumeros.slice(0, 4)} **** **** ${apenasNumeros.slice(-4)}`;
            }
        }
        
        // NOVA FUN√á√ÉO: Aplicar ordena√ß√£o
        function aplicarOrdenacao() {
            if (dadosFiltrados.length === 0) return;
            
            ordenarPor = filterOrdenar.value;
            
            // Fazer uma c√≥pia para ordenar
            let dadosParaOrdenar = [...dadosFiltrados];
            
            switch(ordenarPor) {
                case 'antiga_recente':
                    dadosParaOrdenar.sort((a, b) => {
                        const dataA = parsearData(a['Data Transacao']);
                        const dataB = parsearData(b['Data Transacao']);
                        return (dataA || 0) - (dataB || 0);
                    });
                    break;
                    
                case 'recente_antiga':
                    dadosParaOrdenar.sort((a, b) => {
                        const dataA = parsearData(a['Data Transacao']);
                        const dataB = parsearData(b['Data Transacao']);
                        return (dataB || 0) - (dataA || 0);
                    });
                    break;
                    
                case 'padrao':
                default:
                    // Para restaurar a ordem original, precisamos reaplicar os filtros
                    // mas mantendo a ordem do arquivo original
                    dadosParaOrdenar = dadosOriginais.filter(registro => 
                        dadosFiltrados.some(filtrado => 
                            JSON.stringify(filtrado) === JSON.stringify(registro)
                        )
                    );
                    break;
            }
            
            dadosFiltrados = dadosParaOrdenar;
            mostrarPreviaDados();
            atualizarResumo();
            calcularTotaisIndividuais();
            analisarRecebimentos(); // NOVO: Reanalisar recebimentos ap√≥s ordena√ß√£o
            
            // Mostrar notifica√ß√£o apenas se n√£o for a op√ß√£o padr√£o
            if (ordenarPor !== 'padrao') {
                const mensagem = ordenarPor === 'antiga_recente' 
                    ? 'Dados ordenados da mais antiga para a mais recente'
                    : 'Dados ordenados da mais recente para a mais antiga';
                mostrarNotificacao(mensagem, 'success');
            }
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('Carregue um arquivo primeiro', 'error');
                return;
            }
            
            // Aplicar filtros primeiro
            dadosFiltrados = dadosOriginais.filter(registro => {
                if (filterStatus.value && registro.Status !== filterStatus.value) return false;
                
                if (filterBandeira.value && registro['Bandeira do Cartao'] !== filterBandeira.value) return false;
                
                const dataTransacao = parsearData(registro['Data Transacao']);
                if (filterDataInicio.value && dataTransacao) {
                    const dataInicio = new Date(filterDataInicio.value);
                    if (dataTransacao < dataInicio) return false;
                }
                
                if (filterDataFim.value && dataTransacao) {
                    const dataFim = new Date(filterDataFim.value);
                    dataFim.setHours(23, 59, 59, 999);
                    if (dataTransacao > dataFim) return false;
                }
                
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                if (filterValorMin.value && valorTotal < parseFloat(filterValorMin.value)) return false;
                if (filterValorMax.value && valorTotal > parseFloat(filterValorMax.value)) return false;
                
                return true;
            });
            
            // Aplicar ordena√ß√£o ap√≥s filtrar
            aplicarOrdenacao();
            
            mostrarNotificacao(`${dadosFiltrados.length} transa√ß√µes encontradas`, 'success');
        }
        
        // Limpar filtros
        function limparFiltros() {
            filterStatus.value = '';
            filterDataInicio.value = '2025-11-01';
            filterDataFim.value = '2025-11-30';
            filterValorMin.value = '';
            filterValorMax.value = '';
            filterBandeira.value = '';
            filterOrdenar.value = 'padrao';
            
            dadosFiltrados = [...dadosOriginais];
            ordenarPor = 'padrao';
            atualizarResumo();
            calcularTotaisIndividuais();
            analisarRecebimentos(); // NOVO: Reanalisar recebimentos
            mostrarPreviaDados();
            mostrarNotificacao('Filtros e ordena√ß√£o limpos', 'success');
        }
        
        // Atualizar resumo - APENAS APROVADAS
        function atualizarResumo() {
            if (dadosFiltrados.length === 0) {
                totalTransacoes.textContent = '0';
                valorTotal.textContent = 'R$ 0,00';
                valorLiquido.textContent = 'R$ 0,00';
                diariasTotal.textContent = '0';
                totalRecebido.textContent = 'R$ 0,00';
                totalAReceber.textContent = 'R$ 0,00';
                return;
            }
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                totalTransacoes.textContent = '0';
                valorTotal.textContent = 'R$ 0,00';
                valorLiquido.textContent = 'R$ 0,00';
                diariasTotal.textContent = '0';
                return;
            }
            
            const total = transacoesAprovadas.length;
            const valorTotalSum = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoSum = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            const diariasSum = transacoesAprovadas.reduce((sum, r) => sum + (r['Total Diarias_NUM'] || 0), 0);
            
            totalTransacoes.textContent = total.toLocaleString('pt-BR');
            valorTotal.textContent = `R$ ${formatarMoeda(valorTotalSum)}`;
            valorLiquido.textContent = `R$ ${formatarMoeda(valorLiquidoSum)}`;
            diariasTotal.textContent = formatarNumero(diariasSum);
        }
        
        // Exportar para Excel
        function exportarParaExcel() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para exportar', 'error');
                return;
            }
            
            // Aplicar ordena√ß√£o atual antes de exportar
            aplicarOrdenacao();
            
            const colunasExport = CAMPOS_ESPERADOS;
            const cabecalhos = colunasExport.join(';');
            const linhas = dadosFiltrados.map(registro => {
                return colunasExport.map(coluna => {
                    let valor = registro[coluna] || '';
                    if (valor.includes(';')) valor = `"${valor}"`;
                    return valor;
                }).join(';');
            });
            
            const conteudoCSV = [cabecalhos, ...linhas].join('\n');
            const blob = new Blob(['\uFEFF' + conteudoCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_b2b_${dayjs().format('YYYY-MM-DD')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('CSV exportado com sucesso!', 'success');
        }
        
        // Selecionar tipo de relat√≥rio
        function selecionarTipoRelatorio(tipo) {
            tipoRelatorioAtual = tipo;
            
            [btnFilipeta, btnRelatorioDetalhado, btnResumoAprovadas, btnFilipetaImpressora, btnRelatorioRecebimentos].forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tipo === 'filipeta') btnFilipeta.classList.add('active');
            if (tipo === 'detalhado') btnRelatorioDetalhado.classList.add('active');
            if (tipo === 'aprovadas') btnResumoAprovadas.classList.add('active');
            if (tipo === 'filipetaImpressora') btnFilipetaImpressora.classList.add('active');
            if (tipo === 'recebimentos') btnRelatorioRecebimentos.classList.add('active'); // NOVO: Ativar bot√£o de recebimentos
            
            const btnTexto = {
                'filipeta': 'GERAR FILIPETA POS',
                'detalhado': 'GERAR RELAT√ìRIO DETALHADO',
                'aprovadas': 'GERAR RESUMO APROVADAS',
                'filipetaImpressora': 'üñ®Ô∏è GERAR FILIPETA IMPRESSORA',
                'recebimentos': 'üí∞ GERAR RELAT√ìRIO RECEBIMENTOS'
            };
            
            btnGerarPDF.innerHTML = `üìä ${btnTexto[tipo]}`;
        }
        
        // Abrir modal PDF
        function abrirModalPDF() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('Carregue um arquivo primeiro', 'error');
                return;
            }
            // Configurar data atual se n√£o estiver definida
            if (!pdfDataRelatorio.value) {
                const hoje = new Date().toISOString().split('T')[0];
                pdfDataRelatorio.value = hoje;
            }
            pdfModal.style.display = 'block';
        }
        
        // Fechar modal PDF
        function fecharModalPDF() {
            pdfModal.style.display = 'none';
        }
        
        // Gerar PDF principal
        function gerarPDF() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para gerar relat√≥rio', 'error');
                return;
            }
            
            fecharModalPDF();
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    // Aplicar ordena√ß√£o atual antes de gerar
                    aplicarOrdenacao();
                    
                    switch(tipoRelatorioAtual) {
                        case 'filipeta': gerarPDFFilipeta(); break;
                        case 'detalhado': gerarPDFDetalhado(); break;
                        case 'aprovadas': gerarPDFResumoAprovadas(); break;
                        case 'filipetaImpressora': gerarPDFFilipetaImpressora(); break;
                        case 'recebimentos': gerarPDFRelatorioRecebimentos(); break; // NOVO: Gerar relat√≥rio de recebimentos
                        default: gerarPDFFilipeta();
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Obter data do relat√≥rio formatada
        function obterDataRelatorio() {
            const dataRelatorio = pdfDataRelatorio.value;
            if (dataRelatorio) {
                return dayjs(dataRelatorio).format('DD/MM/YYYY');
            }
            return dayjs().format('DD/MM/YYYY');
        }
        
        // Gerar PDF Filipeta POS - APENAS APROVADAS
        function gerarPDFFilipeta() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            const doc = new jsPDF({
                orientation: pdfOrientation.value,
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üè¶ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('FILIPETA DE VENDAS POS - APROVADAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.text(`Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 15, yPos - 10, { align: 'right' });
            yPos += 10;
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                doc.setFontSize(12);
                doc.text('Nenhuma transa√ß√£o aprovada encontrada', pageWidth / 2, yPos + 20, { align: 'center' });
                const fileName = `filipeta_pos_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
                doc.save(fileName);
                mostrarNotificacao('Nenhuma transa√ß√£o aprovada encontrada', 'info');
                return;
            }
            
            // Calcular totais individuais - APENAS APROVADAS
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = transacoesAprovadas.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Adicionar resumo de totais se configurado
            if (pdfIncludeSummary.value === 'true') {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAIS DAS TRANSA√á√ïES APROVADAS:', 15, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                // Mostrar alguns totais principais
                const principaisTotais = [
                    ['Valor Total', totais['Valor total da transacao']],
                    ['Valor L√≠quido', totais['Valor Liquido']],
                    ['Di√°rias Totais', totais['Total Diarias']],
                    ['Comiss√µes', totais['Comissoes']],
                    ['Taxa B2B', totais['Taxa de Servico B2B']],
                    ['Adquirente', totais['Valor Adquirencia']]
                ];
                
                principaisTotais.forEach(([label, valor]) => {
                    const isMoeda = label.includes('Valor') || label.includes('Comiss') || label.includes('Taxa') || label.includes('Adquirente');
                    const valorFormatado = isMoeda ? 
                        `R$ ${formatarMoeda(valor)}` : 
                        formatarNumero(valor);
                    
                    doc.text(`‚Ä¢ ${label}: ${valorFormatado}`, 20, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // Tabela principal - APENAS APROVADAS
            const headers = ['#', 'Data/Hora', 'Status', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = transacoesAprovadas.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    registro.Status || '',
                    `R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`,
                    `R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255, fontSize: 9, fontStyle: 'bold' },
                bodyStyles: { fontSize: 8, cellPadding: 2 },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            const fileName = `filipeta_pos_aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Filipeta de transa√ß√µes aprovadas gerada: ${fileName}`, 'success');
        }
        
        // Gerar PDF Detalhado com TODOS os totais individuais - APENAS APROVADAS
        function gerarPDFDetalhado() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üè¶ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DETALHADO COMPLETO - APROVADAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.text(`Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 12;
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                doc.setFontSize(12);
                doc.text('Nenhuma transa√ß√£o aprovada encontrada', pageWidth / 2, yPos + 20, { align: 'center' });
                const fileName = `relatorio_detalhado_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
                doc.save(fileName);
                mostrarNotificacao('Nenhuma transa√ß√£o aprovada encontrada', 'info');
                return;
            }
            
            // Calcular TODOS os totais individuais - APENAS APROVADAS
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = transacoesAprovadas.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Tabela com todos os campos - APENAS APROVADAS
            const headers = CAMPOS_ESPERADOS;
            const data = transacoesAprovadas.map((registro, index) => {
                return headers.map(campo => {
                    let valor = registro[campo] || '';
                    
                    // Formatar valores num√©ricos
                    if (CAMPOS_NUMERICOS.includes(campo)) {
                        const valorNum = registro[`${campo}_NUM`];
                        if (valorNum !== undefined) {
                            const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                            valor = isMoeda ? 
                                `R$ ${formatarMoeda(valorNum)}` : 
                                formatarNumero(valorNum);
                        }
                    }
                    
                    return valor;
                });
            });
            
            // Adicionar linha de TOTAIS no final - APENAS APROVADAS
            const linhaTotais = headers.map(campo => {
                if (CAMPOS_NUMERICOS.includes(campo)) {
                    const total = totais[campo];
                    const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                    return isMoeda ? 
                        `R$ ${formatarMoeda(total)}` : 
                        formatarNumero(total);
                } else if (campo === 'Status') {
                    return 'TOTAIS APROVADAS';
                } else {
                    return '';
                }
            });
            
            data.push(linhaTotais);
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontSize: 8, fontStyle: 'bold' },
                bodyStyles: { fontSize: 7, cellPadding: 2 },
                margin: { left: 10, right: 10 },
                // Estilo especial para a √∫ltima linha (totais)
                didParseCell: function(data) {
                    if (data.row.index === data.table.body.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [241, 196, 15]; // Amarelo para totais
                        data.cell.styles.textColor = [0, 0, 0];
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                    doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 10, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            });
            
            const fileName = `relatorio_detalhado_aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Relat√≥rio detalhado de aprovadas gerado: ${fileName}`, 'success');
        }
        
        // Gerar PDF Resumo Aprovadas
        function gerarPDFResumoAprovadas() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('‚úÖ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DE TRANSA√á√ïES APROVADAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.text(`Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;
            
            // Calcular totais das aprovadas
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = transacoesAprovadas.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Adicionar resumo de totais
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAIS DAS APROVADAS:', 15, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Listar totais principais
            const principaisCampos = [
                'Valor total da transacao',
                'Valor Liquido',
                'Total Diarias',
                'Comissoes',
                'Taxa de Servico B2B',
                'Valor Adquirencia',
                'Valor Impostos',
                'Valor Taxas',
                'Valor Extras'
            ];
            
            let xPos = 15;
            let colCount = 0;
            
            principaisCampos.forEach(campo => {
                const total = totais[campo] || 0;
                const isMoeda = campo.includes('Valor') || campo.includes('Comissoes') || campo.includes('Taxa');
                const valorFormatado = isMoeda ? 
                    `R$ ${formatarMoeda(total)}` : 
                    formatarNumero(total);
                
                const label = campo.length > 20 ? campo.substring(0, 20) + '...' : campo;
                
                doc.text(`‚Ä¢ ${label}:`, xPos, yPos);
                doc.text(valorFormatado, xPos + 45, yPos);
                
                colCount++;
                if (colCount % 5 === 0) {
                    xPos += 60;
                    yPos = 30;
                } else {
                    yPos += 5;
                }
            });
            
            yPos += 10;
            
            // Tabela simplificada
            const headers = ['#', 'Data', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = transacoesAprovadas.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    `R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`,
                    `R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            // Adicionar linha de totais
            const totalValor = totais['Valor total da transacao'];
            const totalLiquido = totais['Valor Liquido'];
            data.push([
                'TOTAIS',
                '',
                `R$ ${formatarMoeda(totalValor)}`,
                `R$ ${formatarMoeda(totalLiquido)}`,
                '',
                ''
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [46, 204, 113], textColor: 255, fontSize: 9 },
                bodyStyles: { fontSize: 8 },
                margin: { left: 15, right: 15 },
                didParseCell: function(data) {
                    if (data.row.index === data.table.body.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [241, 196, 15];
                        data.cell.styles.textColor = [0, 0, 0];
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                    doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 10, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            });
            
            const fileName = `aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Resumo de aprovadas gerado: ${fileName}`, 'success');
        }
        
        // Gerar PDF para Impressora de Filipeta - APENAS APROVADAS
        function gerarPDFFilipetaImpressora() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            // Formato longo para m√°quina de filipeta (80mm de largura, comprimento vari√°vel)
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 297] // Largura fixa 80mm, altura A4 (pode ser maior)
            });
            
            const pageWidth = 80;
            let yPos = 10;
            const margin = 5;
            const contentWidth = pageWidth - 2 * margin;
            
            // Configurar fonte menor para caber mais conte√∫do
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            
            // Cabe√ßalho do relat√≥rio
            doc.text('B2B RESERVAS - RELAT√ìRIO FILIPETA', pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.text(`Data do Relat√≥rio: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 4;
            
            doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Linha divis√≥ria
            doc.setDrawColor(0, 0, 0);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 5;
            
            // Resumo r√°pido - APENAS APROVADAS
            const totalTransacoes = transacoesAprovadas.length;
            const valorTotalSum = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoSum = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO R√ÅPIDO (APROVADAS):', margin, yPos);
            yPos += 4;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Transa√ß√µes: ${totalTransacoes}`, margin, yPos);
            doc.text(`Valor Total: R$ ${formatarMoeda(valorTotalSum)}`, margin + 35, yPos);
            yPos += 4;
            
            doc.text(`Valor L√≠quido: R$ ${formatarMoeda(valorLiquidoSum)}`, margin, yPos);
            yPos += 6;
            
            // Linha divis√≥ria
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // Listar todas as transa√ß√µes (formato compacto)
            doc.setFont('helvetica', 'bold');
            doc.text('DETALHES DAS TRANSA√á√ïES APROVADAS:', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            
            transacoesAprovadas.forEach((registro, index) => {
                // Verificar se precisa de nova p√°gina
                if (yPos > 280) {
                    doc.addPage([80, 297]);
                    yPos = 10;
                }
                
                // N√∫mero da transa√ß√£o
                doc.setFont('helvetica', 'bold');
                doc.text(`#${index + 1}:`, margin, yPos);
                
                // Status com cor
                const status = registro.Status || '';
                let statusColor = [0, 0, 0];
                if (status === 'Aprovada') statusColor = [46, 204, 113];
                
                doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                doc.text(status, margin + 10, yPos);
                doc.setTextColor(0, 0, 0);
                
                yPos += 4;
                
                // Data e valores
                doc.setFont('helvetica', 'normal');
                doc.text(`Data: ${registro['Data Transacao'] || 'N/A'}`, margin, yPos);
                doc.text(`Total: R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`, margin + 35, yPos);
                yPos += 3.5;
                
                doc.text(`L√≠quido: R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`, margin, yPos);
                doc.text(`Cart√£o: ${registro['N√∫mero do Cartao'] ? registro['N√∫mero do Cartao'].substring(0, 8) + '...' : 'N/A'}`, margin + 35, yPos);
                yPos += 3.5;
                
                // Detalhes financeiros compactos
                doc.setFontSize(6);
                const detalhes = [
                    `Di√°rias: ${formatarNumero(registro['Total Diarias_NUM'] || 0)}`,
                    `Comiss√µes: R$ ${formatarMoeda(registro['Comissoes_NUM'] || 0)}`,
                    `B2B: R$ ${formatarMoeda(registro['Taxa de Servico B2B_NUM'] || 0)}`,
                    `Adquirente: R$ ${formatarMoeda(registro['Valor Adquirencia_NUM'] || 0)}`
                ];
                
                detalhes.forEach(detalhe => {
                    doc.text(detalhe, margin, yPos);
                    yPos += 2.5;
                });
                
                doc.setFontSize(7);
                
                // Status de recebimento
                const dataRecebimento = parsearData(registro['Data Recebimento']);
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                doc.text('Recebimento:', margin, yPos);
                yPos += 2.5;
                
                if (dataRecebimento) {
                    const dataReceb = new Date(dataRecebimento);
                    dataReceb.setHours(0, 0, 0, 0);
                    
                    if (dataReceb <= hoje) {
                        doc.setTextColor(46, 204, 113);
                        doc.text('‚úÖ J√° Recebido', margin + 5, yPos);
                        doc.setTextColor(0, 0, 0);
                    } else {
                        doc.setTextColor(241, 196, 15);
                        doc.text('‚è≥ A Receber', margin + 5, yPos);
                        doc.setTextColor(0, 0, 0);
                    }
                    yPos += 2.5;
                    
                    doc.text(`Data: ${registro['Data Recebimento'] || 'N/A'}`, margin + 5, yPos);
                    yPos += 2.5;
                } else {
                    doc.setTextColor(155, 89, 182);
                    doc.text('üìÖ Sem data', margin + 5, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 2.5;
                }
                
                // Linha divis√≥ria entre transa√ß√µes
                if (index < transacoesAprovadas.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 5;
                } else {
                    yPos += 3;
                }
            });
            
            // Linha final
            doc.setDrawColor(0, 0, 0);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 5;
            
            // Totais finais - APENAS APROVADAS
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TOTAIS FINAIS (APROVADAS):', margin, yPos);
            yPos += 4;
            
            doc.setFont('helvetica', 'normal');
            
            // Calcular totais para todos os campos num√©ricos - APENAS APROVADAS
            const totais = {};
            CAMPOS_NUMERICOS.forEach(campo => {
                totais[campo] = transacoesAprovadas.reduce((soma, r) => soma + (r[`${campo}_NUM`] || 0), 0);
            });
            
            // Mostrar totais principais
            const totaisPrincipais = [
                ['Valor Total Transa√ß√µes', totais['Valor total da transacao']],
                ['Valor L√≠quido Total', totais['Valor Liquido']],
                ['Di√°rias Totais', totais['Total Diarias']],
                ['Total Comiss√µes', totais['Comissoes']],
                ['Total Taxa B2B', totais['Taxa de Servico B2B']],
                ['Total Adquirente', totais['Valor Adquirencia']]
            ];
            
            totaisPrincipais.forEach(([label, valor]) => {
                const isMoeda = label.includes('Valor') || label.includes('Comiss') || label.includes('Taxa') || label.includes('Adquirente');
                const valorFormatado = isMoeda ? 
                    `R$ ${formatarMoeda(valor)}` : 
                    formatarNumero(valor);
                
                doc.text(`${label}: ${valorFormatado}`, margin, yPos);
                yPos += 3.5;
            });
            
            // Rodap√©
            yPos = 290;
            doc.setFontSize(6);
            doc.setFont('helvetica', 'italic');
            doc.text('Sistema B2B Reservas - Relat√≥rio de Filipeta', pageWidth / 2, yPos, { align: 'center' });
            yPos += 3;
            doc.text(`Total de ${transacoesAprovadas.length} transa√ß√µes aprovadas listadas`, pageWidth / 2, yPos, { align: 'center' });
            
            const fileName = `filipeta_impressora_aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Filipeta para impressora gerada: ${fileName}`, 'success');
        }
        
        // NOVA FUN√á√ÉO: Gerar PDF Relat√≥rio de Recebimentos - APENAS APROVADAS
        function gerarPDFRelatorioRecebimentos() {
            const dataRelatorioFormatada = obterDataRelatorio();
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üí∞ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DE RECEBIMENTOS - APROVADAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.text(`Data de refer√™ncia: ${dataRelatorioFormatada}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 15, yPos - 10, { align: 'right' });
            yPos += 10;
            
            // Calcular estat√≠sticas de recebimento - APENAS APROVADAS
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            let totalRecebidoValor = 0;
            let totalAReceberValor = 0;
            let totalVencidoValor = 0;
            
            // Agrupar por cart√£o - APENAS APROVADAS
            const cartoesMap = new Map();
            
            transacoesAprovadas.forEach(registro => {
                const numeroCartao = registro['N√∫mero do Cartao'] || 'Sem Cart√£o';
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                const dataRecebimento = parsearData(registro['Data Recebimento']);
                
                if (!cartoesMap.has(numeroCartao)) {
                    cartoesMap.set(numeroCartao, {
                        numero: numeroCartao,
                        bandeira: registro['Bandeira do Cartao'] || 'N/A',
                        valorTotal: 0,
                        valorRecebido: 0,
                        valorAReceber: 0,
                        valorVencido: 0,
                        transacoes: []
                    });
                }
                
                const cartao = cartoesMap.get(numeroCartao);
                cartao.valorTotal += valorTotal;
                
                if (dataRecebimento) {
                    const dataReceb = new Date(dataRecebimento);
                    dataReceb.setHours(0, 0, 0, 0);
                    
                    if (dataReceb <= hoje) {
                        totalRecebidoValor += valorTotal;
                        cartao.valorRecebido += valorTotal;
                    } else {
                        totalAReceberValor += valorTotal;
                        cartao.valorAReceber += valorTotal;
                        
                        // Verificar se est√° vencido
                        const dataTransacao = parsearData(registro['Data Transacao']);
                        if (dataTransacao) {
                            const diferencaDias = Math.floor((hoje - dataTransacao) / (1000 * 60 * 60 * 24));
                            if (diferencaDias > 30) {
                                totalVencidoValor += valorTotal;
                                cartao.valorVencido += valorTotal;
                            }
                        }
                    }
                } else {
                    totalAReceberValor += valorTotal;
                    cartao.valorAReceber += valorTotal;
                }
            });
            
            // Resumo estat√≠stico
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO ESTAT√çSTICO (APROVADAS)', 15, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const estatisticas = [
                ['Total J√° Recebido:', `R$ ${formatarMoeda(totalRecebidoValor)}`],
                ['Total a Receber:', `R$ ${formatarMoeda(totalAReceberValor)}`],
                ['Total Vencido:', `R$ ${formatarMoeda(totalVencidoValor)}`],
                ['Cart√µes Analisados:', cartoesMap.size],
                ['Transa√ß√µes Aprovadas:', transacoesAprovadas.length]
            ];
            
            estatisticas.forEach(([label, valor]) => {
                doc.text(`‚Ä¢ ${label} ${valor}`, 20, yPos);
                yPos += 5;
            });
            
            yPos += 10;
            
            // Tabela de cart√µes
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('DETALHAMENTO POR CART√ÉO', 15, yPos);
            yPos += 7;
            
            // Converter Map para array e ordenar por valor total (decrescente)
            const cartoesArray = Array.from(cartoesMap.values());
            cartoesArray.sort((a, b) => b.valorTotal - a.valorTotal);
            
            const headers = ['Cart√£o', 'Bandeira', 'Total (R$)', 'Recebido (R$)', 'A Receber (R$)', 'Vencido (R$)', 'Status'];
            const data = cartoesArray.map(cartao => {
                // Determinar status principal
                let status = 'A Receber';
                if (cartao.valorRecebido > 0 && cartao.valorAReceber === 0) {
                    status = 'Recebido';
                } else if (cartao.valorVencido > 0) {
                    status = 'Vencido';
                }
                
                return [
                    formatarNumeroCartao(cartao.numero),
                    cartao.bandeira,
                    formatarMoeda(cartao.valorTotal),
                    formatarMoeda(cartao.valorRecebido),
                    formatarMoeda(cartao.valorAReceber),
                    formatarMoeda(cartao.valorVencido),
                    status
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255, fontSize: 9, fontStyle: 'bold' },
                bodyStyles: { fontSize: 8, cellPadding: 2 },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            const fileName = `recebimentos_aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Relat√≥rio de recebimentos de aprovadas gerado: ${fileName}`, 'success');
        }
        
        // NOVA FUN√á√ÉO: Imprimir Relat√≥rio de Recebimentos - APENAS APROVADAS
        function imprimirRelatorioRecebimentos() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para imprimir', 'error');
                return;
            }
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            // Calcular estat√≠sticas de recebimento
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            let totalRecebidoValor = 0;
            let totalAReceberValor = 0;
            let totalVencidoValor = 0;
            
            // Agrupar por cart√£o - APENAS APROVADAS
            const cartoesMap = new Map();
            
            transacoesAprovadas.forEach(registro => {
                const numeroCartao = registro['N√∫mero do Cartao'] || 'Sem Cart√£o';
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                const dataRecebimento = parsearData(registro['Data Recebimento']);
                
                if (!cartoesMap.has(numeroCartao)) {
                    cartoesMap.set(numeroCartao, {
                        numero: numeroCartao,
                        bandeira: registro['Bandeira do Cartao'] || 'N/A',
                        valorTotal: 0,
                        valorRecebido: 0,
                        valorAReceber: 0,
                        valorVencido: 0,
                        transacoes: []
                    });
                }
                
                const cartao = cartoesMap.get(numeroCartao);
                cartao.valorTotal += valorTotal;
                
                if (dataRecebimento) {
                    const dataReceb = new Date(dataRecebimento);
                    dataReceb.setHours(0, 0, 0, 0);
                    
                    if (dataReceb <= hoje) {
                        totalRecebidoValor += valorTotal;
                        cartao.valorRecebido += valorTotal;
                    } else {
                        totalAReceberValor += valorTotal;
                        cartao.valorAReceber += valorTotal;
                        
                        // Verificar se est√° vencido
                        const dataTransacao = parsearData(registro['Data Transacao']);
                        if (dataTransacao) {
                            const diferencaDias = Math.floor((hoje - dataTransacao) / (1000 * 60 * 60 * 24));
                            if (diferencaDias > 30) {
                                totalVencidoValor += valorTotal;
                                cartao.valorVencido += valorTotal;
                            }
                        }
                    }
                } else {
                    totalAReceberValor += valorTotal;
                    cartao.valorAReceber += valorTotal;
                }
            });
            
            // Converter Map para array e ordenar por valor total (decrescente)
            const cartoesArray = Array.from(cartoesMap.values());
            cartoesArray.sort((a, b) => b.valorTotal - a.valorTotal);
            
            // Criar conte√∫do HTML para impress√£o
            let conteudoHTML = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Relat√≥rio de Recebimentos - B2B Reservas</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 20mm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            color: #333;
                        }
                        .print-container {
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .print-header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .print-header h1 {
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            font-size: 24px;
                        }
                        .print-header .subtitle {
                            color: #7f8c8d;
                            font-size: 16px;
                        }
                        .print-date {
                            text-align: right;
                            margin-bottom: 20px;
                            color: #7f8c8d;
                            font-size: 14px;
                        }
                        .print-summary {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        .summary-card {
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            color: white;
                            font-weight: bold;
                        }
                        .summary-recebido {
                            background-color: #27ae60;
                        }
                        .summary-a-receber {
                            background-color: #9b59b6;
                        }
                        .summary-vencido {
                            background-color: #e74c3c;
                        }
                        .summary-value {
                            font-size: 24px;
                            margin-bottom: 5px;
                        }
                        .summary-label {
                            font-size: 14px;
                            opacity: 0.9;
                        }
                        .print-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        .print-table th {
                            background-color: #2c3e50;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                            border: 1px solid #ddd;
                        }
                        .print-table td {
                            padding: 10px;
                            border: 1px solid #ddd;
                            text-align: left;
                        }
                        .print-table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .status-recebido {
                            color: #27ae60;
                            font-weight: bold;
                        }
                        .status-a-receber {
                            color: #9b59b6;
                            font-weight: bold;
                        }
                        .status-vencido {
                            color: #e74c3c;
                            font-weight: bold;
                        }
                        .currency {
                            text-align: right;
                            font-family: 'Courier New', monospace;
                        }
                        .print-footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            color: #7f8c8d;
                            font-size: 12px;
                        }
                        .page-break {
                            page-break-before: always;
                        }
                        @media print {
                            .no-print {
                                display: none !important;
                            }
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        <div class="print-header">
                            <h1>üí∞ B2B RESERVAS - RELAT√ìRIO DE RECEBIMENTOS</h1>
                            <div class="subtitle">An√°lise detalhada de recebimentos por cart√£o (APENAS APROVADAS)</div>
                        </div>
                        
                        <div class="print-date">
                            Data de refer√™ncia: ${formatarDataParaExibicao(hoje)}<br>
                            Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}
                        </div>
                        
                        <div class="print-summary">
                            <div class="summary-card summary-recebido">
                                <div class="summary-value">R$ ${formatarMoeda(totalRecebidoValor)}</div>
                                <div class="summary-label">J√Å RECEBIDO</div>
                            </div>
                            <div class="summary-card summary-a-receber">
                                <div class="summary-value">R$ ${formatarMoeda(totalAReceberValor)}</div>
                                <div class="summary-label">A RECEBER</div>
                            </div>
                            <div class="summary-card summary-vencido">
                                <div class="summary-value">R$ ${formatarMoeda(totalVencidoValor)}</div>
                                <div class="summary-label">VENCIDO</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; font-size: 14px;">
                            <strong>Resumo:</strong> ${cartoesMap.size} cart√£o(s) analisado(s) | ${transacoesAprovadas.length} transa√ß√£o(√µes) aprovada(s)
                        </div>
                        
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Cart√£o</th>
                                    <th>Bandeira</th>
                                    <th>Total (R$)</th>
                                    <th>Recebido (R$)</th>
                                    <th>A Receber (R$)</th>
                                    <th>Vencido (R$)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Adicionar linhas da tabela
            cartoesArray.forEach((cartao, index) => {
                // Determinar status principal
                let status = 'A Receber';
                let statusClass = 'status-a-receber';
                
                if (cartao.valorRecebido > 0 && cartao.valorAReceber === 0) {
                    status = 'Recebido';
                    statusClass = 'status-recebido';
                } else if (cartao.valorVencido > 0) {
                    status = 'Vencido';
                    statusClass = 'status-vencido';
                }
                
                conteudoHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatarNumeroCartao(cartao.numero)}</td>
                        <td>${cartao.bandeira}</td>
                        <td class="currency">${formatarMoeda(cartao.valorTotal)}</td>
                        <td class="currency">${formatarMoeda(cartao.valorRecebido)}</td>
                        <td class="currency">${formatarMoeda(cartao.valorAReceber)}</td>
                        <td class="currency">${formatarMoeda(cartao.valorVencido)}</td>
                        <td class="${statusClass}">${status}</td>
                    </tr>
                `;
            });
            
            // Adicionar linha de totais
            conteudoHTML += `
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background-color: #f2f2f2;">
                                    <td colspan="3" style="text-align: right;">TOTAIS:</td>
                                    <td class="currency">${formatarMoeda(cartoesArray.reduce((sum, c) => sum + c.valorTotal, 0))}</td>
                                    <td class="currency">${formatarMoeda(totalRecebidoValor)}</td>
                                    <td class="currency">${formatarMoeda(totalAReceberValor)}</td>
                                    <td class="currency">${formatarMoeda(totalVencidoValor)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="print-footer">
                            <p>Sistema B2B Reservas - Relat√≥rio de Recebimentos (APENAS APROVADAS)</p>
                            <p>P√°gina 1 de 1 | Total de ${cartoesArray.length} cart√µes listados</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Abrir nova janela para impress√£o
            const janelaImpressao = window.open('', '_blank');
            janelaImpressao.document.write(conteudoHTML);
            janelaImpressao.document.close();
            
            // Esperar o conte√∫do carregar e ent√£o imprimir
            janelaImpressao.onload = function() {
                janelaImpressao.focus();
                janelaImpressao.print();
                janelaImpressao.onafterprint = function() {
                    janelaImpressao.close();
                };
            };
            
            mostrarNotificacao('Relat√≥rio de recebimentos (apenas aprovadas) pronto para impress√£o', 'success');
        }
        
        // Gerar filipetas individuais - APENAS APROVADAS
        function gerarTodasFilipetas() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para gerar filipetas', 'error');
                return;
            }
            
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    // Aplicar ordena√ß√£o atual antes de gerar
                    aplicarOrdenacao();
                    
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 150]
                    });
                    
                    transacoesAprovadas.forEach((registro, index) => {
                        if (index > 0) doc.addPage([80, 150]);
                        
                        doc.setFont('helvetica');
                        doc.setFontSize(12);
                        doc.text('B2B RESERVAS', 40, 10, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.text('COMPROVANTE DE VENDA - APROVADA', 40, 15, { align: 'center' });
                        
                        let yPos = 25;
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Transa√ß√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Data Transacao'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Status:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro.Status || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor Total:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor L√≠quido:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Cart√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['N√∫mero do Cartao'] || '', 25, yPos);
                        yPos += 7;
                        
                        // Detalhes financeiros
                        doc.setFontSize(7);
                        doc.text('Detalhes Financeiros:', 5, yPos);
                        yPos += 4;
                        
                        doc.text(`‚Ä¢ Di√°rias: ${formatarNumero(registro['Total Diarias_NUM'] || 0)}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Comiss√µes: R$ ${formatarMoeda(registro['Comissoes_NUM'] || 0)}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Taxa B2B: R$ ${formatarMoeda(registro['Taxa de Servico B2B_NUM'] || 0)}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Adquirente: R$ ${formatarMoeda(registro['Valor Adquirencia_NUM'] || 0)}`, 10, yPos);
                        yPos += 5;
                        
                        // Status de recebimento (NOVO)
                        const dataRecebimento = parsearData(registro['Data Recebimento']);
                        const hoje = new Date();
                        hoje.setHours(0, 0, 0, 0);
                        
                        doc.text('Status de Recebimento:', 5, yPos);
                        yPos += 4;
                        
                        if (dataRecebimento) {
                            const dataReceb = new Date(dataRecebimento);
                            dataReceb.setHours(0, 0, 0, 0);
                            
                            if (dataReceb <= hoje) {
                                doc.setTextColor(46, 204, 113);
                                doc.text('‚úÖ J√° Recebido', 10, yPos);
                            } else {
                                doc.setTextColor(241, 196, 15);
                                doc.text('‚è≥ A Receber', 10, yPos);
                            }
                            doc.setTextColor(0, 0, 0);
                            yPos += 3.5;
                            
                            doc.text(`Data Recebimento: ${registro['Data Recebimento'] || 'N/A'}`, 10, yPos);
                            yPos += 3.5;
                        } else {
                            doc.setTextColor(155, 89, 182);
                            doc.text('üìÖ Sem data de recebimento', 10, yPos);
                            doc.setTextColor(0, 0, 0);
                            yPos += 3.5;
                        }
                        
                        // Rodap√©
                        doc.setFontSize(6);
                        doc.text('Sistema B2B Reservas - Comprovante n√£o fiscal', 40, 140, { align: 'center' });
                        doc.text(dayjs().format('DD/MM/YYYY HH:mm:ss'), 40, 143, { align: 'center' });
                        doc.text(`Transa√ß√£o ${index + 1} de ${transacoesAprovadas.length}`, 40, 146, { align: 'center' });
                    });
                    
                    const fileName = `filipetas_aprovadas_${dayjs().format('YYYY-MM-DD')}.pdf`;
                    doc.save(fileName);
                    mostrarNotificacao(`${transacoesAprovadas.length} filipetas de transa√ß√µes aprovadas geradas!`, 'success');
                    
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Fun√ß√µes utilit√°rias
        function mostrarLoading(mostrar) {
            loadingOverlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) notifAnterior.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${tipo}`;
            notification.innerHTML = `<strong>${tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong> ${mensagem}`;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
    </script>
</body>
</html>

7 a 08 d s
