<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Reservas - Sistema de Relat√≥rios PDF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a6fa5;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .app-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload {
            border: 2px dashed #3498db;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background-color: white;
        }

        .file-upload:hover {
            background-color: #e8f4fc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .file-upload input {
            display: none;
        }

        .upload-label {
            font-size: 1.4rem;
            color: #3498db;
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .file-info {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 1.2rem;
            padding: 16px 32px;
        }

        .btn-pdf:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            color: white;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card:nth-child(2) {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .summary-card:nth-child(3) {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .summary-card:nth-child(4) {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .data-preview {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-preview th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-preview td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .data-preview tr:hover {
            background-color: #f8f9fa;
        }

        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .status-aprovada {
            color: #27ae60;
            font-weight: bold;
        }

        .status-cancelada {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-pendente {
            color: #f39c12;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .pdf-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .pdf-option-group {
            margin-bottom: 25px;
        }

        .pdf-option-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
        }

        .notification-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .report-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-type-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .report-type-btn.active {
            border-color: #3498db;
            background-color: #e8f4fc;
            color: #3498db;
            font-weight: bold;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .pdf-options-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .report-type-selector {
                flex-direction: column;
            }
            
            .report-type-btn {
                min-width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/locale/pt-br.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¶ SISTEMA DE RELAT√ìRIOS B2B RESERVAS</h1>
            <p class="subtitle">Gere filipetas de vendas POS e relat√≥rios detalhados</p>
        </header>

        <section class="app-section">
            <h2>üìÅ 1. CARREGAR ARQUIVO</h2>
            <div class="file-upload" id="dropArea">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                <label for="fileInput" class="upload-label">
                    üìÇ CLIQUE PARA SELECIONAR OU ARRASTE SEU ARQUIVO
                </label>
                <p class="file-info">Formatos suportados: CSV, Excel (XLSX, XLS)</p>
                <p id="fileName" class="file-info">‚ö†Ô∏è Nenhum arquivo selecionado</p>
            </div>
            
            <div id="dataPreview" class="data-preview">
                <h3>üìã Pr√©-visualiza√ß√£o dos Dados</h3>
                <table id="previewTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Data Transacao</th>
                            <th>Valor Total</th>
                            <th>Valor L√≠quido</th>
                            <th>Cart√£o</th>
                            <th>Di√°rias</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
                <div id="dataStats" class="data-stats"></div>
            </div>
        </section>

        <section class="app-section">
            <h2>üîç 2. FILTRAR DADOS</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterStatus">üìä Status</label>
                    <select id="filterStatus">
                        <option value="">Todos os Status</option>
                        <option value="Aprovada">‚úÖ Aprovada</option>
                        <option value="Cancelada">‚ùå Cancelada</option>
                        <option value="Pendente">‚è≥ Pendente</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterDataInicio">üìÖ Data Transa√ß√£o (De)</label>
                    <input type="date" id="filterDataInicio">
                </div>

                <div class="filter-group">
                    <label for="filterDataFim">üìÖ Data Transa√ß√£o (At√©)</label>
                    <input type="date" id="filterDataFim">
                </div>

                <div class="filter-group">
                    <label for="filterValorMin">üí∞ Valor M√≠nimo (R$)</label>
                    <input type="number" id="filterValorMin" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterValorMax">üí∞ Valor M√°ximo (R$)</label>
                    <input type="number" id="filterValorMax" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterBandeira">üí≥ Bandeira do Cart√£o</label>
                    <select id="filterBandeira">
                        <option value="">Todas as Bandeiras</option>
                        <option value="VISA">VISA</option>
                        <option value="MASTERCARD">MASTERCARD</option>
                        <option value="ELO">ELO</option>
                        <option value="AMEX">AMERICAN EXPRESS</option>
                    </select>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-primary" id="btnFiltrar">üîç APLICAR FILTROS</button>
                <button class="btn-secondary" id="btnLimparFiltros">üóëÔ∏è LIMPAR FILTROS</button>
                <button class="btn-danger" id="btnExportarExcel">üíæ EXPORTAR CSV</button>
            </div>
        </section>

        <section class="app-section">
            <h2>üìä 3. RESUMO DO RELAT√ìRIO</h2>
            <div class="summary-grid" id="resumo">
                <div class="summary-card">
                    <div class="summary-value" id="totalTransacoes">0</div>
                    <div class="summary-label">Transa√ß√µes</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorTotal">R$ 0,00</div>
                    <div class="summary-label">Valor Total</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorLiquido">R$ 0,00</div>
                    <div class="summary-label">Valor L√≠quido</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="diariasTotal">0</div>
                    <div class="summary-label">Di√°rias Totais</div>
                </div>
            </div>
        </section>

        <section class="app-section">
            <h2>üìÑ 4. GERAR RELAT√ìRIOS</h2>
            
            <div class="report-type-selector">
                <div class="report-type-btn active" id="btnFilipeta">üè∑Ô∏è FILIPETA POS</div>
                <div class="report-type-btn" id="btnRelatorioDetalhado">üìä RELAT√ìRIO DETALHADO</div>
                <div class="report-type-btn" id="btnResumoAprovadas">‚úÖ RESUMO APROVADAS</div>
            </div>
            
            <p style="margin-bottom: 20px; font-size: 1.1rem; color: #2c3e50;">
                <strong>üéØ Filipeta POS:</strong> Relat√≥rio simplificado para confer√™ncia di√°ria.<br>
                <strong>üìä Relat√≥rio Detalhado:</strong> Todos os campos em formato paisagem.<br>
                <strong>‚úÖ Resumo Aprovadas:</strong> Todas transa√ß√µes aprovadas para impress√£o.
            </p>
            
            <div class="buttons">
                <button class="btn-pdf" id="btnGerarPDF">üìä GERAR RELAT√ìRIO</button>
                <button class="btn-primary" id="btnConfigPDF">‚öôÔ∏è CONFIGURA√á√ïES</button>
                <button class="btn-secondary" id="btnGerarTodasFilipetas">üñ®Ô∏è FILIPETAS INDIVIDUAIS</button>
            </div>
        </section>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è CONFIGURA√á√ïES DO RELAT√ìRIO</h2>
                <span class="close-modal" id="closeModal">√ó</span>
            </div>
            
            <div class="pdf-options-grid">
                <div class="pdf-option-group">
                    <label for="pdfTitle">üìù T√≠tulo do Relat√≥rio:</label>
                    <input type="text" id="pdfTitle" value="RELAT√ìRIO DE VENDAS B2B RESERVAS">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfSubtitle">üìù Subt√≠tulo:</label>
                    <input type="text" id="pdfSubtitle" value="Filipeta POS - Transa√ß√µes Detalhadas">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfFontSize">üî§ Tamanho da Fonte:</label>
                    <select id="pdfFontSize">
                        <option value="8">Pequeno (8pt)</option>
                        <option value="9" selected>Normal (9pt)</option>
                        <option value="10">Grande (10pt)</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfIncludeSummary">üìä Incluir Resumo:</label>
                    <select id="pdfIncludeSummary">
                        <option value="true" selected>‚úÖ Sim</option>
                        <option value="false">‚ùå N√£o</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfOrientation">üìê Orienta√ß√£o:</label>
                    <select id="pdfOrientation">
                        <option value="portrait">üìÑ Retrato</option>
                        <option value="landscape" selected>üèûÔ∏è Paisagem</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons" style="margin-top: 30px; border: none;">
                <button class="btn-pdf" id="btnGerarPDFConfirmar">üìä GERAR PDF</button>
                <button class="btn-secondary" id="btnCancelarPDF">‚Ü©Ô∏è CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; font-size: 1.2rem;">Processando dados...</p>
    </div>

    <script>
        // Configura√ß√µes
        dayjs.locale('pt-br');
        window.jsPDF = window.jspdf.jsPDF;
        
        // Campos esperados
        const CAMPOS_ESPERADOS = [
            'Status', 'Data Transacao', 'Data Recebimento', 'Total Diarias', 
            'Valor Extras', 'Valor Taxas', 'Valor Impostos', 'Valor total da transacao', 
            'Tarifa', 'Comissoes', 'Taxa de Servico B2B', 'Valor Adquirencia', 
            'Valor Liquido', 'N√∫mero do Cartao', 'Bandeira do Cartao'
        ];
        
        // Vari√°veis globais
        let dadosOriginais = [];
        let dadosFiltrados = [];
        let tipoRelatorioAtual = 'filipeta';
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const fileName = document.getElementById('fileName');
        const dataPreview = document.getElementById('dataPreview');
        const previewBody = document.getElementById('previewBody');
        const dataStats = document.getElementById('dataStats');
        const pdfModal = document.getElementById('pdfModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Filtros
        const filterStatus = document.getElementById('filterStatus');
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        const filterValorMin = document.getElementById('filterValorMin');
        const filterValorMax = document.getElementById('filterValorMax');
        const filterBandeira = document.getElementById('filterBandeira');
        
        // Bot√µes
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnLimparFiltros = document.getElementById('btnLimparFiltros');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnGerarPDF = document.getElementById('btnGerarPDF');
        const btnConfigPDF = document.getElementById('btnConfigPDF');
        const btnGerarTodasFilipetas = document.getElementById('btnGerarTodasFilipetas');
        const btnGerarPDFConfirmar = document.getElementById('btnGerarPDFConfirmar');
        const btnCancelarPDF = document.getElementById('btnCancelarPDF');
        const closeModal = document.getElementById('closeModal');
        
        // Configura√ß√µes PDF
        const pdfTitle = document.getElementById('pdfTitle');
        const pdfSubtitle = document.getElementById('pdfSubtitle');
        const pdfFontSize = document.getElementById('pdfFontSize');
        const pdfIncludeSummary = document.getElementById('pdfIncludeSummary');
        const pdfOrientation = document.getElementById('pdfOrientation');
        
        // Resumo
        const totalTransacoes = document.getElementById('totalTransacoes');
        const valorTotal = document.getElementById('valorTotal');
        const valorLiquido = document.getElementById('valorLiquido');
        const diariasTotal = document.getElementById('diariasTotal');
        
        // Bot√µes de tipo de relat√≥rio
        const btnFilipeta = document.getElementById('btnFilipeta');
        const btnRelatorioDetalhado = document.getElementById('btnRelatorioDetalhado');
        const btnResumoAprovadas = document.getElementById('btnResumoAprovadas');
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', inicializarApp);
        fileInput.addEventListener('change', handleFileUpload);
        btnFiltrar.addEventListener('click', aplicarFiltros);
        btnLimparFiltros.addEventListener('click', limparFiltros);
        btnExportarExcel.addEventListener('click', exportarParaExcel);
        btnGerarPDF.addEventListener('click', abrirModalPDF);
        btnConfigPDF.addEventListener('click', abrirModalPDF);
        btnGerarTodasFilipetas.addEventListener('click', gerarTodasFilipetas);
        btnGerarPDFConfirmar.addEventListener('click', gerarPDF);
        btnCancelarPDF.addEventListener('click', fecharModalPDF);
        closeModal.addEventListener('click', fecharModalPDF);
        
        btnFilipeta.addEventListener('click', () => selecionarTipoRelatorio('filipeta'));
        btnRelatorioDetalhado.addEventListener('click', () => selecionarTipoRelatorio('detalhado'));
        btnResumoAprovadas.addEventListener('click', () => selecionarTipoRelatorio('aprovadas'));
        
        window.addEventListener('click', (e) => { if (e.target === pdfModal) fecharModalPDF(); });
        
        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '#e8f4fc');
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '');
        });
        
        dropArea.addEventListener('drop', handleDrop);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                fileInput.files = files;
                handleFileUpload();
            }
        }
        
        // Inicializa√ß√£o
        function inicializarApp() {
            const hoje = dayjs();
            const primeiroDiaMes = hoje.startOf('month');
            filterDataInicio.value = primeiroDiaMes.format('YYYY-MM-DD');
            filterDataFim.value = hoje.format('YYYY-MM-DD');
            console.log('‚úÖ Sistema B2B PDF inicializado!');
        }
        
        // Fun√ß√µes principais
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            fileName.textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            fileName.style.color = '#27ae60';
            
            mostrarLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const extensao = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                    const data = e.target.result;
                    
                    if (extensao === '.csv') {
                        processarCSV(data);
                    } else {
                        processarExcel(data);
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                    console.error(error);
                    limparDados();
                } finally {
                    mostrarLoading(false);
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        function processarExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    mostrarNotificacao('Arquivo vazio ou inv√°lido', 'error');
                    return;
                }
                
                const cabecalhos = jsonData[0];
                dadosOriginais = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const linha = jsonData[i];
                    if (!linha || linha.length === 0) continue;
                    
                    const registro = {};
                    cabecalhos.forEach((cabecalho, index) => {
                        let valor = linha[index];
                        if (valor instanceof Date) {
                            valor = dayjs(valor).format('DD/MM/YYYY HH:mm:ss');
                        } else if (valor !== undefined && valor !== null) {
                            valor = String(valor).trim();
                        } else {
                            valor = '';
                        }
                        
                        const nomeCampo = normalizarCampo(cabecalho);
                        registro[nomeCampo] = valor;
                    });
                    
                    if (registro['Data Transacao'] && registro['Valor total da transacao']) {
                        converterValoresNumericos(registro);
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado', 'error');
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados!`, 'success');
                
            } catch (error) {
                mostrarNotificacao('Erro ao processar Excel', 'error');
                console.error(error);
            }
        }
        
        function processarCSV(content) {
            try {
                const linhas = content.split('\n');
                if (linhas.length < 2) {
                    mostrarNotificacao('CSV vazio ou inv√°lido', 'error');
                    return;
                }
                
                const separador = linhas[0].includes(';') ? ';' : ',';
                const cabecalhos = parseCSVLine(linhas[0], separador);
                dadosOriginais = [];
                
                for (let i = 1; i < linhas.length; i++) {
                    if (linhas[i].trim() === '') continue;
                    
                    const valores = parseCSVLine(linhas[i], separador);
                    const registro = {};
                    
                    cabecalhos.forEach((cabecalho, index) => {
                        const nomeCampo = normalizarCampo(cabecalho);
                        registro[nomeCampo] = valores[index] ? valores[index].trim() : '';
                    });
                    
                    if (registro['Data Transacao'] && registro['Valor total da transacao']) {
                        converterValoresNumericos(registro);
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado', 'error');
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados!`, 'success');
                
            } catch (error) {
                mostrarNotificacao('Erro ao processar CSV', 'error');
                console.error(error);
            }
        }
        
        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.replace(/^"+|"+$/g, ''));
        }
        
        function normalizarCampo(nome) {
            const nomeLower = String(nome).toLowerCase().trim();
            
            const mapeamentos = {
                'status': 'Status',
                'data transacao': 'Data Transacao',
                'data recebimento': 'Data Recebimento',
                'total diarias': 'Total Diarias',
                'valor extras': 'Valor Extras',
                'valor taxas': 'Valor Taxas',
                'valor impostos': 'Valor Impostos',
                'valor total da transacao': 'Valor total da transacao',
                'tarifa': 'Tarifa',
                'comissoes': 'Comissoes',
                'taxa de servico b2b': 'Taxa de Servico B2B',
                'valor adquirencia': 'Valor Adquirencia',
                'valor liquido': 'Valor Liquido',
                'numero do cartao': 'N√∫mero do Cartao',
                'bandeira do cartao': 'Bandeira do Cartao'
            };
            
            for (const [chave, valor] of Object.entries(mapeamentos)) {
                if (nomeLower.includes(chave) || chave.includes(nomeLower)) {
                    return valor;
                }
            }
            
            return nome;
        }
        
        function converterValoresNumericos(registro) {
            const camposNumericos = [
                'Total Diarias', 'Valor Extras', 'Valor Taxas', 'Valor Impostos',
                'Valor total da transacao', 'Comissoes', 'Taxa de Servico B2B',
                'Valor Adquirencia', 'Valor Liquido'
            ];
            
            camposNumericos.forEach(campo => {
                if (registro[campo] && registro[campo] !== '') {
                    let valorStr = String(registro[campo])
                        .replace(/[R$\s]/g, '')
                        .replace(/\./g, '')
                        .replace(',', '.')
                        .trim();
                    
                    const valor = parseFloat(valorStr);
                    if (!isNaN(valor)) {
                        registro[`${campo}_NUM`] = valor;
                    } else {
                        registro[`${campo}_NUM`] = 0;
                    }
                } else {
                    registro[`${campo}_NUM`] = 0;
                }
            });
        }
        
        function mostrarPreviaDados() {
            if (dadosOriginais.length === 0) {
                dataPreview.style.display = 'none';
                return;
            }
            
            dataPreview.style.display = 'block';
            previewBody.innerHTML = '';
            
            const limite = Math.min(10, dadosOriginais.length);
            
            for (let i = 0; i < limite; i++) {
                const registro = dadosOriginais[i];
                const tr = document.createElement('tr');
                
                let statusClass = 'status-' + (registro.Status || '').toLowerCase();
                if (!['status-aprovada', 'status-cancelada', 'status-pendente'].includes(statusClass)) {
                    statusClass = '';
                }
                
                tr.innerHTML = `
                    <td class="${statusClass}">${registro.Status || 'N/A'}</td>
                    <td>${registro['Data Transacao'] || 'N/A'}</td>
                    <td class="currency">R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}</td>
                    <td class="currency">R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}</td>
                    <td>${registro['N√∫mero do Cartao'] || 'N/A'}</td>
                    <td>${formatarNumero(registro['Total Diarias_NUM'] || 0)}</td>
                `;
                
                previewBody.appendChild(tr);
            }
            
            atualizarEstatisticasPrevia();
        }
        
        function atualizarEstatisticasPrevia() {
            const total = dadosOriginais.length;
            const aprovadas = dadosOriginais.filter(r => r.Status === 'Aprovada').length;
            const canceladas = dadosOriginais.filter(r => r.Status === 'Cancelada').length;
            const valorTotalSum = dadosOriginais.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorMedio = total > 0 ? valorTotalSum / total : 0;
            
            dataStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total de Transa√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${aprovadas}</div>
                    <div class="stat-label">Aprovadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${canceladas}</div>
                    <div class="stat-label">Canceladas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">R$ ${formatarMoeda(valorMedio)}</div>
                    <div class="stat-label">Valor M√©dio</div>
                </div>
            `;
        }
        
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatarNumero(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function atualizarFiltrosBandeira() {
            const bandeiras = new Set();
            dadosOriginais.forEach(r => {
                if (r['Bandeira do Cartao']) bandeiras.add(r['Bandeira do Cartao'].trim());
            });
            
            while (filterBandeira.options.length > 1) filterBandeira.remove(1);
            
            Array.from(bandeiras).sort().forEach(bandeira => {
                const option = document.createElement('option');
                option.value = bandeira;
                option.textContent = bandeira;
                filterBandeira.appendChild(option);
            });
        }
        
        function limparDados() {
            dadosOriginais = [];
            dadosFiltrados = [];
            dataPreview.style.display = 'none';
            atualizarResumo();
        }
        
        function aplicarFiltros() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('Carregue um arquivo primeiro', 'error');
                return;
            }
            
            dadosFiltrados = dadosOriginais.filter(registro => {
                if (filterStatus.value && registro.Status !== filterStatus.value) return false;
                
                if (filterBandeira.value && registro['Bandeira do Cartao'] !== filterBandeira.value) return false;
                
                const dataTransacao = parsearData(registro['Data Transacao']);
                if (filterDataInicio.value && dataTransacao) {
                    const dataInicio = new Date(filterDataInicio.value);
                    if (dataTransacao < dataInicio) return false;
                }
                
                if (filterDataFim.value && dataTransacao) {
                    const dataFim = new Date(filterDataFim.value);
                    dataFim.setHours(23, 59, 59, 999);
                    if (dataTransacao > dataFim) return false;
                }
                
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                if (filterValorMin.value && valorTotal < parseFloat(filterValorMin.value)) return false;
                if (filterValorMax.value && valorTotal > parseFloat(filterValorMax.value)) return false;
                
                return true;
            });
            
            atualizarResumo();
            mostrarNotificacao(`${dadosFiltrados.length} transa√ß√µes encontradas`, 'success');
        }
        
        function parsearData(dataString) {
            if (!dataString) return null;
            try {
                if (dataString.includes('/')) {
                    const [datePart, timePart] = dataString.split(' ');
                    const [day, month, year] = datePart.split('/');
                    if (timePart) {
                        const [hours, minutes, seconds] = timePart.split(':');
                        return new Date(year, month - 1, day, hours || 0, minutes || 0, seconds || 0);
                    }
                    return new Date(year, month - 1, day);
                } else if (dataString.includes('-')) {
                    return new Date(dataString);
                }
                return null;
            } catch (error) {
                console.error('Erro ao parsear data:', error);
                return null;
            }
        }
        
        function limparFiltros() {
            filterStatus.value = '';
            filterDataInicio.value = '';
            filterDataFim.value = '';
            filterValorMin.value = '';
            filterValorMax.value = '';
            filterBandeira.value = '';
            
            dadosFiltrados = [...dadosOriginais];
            atualizarResumo();
            mostrarNotificacao('Filtros limpos', 'success');
        }
        
        function atualizarResumo() {
            if (dadosFiltrados.length === 0) {
                totalTransacoes.textContent = '0';
                valorTotal.textContent = 'R$ 0,00';
                valorLiquido.textContent = 'R$ 0,00';
                diariasTotal.textContent = '0';
                return;
            }
            
            const total = dadosFiltrados.length;
            const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            const diariasSum = dadosFiltrados.reduce((sum, r) => sum + (r['Total Diarias_NUM'] || 0), 0);
            
            totalTransacoes.textContent = total.toLocaleString('pt-BR');
            valorTotal.textContent = `R$ ${formatarMoeda(valorTotalSum)}`;
            valorLiquido.textContent = `R$ ${formatarMoeda(valorLiquidoSum)}`;
            diariasTotal.textContent = formatarNumero(diariasSum);
        }
        
        function exportarParaExcel() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para exportar', 'error');
                return;
            }
            
            const colunasExport = CAMPOS_ESPERADOS;
            const cabecalhos = colunasExport.join(';');
            const linhas = dadosFiltrados.map(registro => {
                return colunasExport.map(coluna => {
                    let valor = registro[coluna] || '';
                    if (valor.includes(';')) valor = `"${valor}"`;
                    return valor;
                }).join(';');
            });
            
            const conteudoCSV = [cabecalhos, ...linhas].join('\n');
            const blob = new Blob(['\uFEFF' + conteudoCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_b2b_${dayjs().format('YYYY-MM-DD')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('CSV exportado com sucesso!', 'success');
        }
        
        function selecionarTipoRelatorio(tipo) {
            tipoRelatorioAtual = tipo;
            
            [btnFilipeta, btnRelatorioDetalhado, btnResumoAprovadas].forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tipo === 'filipeta') btnFilipeta.classList.add('active');
            if (tipo === 'detalhado') btnRelatorioDetalhado.classList.add('active');
            if (tipo === 'aprovadas') btnResumoAprovadas.classList.add('active');
            
            const btnTexto = {
                'filipeta': 'GERAR FILIPETA POS',
                'detalhado': 'GERAR RELAT√ìRIO DETALHADO',
                'aprovadas': 'GERAR RESUMO APROVADAS'
            };
            
            btnGerarPDF.innerHTML = `üìä ${btnTexto[tipo]}`;
        }
        
        function abrirModalPDF() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('Carregue um arquivo primeiro', 'error');
                return;
            }
            pdfModal.style.display = 'block';
        }
        
        function fecharModalPDF() {
            pdfModal.style.display = 'none';
        }
        
        function gerarPDF() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para gerar relat√≥rio', 'error');
                return;
            }
            
            fecharModalPDF();
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    switch(tipoRelatorioAtual) {
                        case 'filipeta': gerarPDFFilipeta(); break;
                        case 'detalhado': gerarPDFDetalhado(); break;
                        case 'aprovadas': gerarPDFResumoAprovadas(); break;
                        default: gerarPDFFilipeta();
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        function gerarPDFFilipeta() {
            const doc = new jsPDF({
                orientation: pdfOrientation.value,
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üè¶ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('FILIPETA DE VENDAS POS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.text('Relat√≥rio para confer√™ncia di√°ria', pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dayjs().format('DD/MM/YYYY HH:mm:ss')}`, pageWidth - 15, yPos - 10, { align: 'right' });
            yPos += 10;
            
            // Tabela principal
            const headers = ['#', 'Data/Hora', 'Status', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = dadosFiltrados.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    registro.Status || '',
                    `R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`,
                    `R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255, fontSize: 9, fontStyle: 'bold' },
                bodyStyles: { fontSize: 8, cellPadding: 2 },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            const fileName = `filipeta_pos_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Filipeta gerada: ${fileName}`, 'success');
        }
        
        function gerarPDFDetalhado() {
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('üè¶ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DETALHADO', pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            
            // Tabela com todos os campos
            const headers = CAMPOS_ESPERADOS;
            const data = dadosFiltrados.map((registro, index) => {
                return headers.map(campo => {
                    let valor = registro[campo] || '';
                    if (campo.includes('Valor') || campo.includes('Total') || campo.includes('Comissoes') || campo.includes('Taxa')) {
                        const valorNum = registro[`${campo}_NUM`];
                        if (valorNum !== undefined) {
                            valor = `R$ ${formatarMoeda(valorNum)}`;
                        }
                    }
                    return valor;
                });
            });
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontSize: 8, fontStyle: 'bold' },
                bodyStyles: { fontSize: 7, cellPadding: 2 },
                margin: { left: 10, right: 10 }
            });
            
            const fileName = `relatorio_detalhado_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Relat√≥rio detalhado gerado: ${fileName}`, 'success');
        }
        
        function gerarPDFResumoAprovadas() {
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('N√£o h√° transa√ß√µes aprovadas', 'error');
                return;
            }
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('‚úÖ B2B RESERVAS', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('RELAT√ìRIO DE APROVADAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;
            
            // Tabela simplificada
            const headers = ['#', 'Data', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = transacoesAprovadas.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    `R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`,
                    `R$ ${formatarMoeda(registro['Valor Liquido_NUM'] || 0)}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [46, 204, 113], textColor: 255, fontSize: 9 },
                bodyStyles: { fontSize: 8 },
                margin: { left: 15, right: 15 }
            });
            
            const fileName = `aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            mostrarNotificacao(`Resumo de aprovadas gerado: ${fileName}`, 'success');
        }
        
        function gerarTodasFilipetas() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para gerar filipetas', 'error');
                return;
            }
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 150]
                    });
                    
                    dadosFiltrados.forEach((registro, index) => {
                        if (index > 0) doc.addPage([80, 150]);
                        
                        doc.setFont('helvetica');
                        doc.setFontSize(12);
                        doc.text('B2B RESERVAS', 40, 10, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.text('COMPROVANTE DE VENDA', 40, 15, { align: 'center' });
                        
                        let yPos = 25;
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Transa√ß√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Data Transacao'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Status:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro.Status || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor Total:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${formatarMoeda(registro['Valor total da transacao_NUM'] || 0)}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Cart√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['N√∫mero do Cartao'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFontSize(6);
                        doc.text('Sistema B2B Reservas', 40, 140, { align: 'center' });
                        doc.text(dayjs().format('DD/MM/YYYY HH:mm:ss'), 40, 143, { align: 'center' });
                    });
                    
                    const fileName = `filipetas_${dayjs().format('YYYY-MM-DD')}.pdf`;
                    doc.save(fileName);
                    mostrarNotificacao(`${dadosFiltrados.length} filipetas geradas!`, 'success');
                    
                } catch (error) {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Fun√ß√µes utilit√°rias
        function mostrarLoading(mostrar) {
            loadingOverlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) notifAnterior.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${tipo}`;
            notification.innerHTML = `<strong>${tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong> ${mensagem}`;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
    </script>
</body>
</html>
