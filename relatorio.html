<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Reservas - Sistema de Relat√≥rios PDF</title>
    <style>
        /* ESTILOS MANTIDOS IGUAIS - n√£o vou repetir para economizar espa√ßo */
        /* ... todos os estilos CSS anteriores ... */
    </style>
    <!-- Incluir bibliotecas necess√°rias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS para processar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- DayJS para manipula√ß√£o de datas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/locale/pt-br.min.js"></script>
</head>
<body>
    <!-- HTML MANTIDO IGUAL - n√£o vou repetir para economizar espa√ßo -->
    <!-- ... todo o HTML anterior ... -->
    
    <script>
        // Configurar dayjs com locale brasileiro
        dayjs.locale('pt-br');
        
        // Configurar jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        
        // Configura√ß√µes persistentes
        const CONFIG_KEY = 'b2b_pdf_config';
        let config = {
            titulo: 'RELAT√ìRIO DE VENDAS B2B RESERVAS',
            subtitulo: 'Filipeta POS - Transa√ß√µes Detalhadas',
            fontSize: '9',
            includeSummary: true,
            includeFilters: true,
            orientation: 'landscape',
            paperSize: 'letter',
            margins: 'normal'
        };
        
        // Mapeamento exato dos campos esperados
        const CAMPOS_ESPERADOS = [
            'Status',
            'Data Transacao',
            'Data Recebimento',
            'Total Diarias',
            'Valor Extras',
            'Valor Taxas',
            'Valor Impostos',
            'Valor total da transacao',
            'Tarifa',
            'Comissoes',
            'Taxa de Servico B2B',
            'Valor Adquirencia',
            'Valor Liquido',
            'N√∫mero do Cartao',
            'Bandeira do Cartao'
        ];
        
        // Campos que s√£o num√©ricos (para convers√£o)
        const CAMPOS_NUMERICOS = [
            'Total Diarias',
            'Valor Extras',
            'Valor Taxas',
            'Valor Impostos',
            'Valor total da transacao',
            'Tarifa',
            'Comissoes',
            'Taxa de Servico B2B',
            'Valor Adquirencia',
            'Valor Liquido'
        ];
        
        // Carregar configura√ß√µes salvas
        function carregarConfiguracoes() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
                try {
                    const loadedConfig = JSON.parse(saved);
                    config = { ...config, ...loadedConfig };
                    aplicarConfiguracoes();
                } catch (e) {
                    console.error('Erro ao carregar configura√ß√µes:', e);
                }
            }
        }
        
        // Aplicar configura√ß√µes carregadas
        function aplicarConfiguracoes() {
            pdfTitle.value = config.titulo;
            pdfSubtitle.value = config.subtitulo;
            pdfFontSize.value = config.fontSize;
            pdfIncludeSummary.value = config.includeSummary ? 'true' : 'false';
            pdfIncludeFilters.value = config.includeFilters ? 'true' : 'false';
            pdfOrientation.value = config.orientation;
            pdfPaperSize.value = config.paperSize;
            pdfMargins.value = config.margins;
        }
        
        // Salvar configura√ß√µes
        function salvarConfiguracoes() {
            config.titulo = pdfTitle.value;
            config.subtitulo = pdfSubtitle.value;
            config.fontSize = pdfFontSize.value;
            config.includeSummary = pdfIncludeSummary.value === 'true';
            config.includeFilters = pdfIncludeFilters.value === 'true';
            config.orientation = pdfOrientation.value;
            config.paperSize = pdfPaperSize.value;
            config.margins = pdfMargins.value;
            
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            mostrarNotificacao('Configura√ß√µes salvas com sucesso!', 'success');
        }
        
        // Vari√°veis globais
        let dadosOriginais = [];
        let dadosFiltrados = [];
        let tipoRelatorioAtual = 'filipeta'; // 'filipeta', 'detalhado', 'aprovadas'
        
        // Elementos DOM (mantidos iguais)
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const fileName = document.getElementById('fileName');
        const dataPreview = document.getElementById('dataPreview');
        const previewBody = document.getElementById('previewBody');
        const dataStats = document.getElementById('dataStats');
        const pdfModal = document.getElementById('pdfModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Filtros (mantidos iguais)
        const filterStatus = document.getElementById('filterStatus');
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        const filterValorMin = document.getElementById('filterValorMin');
        const filterValorMax = document.getElementById('filterValorMax');
        const filterBandeira = document.getElementById('filterBandeira');
        
        // Bot√µes de tipo de relat√≥rio (mantidos iguais)
        const btnFilipeta = document.getElementById('btnFilipeta');
        const btnRelatorioDetalhado = document.getElementById('btnRelatorioDetalhado');
        const btnResumoAprovadas = document.getElementById('btnResumoAprovadas');
        
        // Bot√µes de a√ß√£o (mantidos iguais)
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnLimparFiltros = document.getElementById('btnLimparFiltros');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnGerarPDF = document.getElementById('btnGerarPDF');
        const btnConfigPDF = document.getElementById('btnConfigPDF');
        const btnGerarTodasFilipetas = document.getElementById('btnGerarTodasFilipetas');
        const btnGerarPDFConfirmar = document.getElementById('btnGerarPDFConfirmar');
        const btnCancelarPDF = document.getElementById('btnCancelarPDF');
        const btnSalvarConfig = document.getElementById('btnSalvarConfig');
        const closeModal = document.getElementById('closeModal');
        
        // Configura√ß√µes PDF (mantidos iguais)
        const pdfTitle = document.getElementById('pdfTitle');
        const pdfSubtitle = document.getElementById('pdfSubtitle');
        const pdfFontSize = document.getElementById('pdfFontSize');
        const pdfIncludeSummary = document.getElementById('pdfIncludeSummary');
        const pdfIncludeFilters = document.getElementById('pdfIncludeFilters');
        const pdfOrientation = document.getElementById('pdfOrientation');
        const pdfPaperSize = document.getElementById('pdfPaperSize');
        const pdfMargins = document.getElementById('pdfMargins');
        
        // Resumo (mantidos iguais)
        const totalTransacoes = document.getElementById('totalTransacoes');
        const valorTotal = document.getElementById('valorTotal');
        const valorLiquido = document.getElementById('valorLiquido');
        const diariasTotal = document.getElementById('diariasTotal');
        
        // Event Listeners (mantidos iguais)
        fileInput.addEventListener('change', handleFileUpload);
        btnFiltrar.addEventListener('click', aplicarFiltros);
        btnLimparFiltros.addEventListener('click', limparFiltros);
        btnExportarExcel.addEventListener('click', exportarParaExcel);
        btnGerarPDF.addEventListener('click', abrirModalPDF);
        btnConfigPDF.addEventListener('click', abrirModalPDF);
        btnGerarTodasFilipetas.addEventListener('click', gerarTodasFilipetas);
        btnGerarPDFConfirmar.addEventListener('click', gerarPDF);
        btnCancelarPDF.addEventListener('click', fecharModalPDF);
        btnSalvarConfig.addEventListener('click', salvarConfiguracoes);
        closeModal.addEventListener('click', fecharModalPDF);
        
        // Event listeners para tipo de relat√≥rio (mantidos iguais)
        btnFilipeta.addEventListener('click', () => selecionarTipoRelatorio('filipeta'));
        btnRelatorioDetalhado.addEventListener('click', () => selecionarTipoRelatorio('detalhado'));
        btnResumoAprovadas.addEventListener('click', () => selecionarTipoRelatorio('aprovadas'));
        
        // Fechar modal ao clicar fora (mantido igual)
        window.addEventListener('click', (event) => {
            if (event.target === pdfModal) {
                fecharModalPDF();
            }
        });
        
        // Fun√ß√µes de utilit√°rio (mantidas iguais)
        function mostrarLoading(mostrar) {
            loadingOverlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            // Remove notifica√ß√£o anterior se existir
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) notifAnterior.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${tipo}`;
            notification.innerHTML = `
                <strong>${tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong>
                ${mensagem}
            `;
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => notification.remove(), 5000);
        }
        
        // Fun√ß√£o para selecionar tipo de relat√≥rio (mantida igual)
        function selecionarTipoRelatorio(tipo) {
            tipoRelatorioAtual = tipo;
            
            // Atualizar bot√µes ativos
            [btnFilipeta, btnRelatorioDetalhado, btnResumoAprovadas].forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tipo === 'filipeta') btnFilipeta.classList.add('active');
            if (tipo === 'detalhado') btnRelatorioDetalhado.classList.add('active');
            if (tipo === 'aprovadas') btnResumoAprovadas.classList.add('active');
            
            // Atualizar texto do bot√£o principal
            const btnTexto = {
                'filipeta': 'GERAR FILIPETA POS',
                'detalhado': 'GERAR RELAT√ìRIO DETALHADO',
                'aprovadas': 'GERAR RESUMO APROVADAS'
            };
            
            btnGerarPDF.innerHTML = `<span style="font-size: 1.4rem;">üìä</span> ${btnTexto[tipo]}`;
        }
        
        // Drag and drop (mantido igual)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.backgroundColor = '#e8f4fc';
        }
        
        function unhighlight() {
            dropArea.style.backgroundColor = '';
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                fileInput.files = files;
                handleFileUpload();
            }
        }
        
        // Fun√ß√£o principal para processar upload de arquivo (mantida igual)
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            // Valida√ß√£o de tamanho (m√°ximo 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                mostrarNotificacao('Arquivo muito grande. Tamanho m√°ximo: 10MB', 'error');
                return;
            }
            
            // Valida√ß√£o de extens√£o
            const extensoesPermitidas = ['.csv', '.xlsx', '.xls', '.xlsm', '.xlsb', '.ods', '.xltx', '.xltm'];
            const extensao = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!extensoesPermitidas.includes(extensao)) {
                mostrarNotificacao('Formato de arquivo n√£o suportado. Use CSV ou Excel.', 'error');
                return;
            }
            
            fileName.textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            fileName.style.color = '#27ae60';
            
            mostrarLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    
                    if (extensao === '.csv') {
                        processarCSV(data);
                    } else {
                        processarExcel(data);
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro ao processar arquivo: ${error.message}`, 'error');
                    console.error(error);
                    limparDados();
                } finally {
                    mostrarLoading(false);
                }
            };
            
            // Se for CSV, l√™ como texto, caso contr√°rio, l√™ como array buffer
            if (extensao === '.csv') {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Limpar dados (mantido igual)
        function limparDados() {
            dadosOriginais = [];
            dadosFiltrados = [];
            dataPreview.style.display = 'none';
            atualizarResumo();
        }
        
        // Fun√ß√£o para normalizar nomes de campos (mantida igual)
        function normalizarNomeCampo(nome) {
            return nome
                .trim()
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-z0-9\s]/gi, '') // Remove caracteres especiais
                .replace(/\s+/g, ' ') // Remove espa√ßos m√∫ltiplos
                .trim();
        }
        
        // Mapear nomes de campos para os nomes padr√£o (mantido igual)
        function mapearCampo(nomeCampo) {
            const nomeNormalizado = normalizarNomeCampo(nomeCampo);
            
            const mapeamentos = {
                'status': 'Status',
                'data transacao': 'Data Transacao',
                'data recebimento': 'Data Recebimento',
                'total diarias': 'Total Diarias',
                'valor extras': 'Valor Extras',
                'valor taxas': 'Valor Taxas',
                'valor impostos': 'Valor Impostos',
                'valor total da transacao': 'Valor total da transacao',
                'tarifa': 'Tarifa',
                'comissoes': 'Comissoes',
                'taxa de servico b2b': 'Taxa de Servico B2B',
                'valor adquirencia': 'Valor Adquirencia',
                'valor liquido': 'Valor Liquido',
                'numero do cartao': 'N√∫mero do Cartao',
                'bandeira do cartao': 'Bandeira do Cartao'
            };
            
            // Verifica mapeamento exato
            if (mapeamentos[nomeNormalizado]) {
                return mapeamentos[nomeNormalizado];
            }
            
            // Verifica se cont√©m parte do nome
            for (const [chave, valor] of Object.entries(mapeamentos)) {
                if (nomeNormalizado.includes(chave) || chave.includes(nomeNormalizado)) {
                    return valor;
                }
            }
            
            return nomeCampo; // Retorna original se n√£o encontrar
        }
        
        // Processar Excel usando SheetJS - CORRIGIDO!
        function processarExcel(data) {
            try {
                const workbook = XLSX.read(data, { 
                    type: 'array', 
                    cellDates: true,
                    raw: false, // IMPORTANTE: raw false para obter valores como string
                    dateNF: 'yyyy-mm-dd hh:mm:ss' // Formato de data esperado
                });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Converter para array de arrays
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1,
                    defval: '',
                    raw: false // Crucial: n√£o usar raw values
                });
                
                if (jsonData.length < 2) {
                    mostrarNotificacao('Arquivo Excel vazio ou inv√°lido', 'error');
                    limparDados();
                    return;
                }
                
                // Obter cabe√ßalhos da primeira linha
                const cabecalhosOriginais = jsonData[0];
                
                // Mapear cabe√ßalhos para nomes padr√£o
                const cabecalhosMapeados = cabecalhosOriginais.map(cabecalho => {
                    return mapearCampo(String(cabecalho));
                });
                
                console.log('Cabe√ßalhos mapeados:', cabecalhosMapeados);
                
                // Processar linhas de dados
                dadosOriginais = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const linha = jsonData[i];
                    if (!linha || linha.length === 0) continue;
                    
                    const registro = {};
                    
                    // Mapear cada coluna usando cabe√ßalhos mapeados
                    cabecalhosMapeados.forEach((cabecalho, index) => {
                        let valor = linha[index];
                        
                        // Se for undefined ou null, usar string vazia
                        if (valor === undefined || valor === null) {
                            valor = '';
                        }
                        
                        // Manter como string - a convers√£o num√©rica ser√° feita depois
                        registro[cabecalho] = String(valor).trim();
                    });
                    
                    // Converter valores num√©ricos CORRETAMENTE
                    converterValoresNumericosCORRETO(registro);
                    
                    // Validar registro
                    if (validarRegistro(registro)) {
                        dadosOriginais.push(registro);
                    } else {
                        console.warn('Registro inv√°lido ignorado:', registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado no arquivo', 'error');
                    limparDados();
                    return;
                }
                
                console.log('Primeiro registro processado:', dadosOriginais[0]);
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao(`Erro ao processar Excel: ${error.message}`, 'error');
                console.error(error);
                limparDados();
            }
        }
        
        // Processar CSV - CORRIGIDO!
        function processarCSV(content) {
            try {
                const linhas = content.split('\n');
                
                if (linhas.length < 2) {
                    mostrarNotificacao('Arquivo CSV vazio ou inv√°lido', 'error');
                    limparDados();
                    return;
                }
                
                // Detecta o separador (v√≠rgula ou ponto-e-v√≠rgula)
                const primeiraLinha = linhas[0];
                const temPontoVirgula = primeiraLinha.split(';').length > primeiraLinha.split(',').length;
                const separador = temPontoVirgula ? ';' : ',';
                
                // Extrair cabe√ßalhos
                const cabecalhosOriginais = parseCSVLine(primeiraLinha, separador).map(h => h.trim().replace(/"/g, ''));
                
                // Mapear cabe√ßalhos para nomes padr√£o
                const cabecalhosMapeados = cabecalhosOriginais.map(cabecalho => {
                    return mapearCampo(String(cabecalho));
                });
                
                console.log('Cabe√ßalhos mapeados (CSV):', cabecalhosMapeados);
                
                // Processar linhas de dados
                dadosOriginais = [];
                
                for (let i = 1; i < linhas.length; i++) {
                    if (linhas[i].trim() === '') continue;
                    
                    const valores = parseCSVLine(linhas[i], separador);
                    const registro = {};
                    
                    cabecalhosMapeados.forEach((cabecalho, index) => {
                        let valor = valores[index] ? valores[index].trim().replace(/"/g, '') : '';
                        registro[cabecalho] = valor;
                    });
                    
                    // Converter valores num√©ricos CORRETAMENTE
                    converterValoresNumericosCORRETO(registro);
                    
                    // Validar registro
                    if (validarRegistro(registro)) {
                        dadosOriginais.push(registro);
                    } else {
                        console.warn('Registro inv√°lido ignorado (CSV):', registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado no arquivo', 'error');
                    limparDados();
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao(`Erro ao processar CSV: ${error.message}`, 'error');
                console.error(error);
                limparDados();
            }
        }
        
        // Fun√ß√£o para fazer parse de linha CSV (mantida igual)
        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.replace(/^"+|"+$/g, ''));
        }
        
        // Validar registro (mantida igual)
        function validarRegistro(registro) {
            // Verificar se tem pelo menos alguns dados essenciais
            const camposRequeridos = ['Data Transacao', 'Valor total da transacao'];
            
            for (const campo of camposRequeridos) {
                if (!registro[campo] || registro[campo].toString().trim() === '') {
                    return false;
                }
            }
            
            return true;
        }
        
        // CONVERS√ÉO NUM√âRICA CORRIGIDA - FUN√á√ÉO NOVA!
        function converterValoresNumericosCORRETO(registro) {
            CAMPOS_NUMERICOS.forEach(campo => {
                if (registro[campo] !== undefined && registro[campo] !== null && registro[campo] !== '') {
                    let valorStr = String(registro[campo]).trim();
                    
                    // REMOVER QUALQUER S√çMBOLO DE MOEDA
                    valorStr = valorStr.replace(/[R$\s]/g, '').trim();
                    
                    // AN√ÅLISE INTELIGENTE DO FORMATO
                    let valorNumerico;
                    
                    // Verificar se tem v√≠rgula (formato brasileiro)
                    const temVirgula = valorStr.includes(',');
                    const temPonto = valorStr.includes('.');
                    
                    if (temVirgula && temPonto) {
                        // Formato: 1.234,56 (brasileiro com separador de milhar)
                        // Remover pontos de milhar, trocar v√≠rgula decimal por ponto
                        valorStr = valorStr.replace(/\./g, '').replace(',', '.');
                        valorNumerico = parseFloat(valorStr);
                    } else if (temVirgula && !temPonto) {
                        // Formato: 1234,56 (brasileiro sem separador de milhar)
                        valorStr = valorStr.replace(',', '.');
                        valorNumerico = parseFloat(valorStr);
                    } else if (!temVirgula && temPonto) {
                        // Formato: 1234.56 ou 1.234.56 (internacional)
                        // Contar pontos para determinar se √© separador decimal ou milhar
                        const partes = valorStr.split('.');
                        
                        if (partes.length === 2) {
                            // Apenas um ponto - provavelmente separador decimal
                            valorNumerico = parseFloat(valorStr);
                        } else {
                            // M√∫ltiplos pontos - pode ser formato com separador de milhar
                            // Tentar interpretar como n√∫mero com separador de milhar
                            // Na sua planilha, os n√∫meros est√£o como "1990.91" (ponto decimal)
                            // Ent√£o se tiver apenas UM ponto ap√≥s muitos d√≠gitos, √© decimal
                            
                            // Remover todos os pontos e tratar como n√∫mero inteiro
                            // Mas isso est√° ERRADO para sua planilha!
                            
                            // MELHOR ABORDAGEM: Se vem do Excel, j√° deve vir formatado
                            // Vamos confiar no parseFloat
                            valorNumerico = parseFloat(valorStr);
                            
                            // Se deu NaN, tentar remover pontos
                            if (isNaN(valorNumerico)) {
                                valorStr = valorStr.replace(/\./g, '');
                                valorNumerico = parseFloat(valorStr);
                            }
                        }
                    } else {
                        // Nenhum separador - n√∫mero inteiro
                        valorNumerico = parseFloat(valorStr);
                    }
                    
                    if (!isNaN(valorNumerico)) {
                        registro[`${campo}_NUM`] = valorNumerico;
                        console.log(`Campo ${campo}: "${valorStr}" -> ${valorNumerico}`);
                    } else {
                        registro[`${campo}_NUM`] = 0;
                        console.warn(`Campo ${campo}: N√£o foi poss√≠vel converter "${valorStr}"`);
                    }
                } else {
                    registro[`${campo}_NUM`] = 0;
                }
            });
            
            // Garantir que campos obrigat√≥rios tenham valores num√©ricos
            if (!registro['Valor total da transacao_NUM'] && registro['Valor total da transacao_NUM'] !== 0) {
                registro['Valor total da transacao_NUM'] = 0;
            }
            
            if (!registro['Valor Liquido_NUM'] && registro['Valor Liquido_NUM'] !== 0) {
                registro['Valor Liquido_NUM'] = 0;
            }
            
            if (!registro['Total Diarias_NUM'] && registro['Total Diarias_NUM'] !== 0) {
                registro['Total Diarias_NUM'] = 0;
            }
        }
        
        // Mostrar pr√©via dos dados - CORRIGIDA!
        function mostrarPreviaDados() {
            if (dadosOriginais.length === 0) {
                dataPreview.style.display = 'none';
                return;
            }
            
            dataPreview.style.display = 'block';
            previewBody.innerHTML = '';
            
            const limite = Math.min(10, dadosOriginais.length);
            
            for (let i = 0; i < limite; i++) {
                const registro = dadosOriginais[i];
                const tr = document.createElement('tr');
                
                // Determinar classe de status
                let statusClass = '';
                if (registro.Status === 'Aprovada') statusClass = 'status-aprovada';
                else if (registro.Status === 'Cancelada') statusClass = 'status-cancelada';
                else if (registro.Status === 'Pendente') statusClass = 'status-pendente';
                
                // Formatar datas corretamente
                let dataFormatada = registro['Data Transacao'] || 'N/A';
                // Se a data estiver no formato ISO, converter
                if (dataFormatada.includes('2025-')) {
                    dataFormatada = dayjs(dataFormatada).format('DD/MM/YYYY HH:mm:ss');
                }
                
                // Formatar valores monet√°rios CORRETAMENTE
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                const valorLiquido = registro['Valor Liquido_NUM'] || 0;
                const diarias = registro['Total Diarias_NUM'] || 0;
                
                tr.innerHTML = `
                    <td class="${statusClass}">${registro.Status || 'N/A'}</td>
                    <td>${dataFormatada}</td>
                    <td class="currency">R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="currency">R$ ${valorLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${registro['N√∫mero do Cartao'] || 'N/A'}</td>
                    <td>${diarias.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                `;
                
                previewBody.appendChild(tr);
            }
            
            // Atualizar estat√≠sticas
            atualizarEstatisticasPrevia();
        }
        
        // Atualizar estat√≠sticas da pr√©via - CORRIGIDA!
        function atualizarEstatisticasPrevia() {
            const total = dadosOriginais.length;
            const aprovadas = dadosOriginais.filter(r => r.Status === 'Aprovada').length;
            const canceladas = dadosOriginais.filter(r => r.Status === 'Cancelada').length;
            const valorTotalSum = dadosOriginais.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorMedio = total > 0 ? valorTotalSum / total : 0;
            
            dataStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total de Transa√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${aprovadas}</div>
                    <div class="stat-label">Aprovadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${canceladas}</div>
                    <div class="stat-label">Canceladas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">R$ ${valorMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="stat-label">Valor M√©dio</div>
                </div>
            `;
        }
        
        // Atualizar filtros de bandeira (mantida igual)
        function atualizarFiltrosBandeira() {
            const bandeiras = new Set();
            
            dadosOriginais.forEach(registro => {
                const bandeira = registro['Bandeira do Cartao'];
                if (bandeira && bandeira.trim() !== '') {
                    bandeiras.add(bandeira.trim());
                }
            });
            
            // Limpar op√ß√µes existentes (exceto a primeira)
            while (filterBandeira.options.length > 1) {
                filterBandeira.remove(1);
            }
            
            // Adicionar bandeiras encontradas
            Array.from(bandeiras).sort().forEach(bandeira => {
                const option = document.createElement('option');
                option.value = bandeira;
                option.textContent = bandeira;
                filterBandeira.appendChild(option);
            });
        }
        
        // Abrir modal de configura√ß√µes do PDF (mantida igual)
        function abrirModalPDF() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Por favor, carregue um arquivo primeiro.', 'error');
                return;
            }
            
            pdfModal.style.display = 'block';
        }
        
        // Fechar modal (mantida igual)
        function fecharModalPDF() {
            pdfModal.style.display = 'none';
        }
        
        // Parsear data (mantida igual)
        function parsearData(dataString) {
            if (!dataString || dataString.trim() === '') return null;
            
            try {
                // Formato: DD/MM/YYYY HH:MM:SS
                if (dataString.includes('/')) {
                    const [datePart, timePart] = dataString.split(' ');
                    const [day, month, year] = datePart.split('/');
                    
                    if (timePart) {
                        const [hours, minutes, seconds] = timePart.split(':');
                        return new Date(year, month - 1, day, hours || 0, minutes || 0, seconds || 0);
                    }
                    return new Date(year, month - 1, day);
                }
                // Formato: YYYY-MM-DD
                else if (dataString.includes('-')) {
                    return new Date(dataString);
                }
                
                return null;
            } catch (error) {
                console.error('Erro ao parsear data:', dataString, error);
                return null;
            }
        }
        
        // Aplicar filtros (mantida igual)
        function aplicarFiltros() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Por favor, carregue um arquivo primeiro.', 'error');
                return;
            }
            
            dadosFiltrados = dadosOriginais.filter(registro => {
                // Filtro por status
                if (filterStatus.value && registro.Status !== filterStatus.value) {
                    return false;
                }
                
                // Filtro por bandeira
                if (filterBandeira.value) {
                    const bandeiraRegistro = registro['Bandeira do Cartao'];
                    if (bandeiraRegistro !== filterBandeira.value) {
                        return false;
                    }
                }
                
                // Filtro por data
                if (filterDataInicio.value && registro['Data Transacao']) {
                    const dataTransacao = parsearData(registro['Data Transacao']);
                    const dataInicio = new Date(filterDataInicio.value);
                    
                    if (dataTransacao && dataTransacao < dataInicio) {
                        return false;
                    }
                }
                
                if (filterDataFim.value && registro['Data Transacao']) {
                    const dataTransacao = parsearData(registro['Data Transacao']);
                    const dataFim = new Date(filterDataFim.value);
                    dataFim.setHours(23, 59, 59, 999);
                    
                    if (dataTransacao && dataTransacao > dataFim) {
                        return false;
                    }
                }
                
                // Filtro por valor
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                
                if (filterValorMin.value && valorTotal < parseFloat(filterValorMin.value)) {
                    return false;
                }
                
                if (filterValorMax.value && valorTotal > parseFloat(filterValorMax.value)) {
                    return false;
                }
                
                return true;
            });
            
            atualizarResumo();
            mostrarNotificacao(`‚úÖ Filtros aplicados: ${dadosFiltrados.length} transa√ß√µes encontradas.`, 'success');
        }
        
        // Limpar filtros (mantida igual)
        function limparFiltros() {
            filterStatus.value = '';
            filterDataInicio.value = '';
            filterDataFim.value = '';
            filterValorMin.value = '';
            filterValorMax.value = '';
            filterBandeira.value = '';
            
            dadosFiltrados = [...dadosOriginais];
            atualizarResumo();
            
            mostrarNotificacao('‚úÖ Filtros limpos. Todos os dados restaurados.', 'success');
        }
        
        // Atualizar resumo - CORRIGIDA!
        function atualizarResumo() {
            if (dadosFiltrados.length === 0) {
                totalTransacoes.textContent = '0';
                valorTotal.textContent = 'R$ 0,00';
                valorLiquido.textContent = 'R$ 0,00';
                diariasTotal.textContent = '0';
                return;
            }
            
            // Calcular totais
            const total = dadosFiltrados.length;
            
            const valorTotalSum = dadosFiltrados.reduce((sum, registro) => {
                return sum + (registro['Valor total da transacao_NUM'] || 0);
            }, 0);
            
            const valorLiquidoSum = dadosFiltrados.reduce((sum, registro) => {
                return sum + (registro['Valor Liquido_NUM'] || 0);
            }, 0);
            
            const diariasSum = dadosFiltrados.reduce((sum, registro) => {
                return sum + (registro['Total Diarias_NUM'] || 0);
            }, 0);
            
            // Atualizar elementos com formata√ß√£o CORRETA
            totalTransacoes.textContent = total.toLocaleString('pt-BR');
            valorTotal.textContent = `R$ ${valorTotalSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            valorLiquido.textContent = `R$ ${valorLiquidoSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            diariasTotal.textContent = diariasSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Exportar para Excel - CORRIGIDA!
        function exportarParaExcel() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para exportar.', 'error');
                return;
            }
            
            // Usar os campos esperados
            const colunasExport = CAMPOS_ESPERADOS;
            
            // Converter dados para formato CSV
            const cabecalhos = colunasExport.join(';');
            const linhas = dadosFiltrados.map(registro => {
                return colunasExport.map(coluna => {
                    let valor = registro[coluna] || '';
                    
                    // Formatar valores num√©ricos CORRETAMENTE
                    if (registro[`${coluna}_NUM`] !== undefined && CAMPOS_NUMERICOS.includes(coluna)) {
                        // Formatar como n√∫mero com ponto decimal (formato internacional para Excel)
                        valor = registro[`${coluna}_NUM`].toFixed(2);
                    }
                    
                    // Escapar ponto e v√≠rgula
                    if (typeof valor === 'string' && valor.includes(';')) {
                        valor = `"${valor}"`;
                    }
                    return valor;
                }).join(';');
            });
            
            const conteudoCSV = [cabecalhos, ...linhas].join('\n');
            
            // Criar blob e link de download
            const blob = new Blob(['\uFEFF' + conteudoCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_b2b_${dayjs().format('YYYY-MM-DD')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('‚úÖ Arquivo CSV exportado com sucesso!', 'success');
        }
        
        // Gerar PDF (principal) - mantida igual
        function gerarPDF() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è N√£o h√° dados para gerar o relat√≥rio.', 'error');
                return;
            }
            
            fecharModalPDF();
            salvarConfiguracoes();
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    switch(tipoRelatorioAtual) {
                        case 'filipeta':
                            gerarPDFFilipeta();
                            break;
                        case 'detalhado':
                            gerarPDFDetalhado();
                            break;
                        case 'aprovadas':
                            gerarPDFResumoAprovadas();
                            break;
                        default:
                            gerarPDFFilipeta();
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro ao gerar PDF: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Gerar PDF Filipeta POS - CORRIGIDA para usar formata√ß√£o num√©rica correta
        function gerarPDFFilipeta() {
            // Obter configura√ß√µes
            const titulo = pdfTitle.value || 'FILIPETA DE VENDAS POS - B2B RESERVAS';
            const subtitulo = pdfSubtitle.value || 'Resumo de Transa√ß√µes para Confer√™ncia';
            const fontSize = parseInt(pdfFontSize.value);
            const includeSummary = pdfIncludeSummary.value === 'true';
            const includeFilters = pdfIncludeFilters.value === 'true';
            const orientation = pdfOrientation.value;
            const paperSize = pdfPaperSize.value;
            const margins = pdfMargins.value;
            
            // Configurar margens
            let marginLeft, marginRight, marginTop, marginBottom;
            switch(margins) {
                case 'small':
                    marginLeft = marginRight = marginTop = marginBottom = 10;
                    break;
                case 'large':
                    marginLeft = marginRight = marginTop = marginBottom = 25;
                    break;
                case 'minimal':
                    marginLeft = marginRight = marginTop = marginBottom = 5;
                    break;
                default:
                    marginLeft = marginRight = marginTop = marginBottom = 15;
            }
            
            // Criar documento PDF
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: paperSize
            });
            
            // Configurar fonte
            doc.setFont('helvetica');
            doc.setFontSize(fontSize);
            
            // Posi√ß√£o inicial
            let yPos = marginTop;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            // Cabe√ßalho do relat√≥rio
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('üè¶ B2B RESERVAS', marginLeft, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('FILIPETA DE VENDAS POS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Relat√≥rio para confer√™ncia di√°ria', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Data de gera√ß√£o
            const dataGeracao = dayjs().format('DD/MM/YYYY HH:mm:ss');
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, yPos - 15, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Resumo r√°pido
            if (includeSummary) {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMO:', marginLeft, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const totalTrans = dadosFiltrados.length;
                const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
                const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
                const aprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada').length;
                
                doc.text(`‚Ä¢ Total de Transa√ß√µes: ${totalTrans}`, marginLeft + 5, yPos);
                yPos += 5;
                doc.text(`‚Ä¢ Aprovadas: ${aprovadas}`, marginLeft + 5, yPos);
                yPos += 5;
                doc.text(`‚Ä¢ Valor Bruto: R$ ${valorTotalSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, marginLeft + 5, yPos);
                yPos += 5;
                doc.text(`‚Ä¢ Valor L√≠quido: R$ ${valorLiquidoSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, marginLeft + 5, yPos);
                yPos += 10;
            }
            
            // Filtros aplicados
            if (includeFilters) {
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('FILTROS APLICADOS:', marginLeft, yPos);
                yPos += 7;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                let filtrosTexto = [];
                if (filterStatus.value) filtrosTexto.push(`Status: ${filterStatus.value}`);
                if (filterBandeira.value) filtrosTexto.push(`Bandeira: ${filterBandeira.value}`);
                if (filterDataInicio.value || filterDataFim.value) {
                    filtrosTexto.push(`Per√≠odo: ${filterDataInicio.value || ''} at√© ${filterDataFim.value || ''}`);
                }
                if (filterValorMin.value || filterValorMax.value) {
                    filtrosTexto.push(`Valor: R$ ${filterValorMin.value || '0,00'} - R$ ${filterValorMax.value || '0,00'}`);
                }
                
                if (filtrosTexto.length === 0) {
                    filtrosTexto.push('Nenhum filtro aplicado');
                }
                
                filtrosTexto.forEach(filtro => {
                    if (yPos > pageHeight - marginBottom - 10) {
                        doc.addPage([pageWidth, pageHeight]);
                        yPos = marginTop;
                    }
                    doc.text(`‚Ä¢ ${filtro}`, marginLeft + 5, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Tabela de transa√ß√µes (simplificada)
            const headers = ['#', 'Data/Hora', 'Status', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = dadosFiltrados.map((registro, index) => {
                // Formatar data
                let dataFormatada = registro['Data Transacao'] || '';
                if (dataFormatada.includes('2025-')) {
                    dataFormatada = dayjs(dataFormatada).format('DD/MM/YYYY HH:mm:ss');
                }
                
                return [
                    (index + 1).toString(),
                    dataFormatada,
                    registro.Status || '',
                    `R$ ${(registro['Valor total da transacao_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    `R$ ${(registro['Valor Liquido_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || ''
                ];
            });
            
            // Configura√ß√µes da tabela
            const columnStyles = {
                0: { cellWidth: 10, halign: 'center' },
                1: { cellWidth: 35 },
                2: { cellWidth: 20, halign: 'center' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 25, halign: 'right' },
                5: { cellWidth: 35 },
                6: { cellWidth: 25 }
            };
            
            // Gerar tabela principal
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: {
                    fillColor: [52, 152, 219],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                margin: { left: marginLeft, right: marginRight, top: yPos },
                columnStyles: columnStyles,
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                didDrawPage: function(data) {
                    // Adicionar n√∫mero da p√°gina
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(
                        `P√°gina ${data.pageNumber} de ${pageCount}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                    
                    // Adicionar rodap√©
                    doc.setFontSize(7);
                    doc.text(
                        'B2B Reservas - Sistema de Relat√≥rios de Vendas',
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: 'center' }
                    );
                }
            });
            
            // Salvar PDF
            const fileName = `filipeta_pos_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            
            mostrarNotificacao(`‚úÖ Filipeta POS gerada com sucesso!\nüìÇ ${fileName}`, 'success');
        }
        
        // Gerar PDF Detalhado - CORRIGIDA para usar formata√ß√£o num√©rica correta
        function gerarPDFDetalhado() {
            // Obter configura√ß√µes
            const titulo = pdfTitle.value || 'RELAT√ìRIO DETALHADO - B2B RESERVAS';
            const subtitulo = pdfSubtitle.value || 'Transa√ß√µes Completas - Formato Paisagem';
            const fontSize = parseInt(pdfFontSize.value);
            const includeSummary = pdfIncludeSummary.value === 'true';
            const includeFilters = pdfIncludeFilters.value === 'true';
            const orientation = 'landscape'; // For√ßar paisagem para relat√≥rio detalhado
            const paperSize = pdfPaperSize.value;
            const margins = pdfMargins.value;
            
            // Configurar margens
            let marginLeft, marginRight, marginTop, marginBottom;
            switch(margins) {
                case 'small':
                    marginLeft = marginRight = marginTop = marginBottom = 10;
                    break;
                case 'large':
                    marginLeft = marginRight = marginTop = marginBottom = 25;
                    break;
                case 'minimal':
                    marginLeft = marginRight = marginTop = marginBottom = 5;
                    break;
                default:
                    marginLeft = marginRight = marginTop = marginBottom = 15;
            }
            
            // Criar documento PDF
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: paperSize
            });
            
            // Configurar fonte
            doc.setFont('helvetica');
            doc.setFontSize(fontSize);
            
            // Posi√ß√£o inicial
            let yPos = marginTop;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            // Cabe√ßalho do relat√≥rio
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('üè¶ B2B RESERVAS', marginLeft, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text(titulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(subtitulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Data de gera√ß√£o
            const dataGeracao = dayjs().format('DD/MM/YYYY HH:mm:ss');
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, yPos - 15, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Resumo r√°pido
            if (includeSummary) {
                const totalTrans = dadosFiltrados.length;
                const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
                const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
                const aprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada').length;
                const canceladas = dadosFiltrados.filter(r => r.Status === 'Cancelada').length;
                
                // Criar mini tabela de resumo
                const summaryData = [
                    ['Transa√ß√µes', 'Aprovadas', 'Canceladas', 'Valor Total', 'Valor L√≠quido'],
                    [
                        totalTrans.toString(),
                        aprovadas.toString(),
                        canceladas.toString(),
                        `R$ ${valorTotalSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                        `R$ ${valorLiquidoSum.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                    ]
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [summaryData[0]],
                    body: [summaryData[1]],
                    theme: 'grid',
                    headStyles: {
                        fillColor: [52, 152, 219],
                        textColor: 255,
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        fontSize: 11,
                        fontStyle: 'bold',
                        textColor: [44, 62, 80]
                    },
                    margin: { left: marginLeft, right: marginRight },
                    tableWidth: 'auto'
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
            }
            
            // Filtros aplicados
            if (includeFilters) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('FILTROS APLICADOS:', marginLeft, yPos);
                yPos += 7;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                let filtrosTexto = [];
                if (filterStatus.value) filtrosTexto.push(`Status: ${filterStatus.value}`);
                if (filterBandeira.value) filtrosTexto.push(`Bandeira: ${filterBandeira.value}`);
                if (filterDataInicio.value || filterDataFim.value) {
                    filtrosTexto.push(`Per√≠odo: ${filterDataInicio.value || ''} at√© ${filterDataFim.value || ''}`);
                }
                if (filterValorMin.value || filterValorMax.value) {
                    filtrosTexto.push(`Valor: R$ ${filterValorMin.value || '0,00'} - R$ ${filterValorMax.value || '0,00'}`);
                }
                
                if (filtrosTexto.length === 0) {
                    filtrosTexto.push('Nenhum filtro aplicado');
                }
                
                filtrosTexto.forEach(filtro => {
                    doc.text(`‚Ä¢ ${filtro}`, marginLeft + 5, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // Tabela detalhada com todos os 15 campos
            const headers = CAMPOS_ESPERADOS;
            const data = dadosFiltrados.map((registro, index) => {
                return headers.map(campo => {
                    let valor = registro[campo] || '';
                    
                    // Formatar valores num√©ricos CORRETAMENTE
                    if (registro[`${campo}_NUM`] !== undefined && CAMPOS_NUMERICOS.includes(campo)) {
                        valor = `R$ ${registro[`${campo}_NUM`].toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    
                    return valor;
                });
            });
            
            // Gerar tabela principal
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: 255,
                    fontSize: fontSize,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: fontSize - 1,
                    cellPadding: 3
                },
                margin: { left: marginLeft, right: marginRight },
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                didDrawPage: function(data) {
                    // Adicionar n√∫mero da p√°gina
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(
                        `P√°gina ${data.pageNumber} de ${pageCount}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                }
            });
            
            // Salvar PDF
            const fileName = `relatorio_detalhado_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            
            mostrarNotificacao(`‚úÖ Relat√≥rio detalhado gerado com sucesso!\nüìÇ ${fileName}`, 'success');
        }
        
        // Gerar PDF Resumo Aprovadas - CORRIGIDA para usar formata√ß√£o num√©rica correta
        function gerarPDFResumoAprovadas() {
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è N√£o h√° transa√ß√µes aprovadas para gerar o relat√≥rio.', 'error');
                return;
            }
            
            // Obter configura√ß√µes
            const titulo = 'RELAT√ìRIO DE TRANSA√á√ïES APROVADAS';
            const subtitulo = 'Resumo Completo - Formato Filipeta';
            const fontSize = parseInt(pdfFontSize.value);
            const paperSize = 'a4';
            const orientation = 'portrait';
            
            // Criar documento PDF
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: paperSize
            });
            
            // Configurar fonte
            doc.setFont('helvetica');
            doc.setFontSize(fontSize);
            
            // Posi√ß√£o inicial
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const marginLeft = 15;
            const marginRight = 15;
            
            // Cabe√ßalho do relat√≥rio
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('‚úÖ B2B RESERVAS', marginLeft, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text(titulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(subtitulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Data de gera√ß√£o
            const dataGeracao = dayjs().format('DD/MM/YYYY HH:mm:ss');
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, yPos - 15, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(46, 204, 113); // Verde para aprovadas
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Resumo estat√≠stico das aprovadas
            const totalAprovadas = transacoesAprovadas.length;
            const valorTotalAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            const diariasAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Total Diarias_NUM'] || 0), 0);
            const valorMedioAprovadas = totalAprovadas > 0 ? valorTotalAprovadas / totalAprovadas : 0;
            
            // Criar cart√µes de resumo
            const summaryCards = [
                { label: 'Transa√ß√µes Aprovadas', value: totalAprovadas.toString(), color: [46, 204, 113] },
                { label: 'Valor Total', value: `R$ ${valorTotalAprovadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, color: [52, 152, 219] },
                { label: 'Valor L√≠quido', value: `R$ ${valorLiquidoAprovadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, color: [155, 89, 182] },
                { label: 'Di√°rias Totais', value: diariasAprovadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), color: [241, 196, 15] },
                { label: 'Valor M√©dio', value: `R$ ${valorMedioAprovadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, color: [230, 126, 34] },
                { label: 'Ticket M√©dio', value: `R$ ${(totalAprovadas > 0 ? (valorLiquidoAprovadas / totalAprovadas) : 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, color: [231, 76, 60] }
            ];
            
            // Desenhar cart√µes de resumo
            const cardWidth = (pageWidth - marginLeft - marginRight - 20) / 3;
            const cardHeight = 25;
            
            summaryCards.forEach((card, index) => {
                const row = Math.floor(index / 3);
                const col = index % 3;
                const x = marginLeft + (col * (cardWidth + 10));
                const y = yPos + (row * (cardHeight + 10));
                
                // Fundo do cart√£o
                doc.setFillColor(card.color[0], card.color[1], card.color[2]);
                doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'F');
                
                // Texto do cart√£o
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(card.value, x + cardWidth / 2, y + 10, { align: 'center' });
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(card.label, x + cardWidth / 2, y + 16, { align: 'center' });
            });
            
            yPos += (Math.ceil(summaryCards.length / 3) * (cardHeight + 10)) + 15;
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Tabela de transa√ß√µes aprovadas
            const headers = ['#', 'Data', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira', 'Di√°rias'];
            const data = transacoesAprovadas.map((registro, index) => {
                // Formatar data
                let dataFormatada = registro['Data Transacao'] || '';
                if (dataFormatada.includes('2025-')) {
                    dataFormatada = dayjs(dataFormatada).format('DD/MM/YYYY HH:mm:ss');
                }
                
                return [
                    (index + 1).toString(),
                    dataFormatada,
                    `R$ ${(registro['Valor total da transacao_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    `R$ ${(registro['Valor Liquido_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    registro['N√∫mero do Cartao'] || '',
                    registro['Bandeira do Cartao'] || '',
                    (registro['Total Diarias_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                ];
            });
            
            // Configura√ß√µes da tabela
            const columnStyles = {
                0: { cellWidth: 10, halign: 'center' },
                1: { cellWidth: 30 },
                2: { cellWidth: 25, halign: 'right' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 30 },
                5: { cellWidth: 25 },
                6: { cellWidth: 20, halign: 'center' }
            };
            
            // Gerar tabela principal
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: {
                    fillColor: [46, 204, 113], // Verde para aprovadas
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                margin: { left: marginLeft, right: marginRight },
                columnStyles: columnStyles,
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                didDrawPage: function(data) {
                    // Adicionar n√∫mero da p√°gina
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(
                        `P√°gina ${data.pageNumber} de ${pageCount}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                    
                    // Adicionar rodap√©
                    doc.setFontSize(7);
                    doc.text(
                        'Relat√≥rio de Transa√ß√µes Aprovadas - B2B Reservas',
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: 'center' }
                    );
                }
            });
            
            // Adicionar totalizadores no final
            const finalY = doc.lastAutoTable.finalY + 10;
            if (finalY < pageHeight - 20) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                
                // Linha de totais
                doc.setDrawColor(46, 204, 113);
                doc.setLineWidth(0.5);
                doc.line(marginLeft, finalY - 5, pageWidth - marginRight, finalY - 5);
                
                doc.text('TOTAIS:', marginLeft, finalY);
                doc.text(`R$ ${valorTotalAprovadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, marginLeft + 100, finalY);
                doc.text(`R$ ${valorLiquidoAprovadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, pageWidth - marginRight, finalY, { align: 'right' });
            }
            
            // Salvar PDF
            const fileName = `relatorio_aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            
            mostrarNotificacao(`‚úÖ Relat√≥rio de transa√ß√µes aprovadas gerado com sucesso!\nüìÇ ${fileName}`, 'success');
        }
        
        // Gerar Todas as Filipetas Individuais - CORRIGIDA para usar formata√ß√£o num√©rica correta
        function gerarTodasFilipetas() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è N√£o h√° dados para gerar filipetas.', 'error');
                return;
            }
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    // Criar um PDF para cada transa√ß√£o
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 150] // Tamanho similar a uma filipeta
                    });
                    
                    // Para cada transa√ß√£o, criar uma p√°gina
                    dadosFiltrados.forEach((registro, index) => {
                        if (index > 0) {
                            doc.addPage([80, 150]); // Adicionar nova p√°gina para cada filipeta
                        }
                        
                        doc.setFont('helvetica');
                        
                        // Cabe√ßalho da filipeta
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('B2B RESERVAS', 40, 10, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.text('COMPROVANTE DE VENDA', 40, 15, { align: 'center' });
                        
                        // Linha separadora
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.5);
                        doc.line(5, 18, 75, 18);
                        
                        // Detalhes da transa√ß√£o
                        let yPos = 25;
                        
                        // Formatar data
                        let dataFormatada = registro['Data Transacao'] || '';
                        if (dataFormatada.includes('2025-')) {
                            dataFormatada = dayjs(dataFormatada).format('DD/MM/YYYY HH:mm:ss');
                        }
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Transa√ß√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(dataFormatada, 25, yPos);
                        yPos += 7;
                        
                        // Status com cor
                        doc.setFont('helvetica', 'bold');
                        doc.text('Status:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        const status = registro.Status || '';
                        if (status === 'Aprovada') {
                            doc.setTextColor(46, 204, 113); // Verde
                        } else if (status === 'Cancelada') {
                            doc.setTextColor(231, 76, 60); // Vermelho
                        } else {
                            doc.setTextColor(0, 0, 0); // Preto
                        }
                        doc.text(status, 25, yPos);
                        doc.setTextColor(0, 0, 0); // Resetar cor
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor Total:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${(registro['Valor total da transacao_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor L√≠quido:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${(registro['Valor Liquido_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Cart√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['N√∫mero do Cartao'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Bandeira:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Bandeira do Cartao'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Di√°rias:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text((registro['Total Diarias_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), 25, yPos);
                        yPos += 7;
                        
                        // Linha separadora
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.3);
                        doc.line(5, yPos, 75, yPos);
                        yPos += 5;
                        
                        // Informa√ß√µes adicionais
                        doc.setFontSize(7);
                        doc.text('Taxas e Comiss√µes:', 5, yPos);
                        yPos += 4;
                        
                        doc.text(`‚Ä¢ Comiss√µes: R$ ${(registro['Comissoes_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Taxa B2B: R$ ${(registro['Taxa de Servico B2B_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Adquirente: R$ ${(registro['Valor Adquirencia_NUM'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 10, yPos);
                        yPos += 5;
                        
                        // Rodap√©
                        doc.setFontSize(6);
                        doc.text('Sistema B2B Reservas - Comprovante n√£o fiscal', 40, 140, { align: 'center' });
                        doc.text(dayjs().format('DD/MM/YYYY HH:mm:ss'), 40, 143, { align: 'center' });
                        doc.text(`Transa√ß√£o ${index + 1} de ${dadosFiltrados.length}`, 40, 146, { align: 'center' });
                    });
                    
                    // Salvar PDF
                    const fileName = `filipetas_individuais_${dayjs().format('YYYY-MM-DD')}.pdf`;
                    doc.save(fileName);
                    
                    mostrarNotificacao(`‚úÖ ${dadosFiltrados.length} filipetas individuais geradas com sucesso!`, 'success');
                    
                } catch (error) {
                    mostrarNotificacao(`Erro ao gerar filipetas: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Inicializar aplica√ß√£o - CORRIGIDA para datas corretas
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar datas padr√£o para o M√äS DE NOVEMBRO (como na planilha)
            const hoje = dayjs();
            const primeiroDiaMes = dayjs('2025-11-01'); // For√ßar novembro 2025
            
            filterDataInicio.value = primeiroDiaMes.format('YYYY-MM-DD');
            filterDataFim.value = dayjs('2025-11-30').format('YYYY-MM-DD'); // Final de novembro
            
            // Carregar configura√ß√µes salvas
            carregarConfiguracoes();
            
            console.log('‚úÖ Sistema B2B PDF inicializado. Pronto para uso!');
            console.log('üìã Campos esperados:', CAMPOS_ESPERADOS);
        });
    </script>
</body>
</html>
