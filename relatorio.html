<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Reservas - Sistema de Relat√≥rios PDF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a6fa5;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .app-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 i {
            color: #3498db;
        }

        .file-upload {
            border: 2px dashed #3498db;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background-color: white;
        }

        .file-upload:hover {
            background-color: #e8f4fc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .file-upload input {
            display: none;
        }

        .upload-label {
            font-size: 1.4rem;
            color: #3498db;
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .file-info {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 1.2rem;
            padding: 16px 32px;
        }

        .btn-pdf:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            color: white;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card:nth-child(2) {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .summary-card:nth-child(3) {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .summary-card:nth-child(4) {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
            font-size: 1.2rem;
            background-color: white;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        .data-preview {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-preview th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-preview td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .data-preview tr:hover {
            background-color: #f8f9fa;
        }

        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .status-aprovada {
            color: #27ae60;
            font-weight: bold;
        }

        .status-cancelada {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-pendente {
            color: #f39c12;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .pdf-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .pdf-option-group {
            margin-bottom: 25px;
        }

        .pdf-option-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .pdf-option-group select,
        .pdf-option-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .logo-preview {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        /* √çcones */
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .icon-upload:before { content: "üìÅ"; }
        .icon-filter:before { content: "üîç"; }
        .icon-pdf:before { content: "üìä"; }
        .icon-clear:before { content: "üóëÔ∏è"; }
        .icon-export:before { content: "üíæ"; }
        .icon-print:before { content: "üñ®Ô∏è"; }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .notification-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        .notification-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px;
        }

        /* Op√ß√µes de relat√≥rio */
        .report-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-type-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .report-type-btn.active {
            border-color: #3498db;
            background-color: #e8f4fc;
            color: #3498db;
            font-weight: bold;
        }

        /* Estilo para preview melhorado */
        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .pdf-options-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .report-type-selector {
                flex-direction: column;
            }
            
            .report-type-btn {
                min-width: 100%;
            }
        }
    </style>
    <!-- Incluir bibliotecas necess√°rias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS para processar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- DayJS para manipula√ß√£o de datas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/locale/pt-br.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¶ SISTEMA DE RELAT√ìRIOS B2B RESERVAS</h1>
            <p class="subtitle">Gere filipetas de vendas POS e relat√≥rios detalhados</p>
        </header>

        <section class="app-section">
            <h2><span class="icon icon-upload"></span>1. CARREGAR ARQUIVO</h2>
            <div class="file-upload" id="dropArea">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.xlsm,.xlsb,.ods,.xltx,.xltm">
                <label for="fileInput" class="upload-label">
                    üìÇ CLIQUE PARA SELECIONAR OU ARRASTE SEU ARQUIVO
                </label>
                <p class="file-info">Formatos suportados: CSV, Excel (XLSX, XLS, XLSM, XLSB, ODS, XLTX, XLTM)</p>
                <p id="fileName" class="file-info">‚ö†Ô∏è Nenhum arquivo selecionado</p>
            </div>
            
            <div id="dataPreview" class="data-preview" style="display: none;">
                <h3>üìã Pr√©-visualiza√ß√£o dos Dados</h3>
                <table id="previewTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Data</th>
                            <th>Valor Total</th>
                            <th>Valor L√≠quido</th>
                            <th>Cart√£o</th>
                            <th>Di√°rias</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
                <div id="dataStats" class="data-stats"></div>
            </div>
        </section>

        <section class="app-section">
            <h2><span class="icon icon-filter"></span>2. FILTRAR DADOS</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterStatus">üìä Status</label>
                    <select id="filterStatus">
                        <option value="">Todos os Status</option>
                        <option value="Aprovada">‚úÖ Aprovada</option>
                        <option value="Cancelada">‚ùå Cancelada</option>
                        <option value="Pendente">‚è≥ Pendente</option>
                        <option value="Rejeitada">‚õî Rejeitada</option>
                        <option value="Estornada">‚Ü©Ô∏è Estornada</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterDataInicio">üìÖ Data Transa√ß√£o (De)</label>
                    <input type="date" id="filterDataInicio">
                </div>

                <div class="filter-group">
                    <label for="filterDataFim">üìÖ Data Transa√ß√£o (At√©)</label>
                    <input type="date" id="filterDataFim">
                </div>

                <div class="filter-group">
                    <label for="filterValorMin">üí∞ Valor M√≠nimo (R$)</label>
                    <input type="number" id="filterValorMin" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterValorMax">üí∞ Valor M√°ximo (R$)</label>
                    <input type="number" id="filterValorMax" placeholder="0,00" step="0.01" min="0">
                </div>

                <div class="filter-group">
                    <label for="filterBandeira">üí≥ Bandeira do Cart√£o</label>
                    <select id="filterBandeira">
                        <option value="">Todas as Bandeiras</option>
                        <option value="VISA">VISA</option>
                        <option value="MASTERCARD">MASTERCARD</option>
                        <option value="ELO">ELO</option>
                        <option value="AMEX">AMERICAN EXPRESS</option>
                        <option value="HIPERCARD">HIPERCARD</option>
                    </select>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-primary" id="btnFiltrar">
                    <span class="icon icon-filter"></span>APLICAR FILTROS
                </button>
                <button class="btn-secondary" id="btnLimparFiltros">
                    <span class="icon icon-clear"></span>LIMPAR FILTROS
                </button>
                <button class="btn-danger" id="btnExportarExcel">
                    <span class="icon icon-export"></span>EXPORTAR CSV
                </button>
            </div>
        </section>

        <section class="app-section">
            <h2><span class="icon icon-pdf"></span>3. RESUMO DO RELAT√ìRIO</h2>
            <div class="summary-grid" id="resumo">
                <div class="summary-card">
                    <div class="summary-value" id="totalTransacoes">0</div>
                    <div class="summary-label">Transa√ß√µes</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorTotal">R$ 0,00</div>
                    <div class="summary-label">Valor Total</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="valorLiquido">R$ 0,00</div>
                    <div class="summary-label">Valor L√≠quido</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="diariasTotal">0</div>
                    <div class="summary-label">Di√°rias Totais</div>
                </div>
            </div>
        </section>

        <section class="app-section">
            <h2><span class="icon icon-export"></span>4. GERAR RELAT√ìRIOS</h2>
            
            <div class="report-type-selector">
                <div class="report-type-btn active" id="btnFilipeta">
                    <span>üè∑Ô∏è</span> FILIPETA POS
                </div>
                <div class="report-type-btn" id="btnRelatorioDetalhado">
                    <span>üìä</span> RELAT√ìRIO DETALHADO
                </div>
                <div class="report-type-btn" id="btnResumoAprovadas">
                    <span>‚úÖ</span> RESUMO APROVADAS
                </div>
            </div>
            
            <p style="margin-bottom: 20px; font-size: 1.1rem; color: #2c3e50;">
                <strong>üéØ Filipeta POS:</strong> Relat√≥rio simplificado para cada transa√ß√£o, ideal para confer√™ncia di√°ria.<br>
                <strong>üìä Relat√≥rio Detalhado:</strong> Todos os campos para an√°lise completa em formato paisagem.<br>
                <strong>‚úÖ Resumo Aprovadas:</strong> Relat√≥rio de todas as transa√ß√µes aprovadas para impress√£o em papel filipeta.
            </p>
            
            <div class="buttons">
                <button class="btn-pdf" id="btnGerarPDF">
                    <span style="font-size: 1.4rem;">üìä</span> GERAR RELAT√ìRIO
                </button>
                <button class="btn-primary" id="btnConfigPDF">
                    <span class="icon icon-filter"></span> CONFIGURA√á√ïES
                </button>
                <button class="btn-secondary" id="btnGerarTodasFilipetas">
                    <span class="icon icon-print"></span> FILIPETAS INDIVIDUAIS
                </button>
            </div>
        </section>
    </div>

    <!-- Modal de Configura√ß√µes do PDF -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è CONFIGURA√á√ïES DO RELAT√ìRIO</h2>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            
            <div class="pdf-options-grid">
                <div class="pdf-option-group">
                    <label for="pdfTitle">üìù T√≠tulo do Relat√≥rio:</label>
                    <input type="text" id="pdfTitle" value="RELAT√ìRIO DE VENDAS B2B RESERVAS">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfSubtitle">üìù Subt√≠tulo:</label>
                    <input type="text" id="pdfSubtitle" value="Filipeta POS - Transa√ß√µes Detalhadas">
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfFontSize">üî§ Tamanho da Fonte:</label>
                    <select id="pdfFontSize">
                        <option value="8">Pequeno (8pt)</option>
                        <option value="9" selected>Normal (9pt)</option>
                        <option value="10">Grande (10pt)</option>
                        <option value="11">Muito Grande (11pt)</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfIncludeSummary">üìä Incluir Resumo:</label>
                    <select id="pdfIncludeSummary">
                        <option value="true" selected>‚úÖ Sim</option>
                        <option value="false">‚ùå N√£o</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfIncludeFilters">üîç Incluir Filtros Aplicados:</label>
                    <select id="pdfIncludeFilters">
                        <option value="true" selected>‚úÖ Sim</option>
                        <option value="false">‚ùå N√£o</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfOrientation">üìê Orienta√ß√£o da P√°gina:</label>
                    <select id="pdfOrientation">
                        <option value="portrait">üìÑ Retrato</option>
                        <option value="landscape" selected>üèûÔ∏è Paisagem</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfPaperSize">üìÑ Tamanho do Papel:</label>
                    <select id="pdfPaperSize">
                        <option value="a4">A4</option>
                        <option value="letter" selected>Carta</option>
                        <option value="legal">Legal</option>
                    </select>
                </div>
                
                <div class="pdf-option-group">
                    <label for="pdfMargins">üìè Margens:</label>
                    <select id="pdfMargins">
                        <option value="normal" selected>Normal</option>
                        <option value="small">Pequenas</option>
                        <option value="large">Grandes</option>
                        <option value="minimal">M√≠nimas</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons" style="margin-top: 30px; border: none;">
                <button class="btn-pdf" id="btnGerarPDFConfirmar" style="min-width: auto;">
                    üìä GERAR PDF
                </button>
                <button class="btn-secondary" id="btnCancelarPDF" style="min-width: auto;">
                    ‚Ü©Ô∏è CANCELAR
                </button>
                <button class="btn-primary" id="btnSalvarConfig" style="min-width: auto;">
                    üíæ SALVAR CONFIG
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay de Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; font-size: 1.2rem;">Processando dados...</p>
    </div>

    <script>
        // Configurar dayjs com locale brasileiro
        dayjs.locale('pt-br');
        
        // Configurar jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        
        // Configura√ß√µes persistentes
        const CONFIG_KEY = 'b2b_pdf_config';
        let config = {
            titulo: 'RELAT√ìRIO DE VENDAS B2B RESERVAS',
            subtitulo: 'Filipeta POS - Transa√ß√µes Detalhadas',
            fontSize: '9',
            includeSummary: true,
            includeFilters: true,
            orientation: 'landscape',
            paperSize: 'letter',
            margins: 'normal'
        };
        
        // Carregar configura√ß√µes salvas
        function carregarConfiguracoes() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
                try {
                    const loadedConfig = JSON.parse(saved);
                    config = { ...config, ...loadedConfig };
                    aplicarConfiguracoes();
                } catch (e) {
                    console.error('Erro ao carregar configura√ß√µes:', e);
                }
            }
        }
        
        // Aplicar configura√ß√µes carregadas
        function aplicarConfiguracoes() {
            pdfTitle.value = config.titulo;
            pdfSubtitle.value = config.subtitulo;
            pdfFontSize.value = config.fontSize;
            pdfIncludeSummary.value = config.includeSummary ? 'true' : 'false';
            pdfIncludeFilters.value = config.includeFilters ? 'true' : 'false';
            pdfOrientation.value = config.orientation;
            pdfPaperSize.value = config.paperSize;
            pdfMargins.value = config.margins;
        }
        
        // Salvar configura√ß√µes
        function salvarConfiguracoes() {
            config.titulo = pdfTitle.value;
            config.subtitulo = pdfSubtitle.value;
            config.fontSize = pdfFontSize.value;
            config.includeSummary = pdfIncludeSummary.value === 'true';
            config.includeFilters = pdfIncludeFilters.value === 'true';
            config.orientation = pdfOrientation.value;
            config.paperSize = pdfPaperSize.value;
            config.margins = pdfMargins.value;
            
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            mostrarNotificacao('Configura√ß√µes salvas com sucesso!', 'success');
        }
        
        // Vari√°veis globais
        let dadosOriginais = [];
        let dadosFiltrados = [];
        let tipoRelatorioAtual = 'filipeta'; // 'filipeta', 'detalhado', 'aprovadas'
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const fileName = document.getElementById('fileName');
        const dataPreview = document.getElementById('dataPreview');
        const previewBody = document.getElementById('previewBody');
        const dataStats = document.getElementById('dataStats');
        const pdfModal = document.getElementById('pdfModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Filtros
        const filterStatus = document.getElementById('filterStatus');
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        const filterValorMin = document.getElementById('filterValorMin');
        const filterValorMax = document.getElementById('filterValorMax');
        const filterBandeira = document.getElementById('filterBandeira');
        
        // Bot√µes de tipo de relat√≥rio
        const btnFilipeta = document.getElementById('btnFilipeta');
        const btnRelatorioDetalhado = document.getElementById('btnRelatorioDetalhado');
        const btnResumoAprovadas = document.getElementById('btnResumoAprovadas');
        
        // Bot√µes de a√ß√£o
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnLimparFiltros = document.getElementById('btnLimparFiltros');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnGerarPDF = document.getElementById('btnGerarPDF');
        const btnConfigPDF = document.getElementById('btnConfigPDF');
        const btnGerarTodasFilipetas = document.getElementById('btnGerarTodasFilipetas');
        const btnGerarPDFConfirmar = document.getElementById('btnGerarPDFConfirmar');
        const btnCancelarPDF = document.getElementById('btnCancelarPDF');
        const btnSalvarConfig = document.getElementById('btnSalvarConfig');
        const closeModal = document.getElementById('closeModal');
        
        // Configura√ß√µes PDF
        const pdfTitle = document.getElementById('pdfTitle');
        const pdfSubtitle = document.getElementById('pdfSubtitle');
        const pdfFontSize = document.getElementById('pdfFontSize');
        const pdfIncludeSummary = document.getElementById('pdfIncludeSummary');
        const pdfIncludeFilters = document.getElementById('pdfIncludeFilters');
        const pdfOrientation = document.getElementById('pdfOrientation');
        const pdfPaperSize = document.getElementById('pdfPaperSize');
        const pdfMargins = document.getElementById('pdfMargins');
        
        // Resumo
        const totalTransacoes = document.getElementById('totalTransacoes');
        const valorTotal = document.getElementById('valorTotal');
        const valorLiquido = document.getElementById('valorLiquido');
        const diariasTotal = document.getElementById('diariasTotal');
        
        // Event Listeners
        fileInput.addEventListener('change', handleFileUpload);
        btnFiltrar.addEventListener('click', aplicarFiltros);
        btnLimparFiltros.addEventListener('click', limparFiltros);
        btnExportarExcel.addEventListener('click', exportarParaExcel);
        btnGerarPDF.addEventListener('click', abrirModalPDF);
        btnConfigPDF.addEventListener('click', abrirModalPDF);
        btnGerarTodasFilipetas.addEventListener('click', gerarTodasFilipetas);
        btnGerarPDFConfirmar.addEventListener('click', gerarPDF);
        btnCancelarPDF.addEventListener('click', fecharModalPDF);
        btnSalvarConfig.addEventListener('click', salvarConfiguracoes);
        closeModal.addEventListener('click', fecharModalPDF);
        
        // Event listeners para tipo de relat√≥rio
        btnFilipeta.addEventListener('click', () => selecionarTipoRelatorio('filipeta'));
        btnRelatorioDetalhado.addEventListener('click', () => selecionarTipoRelatorio('detalhado'));
        btnResumoAprovadas.addEventListener('click', () => selecionarTipoRelatorio('aprovadas'));
        
        // Fechar modal ao clicar fora
        window.addEventListener('click', (event) => {
            if (event.target === pdfModal) {
                fecharModalPDF();
            }
        });
        
        // Fun√ß√µes de utilit√°rio
        function mostrarLoading(mostrar) {
            loadingOverlay.style.display = mostrar ? 'flex' : 'none';
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            // Remove notifica√ß√£o anterior se existir
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) notifAnterior.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${tipo}`;
            notification.innerHTML = `
                <strong>${tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong>
                ${mensagem}
            `;
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => notification.remove(), 5000);
        }
        
        // Fun√ß√£o para selecionar tipo de relat√≥rio
        function selecionarTipoRelatorio(tipo) {
            tipoRelatorioAtual = tipo;
            
            // Atualizar bot√µes ativos
            [btnFilipeta, btnRelatorioDetalhado, btnResumoAprovadas].forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tipo === 'filipeta') btnFilipeta.classList.add('active');
            if (tipo === 'detalhado') btnRelatorioDetalhado.classList.add('active');
            if (tipo === 'aprovadas') btnResumoAprovadas.classList.add('active');
            
            // Atualizar texto do bot√£o principal
            const btnTexto = {
                'filipeta': 'GERAR FILIPETA POS',
                'detalhado': 'GERAR RELAT√ìRIO DETALHADO',
                'aprovadas': 'GERAR RESUMO APROVADAS'
            };
            
            btnGerarPDF.innerHTML = `<span style="font-size: 1.4rem;">üìä</span> ${btnTexto[tipo]}`;
        }
        
        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.backgroundColor = '#e8f4fc';
        }
        
        function unhighlight() {
            dropArea.style.backgroundColor = '';
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                fileInput.files = files;
                handleFileUpload();
            }
        }
        
        // Fun√ß√£o principal para processar upload de arquivo
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            // Valida√ß√£o de tamanho (m√°ximo 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                mostrarNotificacao('Arquivo muito grande. Tamanho m√°ximo: 10MB', 'error');
                return;
            }
            
            // Valida√ß√£o de extens√£o
            const extensoesPermitidas = ['.csv', '.xlsx', '.xls', '.xlsm', '.xlsb', '.ods', '.xltx', '.xltm'];
            const extensao = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!extensoesPermitidas.includes(extensao)) {
                mostrarNotificacao('Formato de arquivo n√£o suportado. Use CSV ou Excel.', 'error');
                return;
            }
            
            fileName.textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            fileName.style.color = '#27ae60';
            
            mostrarLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    
                    if (extensao === '.csv') {
                        processarCSV(data);
                    } else {
                        processarExcel(data);
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro ao processar arquivo: ${error.message}`, 'error');
                    console.error(error);
                    limparDados();
                } finally {
                    mostrarLoading(false);
                }
            };
            
            // Se for CSV, l√™ como texto, caso contr√°rio, l√™ como array buffer
            if (extensao === '.csv') {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Limpar dados
        function limparDados() {
            dadosOriginais = [];
            dadosFiltrados = [];
            dataPreview.style.display = 'none';
            atualizarResumo();
        }
        
        // Processar Excel usando SheetJS
        function processarExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Converter para JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1,
                    raw: false,
                    dateNF: 'dd/mm/yyyy',
                    defval: ''
                });
                
                if (jsonData.length < 2) {
                    mostrarNotificacao('Arquivo Excel vazio ou inv√°lido', 'error');
                    limparDados();
                    return;
                }
                
                // A primeira linha √© o cabe√ßalho
                const cabecalhos = jsonData[0].map(h => String(h).trim());
                
                // Processar linhas de dados
                dadosOriginais = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const linha = jsonData[i];
                    if (!linha || linha.length === 0) continue;
                    
                    const registro = {};
                    
                    // Mapear cada coluna
                    cabecalhos.forEach((cabecalho, index) => {
                        let valor = linha[index];
                        
                        // Converter datas do Excel para formato leg√≠vel
                        if (valor instanceof Date) {
                            valor = dayjs(valor).format('DD/MM/YYYY HH:mm:ss');
                        } else if (typeof valor === 'string') {
                            valor = valor.trim();
                        } else if (typeof valor === 'number') {
                            // Se for um n√∫mero de data Excel (formato OADate)
                            if (cabecalho.includes('Data') && valor > 25569) {
                                const dataExcel = new Date((valor - 25569) * 86400 * 1000);
                                valor = dayjs(dataExcel).format('DD/MM/YYYY HH:mm:ss');
                            }
                        }
                        
                        registro[cabecalho] = valor || '';
                    });
                    
                    // Converter valores num√©ricos
                    converterValoresNumericos(registro);
                    
                    // Validar registro
                    if (validarRegistro(registro)) {
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado no arquivo', 'error');
                    limparDados();
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao(`Erro ao processar Excel: ${error.message}`, 'error');
                console.error(error);
                limparDados();
            }
        }
        
        // Processar CSV
        function processarCSV(content) {
            try {
                const linhas = content.split('\n');
                
                if (linhas.length < 2) {
                    mostrarNotificacao('Arquivo CSV vazio ou inv√°lido', 'error');
                    limparDados();
                    return;
                }
                
                // Detecta o separador (v√≠rgula ou ponto-e-v√≠rgula)
                const primeiraLinha = linhas[0];
                const temPontoVirgula = primeiraLinha.split(';').length > primeiraLinha.split(',').length;
                const separador = temPontoVirgula ? ';' : ',';
                
                // Extrair cabe√ßalhos
                const cabecalhos = primeiraLinha.split(separador).map(h => h.trim().replace(/"/g, ''));
                
                // Processar linhas de dados
                dadosOriginais = [];
                
                for (let i = 1; i < linhas.length; i++) {
                    if (linhas[i].trim() === '') continue;
                    
                    const valores = parseCSVLine(linhas[i], separador);
                    const registro = {};
                    
                    cabecalhos.forEach((cabecalho, index) => {
                        let valor = valores[index] ? valores[index].trim().replace(/"/g, '') : '';
                        registro[cabecalho] = valor;
                    });
                    
                    // Converter valores num√©ricos
                    converterValoresNumericos(registro);
                    
                    // Validar registro
                    if (validarRegistro(registro)) {
                        dadosOriginais.push(registro);
                    }
                }
                
                if (dadosOriginais.length === 0) {
                    mostrarNotificacao('Nenhum dado v√°lido encontrado no arquivo', 'error');
                    limparDados();
                    return;
                }
                
                dadosFiltrados = [...dadosOriginais];
                mostrarPreviaDados();
                atualizarResumo();
                atualizarFiltrosBandeira();
                
                mostrarNotificacao(`${dadosOriginais.length} registros carregados com sucesso!`, 'success');
                
            } catch (error) {
                mostrarNotificacao(`Erro ao processar CSV: ${error.message}`, 'error');
                console.error(error);
                limparDados();
            }
        }
        
        // Fun√ß√£o para fazer parse de linha CSV
        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.replace(/^"+|"+$/g, ''));
        }
        
        // Validar registro
        function validarRegistro(registro) {
            // Verificar se tem pelo menos alguns dados essenciais
            const camposRequeridos = ['Data Transacao', 'Valor total da transacao'];
            
            for (const campo of camposRequeridos) {
                if (!registro[campo] || registro[campo].toString().trim() === '') {
                    return false;
                }
            }
            
            return true;
        }
        
        // Converter valores num√©ricos
        function converterValoresNumericos(registro) {
            // Identificar campos que provavelmente s√£o num√©ricos
            Object.keys(registro).forEach(campo => {
                if (typeof registro[campo] === 'string') {
                    const valorStr = registro[campo].trim();
                    
                    // Verificar se parece ser um valor monet√°rio ou num√©rico
                    if (valorStr.match(/^[R$]?\s*[\d.,]+\s*$/) || 
                        campo.toLowerCase().includes('valor') ||
                        campo.toLowerCase().includes('total') ||
                        campo.toLowerCase().includes('taxa') ||
                        campo.toLowerCase().includes('comiss') ||
                        campo.toLowerCase().includes('diaria') ||
                        campo.toLowerCase().includes('imposto')) {
                        
                        // Remover R$, pontos e converter v√≠rgula decimal
                        let valor = valorStr
                            .replace('R$', '')
                            .replace(/\./g, '')
                            .replace(',', '.')
                            .trim();
                        
                        const valorNumerico = parseFloat(valor);
                        if (!isNaN(valorNumerico)) {
                            registro[`${campo}_NUM`] = valorNumerico;
                        }
                    }
                }
            });
        }
        
        // Mostrar pr√©via dos dados
        function mostrarPreviaDados() {
            if (dadosOriginais.length === 0) {
                dataPreview.style.display = 'none';
                return;
            }
            
            dataPreview.style.display = 'block';
            previewBody.innerHTML = '';
            
            const limite = Math.min(10, dadosOriginais.length);
            
            for (let i = 0; i < limite; i++) {
                const registro = dadosOriginais[i];
                const tr = document.createElement('tr');
                
                // Determinar classe de status
                let statusClass = '';
                if (registro.Status === 'Aprovada') statusClass = 'status-aprovada';
                else if (registro.Status === 'Cancelada') statusClass = 'status-cancelada';
                else if (registro.Status === 'Pendente') statusClass = 'status-pendente';
                
                tr.innerHTML = `
                    <td class="${statusClass}">${registro.Status || 'N/A'}</td>
                    <td>${registro['Data Transacao'] || 'N/A'}</td>
                    <td class="currency">R$ ${(registro['Valor total da transacao_NUM'] || 0).toFixed(2)}</td>
                    <td class="currency">R$ ${(registro['Valor Liquido_NUM'] || 0).toFixed(2)}</td>
                    <td>${registro['N√∫mero do Cartao'] || registro['Cart√£o'] || 'N/A'}</td>
                    <td>${registro['Total Diarias'] || registro['Di√°rias'] || '0'}</td>
                `;
                
                previewBody.appendChild(tr);
            }
            
            // Atualizar estat√≠sticas
            atualizarEstatisticasPrevia();
        }
        
        // Atualizar estat√≠sticas da pr√©via
        function atualizarEstatisticasPrevia() {
            const total = dadosOriginais.length;
            const aprovadas = dadosOriginais.filter(r => r.Status === 'Aprovada').length;
            const canceladas = dadosOriginais.filter(r => r.Status === 'Cancelada').length;
            const valorMedio = dadosOriginais.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0) / total;
            
            dataStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total de Transa√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${aprovadas}</div>
                    <div class="stat-label">Aprovadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${canceladas}</div>
                    <div class="stat-label">Canceladas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">R$ ${valorMedio.toFixed(2)}</div>
                    <div class="stat-label">Valor M√©dio</div>
                </div>
            `;
        }
        
        // Atualizar filtros de bandeira
        function atualizarFiltrosBandeira() {
            const bandeiras = new Set();
            
            dadosOriginais.forEach(registro => {
                const bandeira = registro['Bandeira do Cartao'] || registro['Bandeira'];
                if (bandeira && bandeira.trim() !== '') {
                    bandeiras.add(bandeira.trim());
                }
            });
            
            // Limpar op√ß√µes existentes (exceto a primeira)
            while (filterBandeira.options.length > 1) {
                filterBandeira.remove(1);
            }
            
            // Adicionar bandeiras encontradas
            Array.from(bandeiras).sort().forEach(bandeira => {
                const option = document.createElement('option');
                option.value = bandeira;
                option.textContent = bandeira;
                filterBandeira.appendChild(option);
            });
        }
        
        // Abrir modal de configura√ß√µes do PDF
        function abrirModalPDF() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Por favor, carregue um arquivo primeiro.', 'error');
                return;
            }
            
            pdfModal.style.display = 'block';
        }
        
        // Fechar modal
        function fecharModalPDF() {
            pdfModal.style.display = 'none';
        }
        
        // Parsear data
        function parsearData(dataString) {
            if (!dataString || dataString.trim() === '') return null;
            
            try {
                // Formato: DD/MM/YYYY HH:MM:SS
                if (dataString.includes('/')) {
                    const [datePart, timePart] = dataString.split(' ');
                    const [day, month, year] = datePart.split('/');
                    
                    if (timePart) {
                        const [hours, minutes, seconds] = timePart.split(':');
                        return new Date(year, month - 1, day, hours || 0, minutes || 0, seconds || 0);
                    }
                    return new Date(year, month - 1, day);
                }
                // Formato: YYYY-MM-DD
                else if (dataString.includes('-')) {
                    return new Date(dataString);
                }
                
                return null;
            } catch (error) {
                console.error('Erro ao parsear data:', dataString, error);
                return null;
            }
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            if (dadosOriginais.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Por favor, carregue um arquivo primeiro.', 'error');
                return;
            }
            
            dadosFiltrados = dadosOriginais.filter(registro => {
                // Filtro por status
                if (filterStatus.value && registro.Status !== filterStatus.value) {
                    return false;
                }
                
                // Filtro por bandeira
                if (filterBandeira.value) {
                    const bandeiraRegistro = registro['Bandeira do Cartao'] || registro['Bandeira'];
                    if (bandeiraRegistro !== filterBandeira.value) {
                        return false;
                    }
                }
                
                // Filtro por data
                if (filterDataInicio.value && registro['Data Transacao']) {
                    const dataTransacao = parsearData(registro['Data Transacao']);
                    const dataInicio = new Date(filterDataInicio.value);
                    
                    if (dataTransacao && dataTransacao < dataInicio) {
                        return false;
                    }
                }
                
                if (filterDataFim.value && registro['Data Transacao']) {
                    const dataTransacao = parsearData(registro['Data Transacao']);
                    const dataFim = new Date(filterDataFim.value);
                    dataFim.setHours(23, 59, 59, 999);
                    
                    if (dataTransacao && dataTransacao > dataFim) {
                        return false;
                    }
                }
                
                // Filtro por valor
                const valorTotal = registro['Valor total da transacao_NUM'] || 0;
                
                if (filterValorMin.value && valorTotal < parseFloat(filterValorMin.value)) {
                    return false;
                }
                
                if (filterValorMax.value && valorTotal > parseFloat(filterValorMax.value)) {
                    return false;
                }
                
                return true;
            });
            
            atualizarResumo();
            mostrarNotificacao(`‚úÖ Filtros aplicados: ${dadosFiltrados.length} transa√ß√µes encontradas.`, 'success');
        }
        
        // Limpar filtros
        function limparFiltros() {
            filterStatus.value = '';
            filterDataInicio.value = '';
            filterDataFim.value = '';
            filterValorMin.value = '';
            filterValorMax.value = '';
            filterBandeira.value = '';
            
            dadosFiltrados = [...dadosOriginais];
            atualizarResumo();
            
            mostrarNotificacao('‚úÖ Filtros limpos. Todos os dados restaurados.', 'success');
        }
        
        // Atualizar resumo
        function atualizarResumo() {
            if (dadosFiltrados.length === 0) {
                totalTransacoes.textContent = '0';
                valorTotal.textContent = 'R$ 0,00';
                valorLiquido.textContent = 'R$ 0,00';
                diariasTotal.textContent = '0';
                return;
            }
            
            // Calcular totais
            const total = dadosFiltrados.length;
            
            const valorTotalSum = dadosFiltrados.reduce((sum, registro) => {
                return sum + (registro['Valor total da transacao_NUM'] || 0);
            }, 0);
            
            const valorLiquidoSum = dadosFiltrados.reduce((sum, registro) => {
                return sum + (registro['Valor Liquido_NUM'] || 0);
            }, 0);
            
            const diariasSum = dadosFiltrados.reduce((sum, registro) => {
                return sum + (registro['Total Diarias_NUM'] || 0);
            }, 0);
            
            // Atualizar elementos
            totalTransacoes.textContent = total.toLocaleString();
            valorTotal.textContent = `R$ ${valorTotalSum.toFixed(2).replace('.', ',')}`;
            valorLiquido.textContent = `R$ ${valorLiquidoSum.toFixed(2).replace('.', ',')}`;
            diariasTotal.textContent = diariasSum.toLocaleString();
        }
        
        // Exportar para Excel
        function exportarParaExcel() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('N√£o h√° dados para exportar.', 'error');
                return;
            }
            
            // Definir colunas para exporta√ß√£o
            const colunasExport = [
                'Status',
                'Data Transacao',
                'Data Recebimento',
                'Total Diarias',
                'Valor Extras',
                'Valor Taxas',
                'Valor Impostos',
                'Valor total da transacao',
                'Tipo Tarifa',
                'Valor Comissoes',
                'Taxa de Servico B2B',
                'Valor Adquirencia',
                'Valor Liquido',
                'N√∫mero do Cartao',
                'Bandeira do Cartao'
            ];
            
            // Converter dados para formato CSV
            const cabecalhos = colunasExport.join(';');
            const linhas = dadosFiltrados.map(registro => {
                return colunasExport.map(coluna => {
                    let valor = registro[coluna] || '';
                    // Formatar valores monet√°rios
                    if (registro[`${coluna}_NUM`] !== undefined) {
                        valor = `R$ ${registro[`${coluna}_NUM`].toFixed(2).replace('.', ',')}`;
                    }
                    // Escapar ponto e v√≠rgula
                    if (typeof valor === 'string' && valor.includes(';')) {
                        valor = `"${valor}"`;
                    }
                    return valor;
                }).join(';');
            });
            
            const conteudoCSV = [cabecalhos, ...linhas].join('\n');
            
            // Criar blob e link de download
            const blob = new Blob(['\uFEFF' + conteudoCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_b2b_${dayjs().format('YYYY-MM-DD')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('‚úÖ Arquivo CSV exportado com sucesso!', 'success');
        }
        
        // Gerar PDF (principal)
        function gerarPDF() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è N√£o h√° dados para gerar o relat√≥rio.', 'error');
                return;
            }
            
            fecharModalPDF();
            salvarConfiguracoes();
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    switch(tipoRelatorioAtual) {
                        case 'filipeta':
                            gerarPDFFilipeta();
                            break;
                        case 'detalhado':
                            gerarPDFDetalhado();
                            break;
                        case 'aprovadas':
                            gerarPDFResumoAprovadas();
                            break;
                        default:
                            gerarPDFFilipeta();
                    }
                } catch (error) {
                    mostrarNotificacao(`Erro ao gerar PDF: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Gerar PDF Filipeta POS
        function gerarPDFFilipeta() {
            // Obter configura√ß√µes
            const titulo = pdfTitle.value || 'FILIPETA DE VENDAS POS - B2B RESERVAS';
            const subtitulo = pdfSubtitle.value || 'Resumo de Transa√ß√µes para Confer√™ncia';
            const fontSize = parseInt(pdfFontSize.value);
            const includeSummary = pdfIncludeSummary.value === 'true';
            const includeFilters = pdfIncludeFilters.value === 'true';
            const orientation = pdfOrientation.value;
            const paperSize = pdfPaperSize.value;
            const margins = pdfMargins.value;
            
            // Configurar margens
            let marginLeft, marginRight, marginTop, marginBottom;
            switch(margins) {
                case 'small':
                    marginLeft = marginRight = marginTop = marginBottom = 10;
                    break;
                case 'large':
                    marginLeft = marginRight = marginTop = marginBottom = 25;
                    break;
                case 'minimal':
                    marginLeft = marginRight = marginTop = marginBottom = 5;
                    break;
                default:
                    marginLeft = marginRight = marginTop = marginBottom = 15;
            }
            
            // Criar documento PDF
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: paperSize
            });
            
            // Configurar fonte
            doc.setFont('helvetica');
            doc.setFontSize(fontSize);
            
            // Posi√ß√£o inicial
            let yPos = marginTop;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            // Cabe√ßalho do relat√≥rio
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('üè¶ B2B RESERVAS', marginLeft, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text('FILIPETA DE VENDAS POS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Relat√≥rio para confer√™ncia di√°ria', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Data de gera√ß√£o
            const dataGeracao = dayjs().format('DD/MM/YYYY HH:mm:ss');
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, yPos - 15, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Resumo r√°pido
            if (includeSummary) {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMO:', marginLeft, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const totalTrans = dadosFiltrados.length;
                const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
                const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
                const aprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada').length;
                
                doc.text(`‚Ä¢ Total de Transa√ß√µes: ${totalTrans}`, marginLeft + 5, yPos);
                yPos += 5;
                doc.text(`‚Ä¢ Aprovadas: ${aprovadas}`, marginLeft + 5, yPos);
                yPos += 5;
                doc.text(`‚Ä¢ Valor Bruto: R$ ${valorTotalSum.toFixed(2).replace('.', ',')}`, marginLeft + 5, yPos);
                yPos += 5;
                doc.text(`‚Ä¢ Valor L√≠quido: R$ ${valorLiquidoSum.toFixed(2).replace('.', ',')}`, marginLeft + 5, yPos);
                yPos += 10;
            }
            
            // Filtros aplicados
            if (includeFilters) {
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('FILTROS APLICADOS:', marginLeft, yPos);
                yPos += 7;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                let filtrosTexto = [];
                if (filterStatus.value) filtrosTexto.push(`Status: ${filterStatus.value}`);
                if (filterBandeira.value) filtrosTexto.push(`Bandeira: ${filterBandeira.value}`);
                if (filterDataInicio.value || filterDataFim.value) {
                    filtrosTexto.push(`Per√≠odo: ${filterDataInicio.value || ''} at√© ${filterDataFim.value || ''}`);
                }
                if (filterValorMin.value || filterValorMax.value) {
                    filtrosTexto.push(`Valor: R$ ${filterValorMin.value || '0,00'} - R$ ${filterValorMax.value || '0,00'}`);
                }
                
                if (filtrosTexto.length === 0) {
                    filtrosTexto.push('Nenhum filtro aplicado');
                }
                
                filtrosTexto.forEach(filtro => {
                    if (yPos > pageHeight - marginBottom - 10) {
                        doc.addPage([pageWidth, pageHeight]);
                        yPos = marginTop;
                    }
                    doc.text(`‚Ä¢ ${filtro}`, marginLeft + 5, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Tabela de transa√ß√µes (simplificada)
            const headers = ['#', 'Data/Hora', 'Status', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira'];
            const data = dadosFiltrados.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    registro.Status || '',
                    `R$ ${(registro['Valor total da transacao_NUM'] || 0).toFixed(2).replace('.', ',')}`,
                    `R$ ${(registro['Valor Liquido_NUM'] || 0).toFixed(2).replace('.', ',')}`,
                    registro['N√∫mero do Cartao'] || registro['Cart√£o'] || '',
                    registro['Bandeira do Cartao'] || registro['Bandeira'] || ''
                ];
            });
            
            // Configura√ß√µes da tabela
            const columnStyles = {
                0: { cellWidth: 10, halign: 'center' },
                1: { cellWidth: 35 },
                2: { cellWidth: 20, halign: 'center' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 25, halign: 'right' },
                5: { cellWidth: 35 },
                6: { cellWidth: 25 }
            };
            
            // Gerar tabela principal
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: {
                    fillColor: [52, 152, 219],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                margin: { left: marginLeft, right: marginRight, top: yPos },
                columnStyles: columnStyles,
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                didDrawPage: function(data) {
                    // Adicionar n√∫mero da p√°gina
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(
                        `P√°gina ${data.pageNumber} de ${pageCount}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                    
                    // Adicionar rodap√©
                    doc.setFontSize(7);
                    doc.text(
                        'B2B Reservas - Sistema de Relat√≥rios de Vendas',
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: 'center' }
                    );
                }
            });
            
            // Salvar PDF
            const fileName = `filipeta_pos_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            
            mostrarNotificacao(`‚úÖ Filipeta POS gerada com sucesso!\nüìÇ ${fileName}`, 'success');
        }
        
        // Gerar PDF Detalhado
        function gerarPDFDetalhado() {
            // Obter configura√ß√µes
            const titulo = pdfTitle.value || 'RELAT√ìRIO DETALHADO - B2B RESERVAS';
            const subtitulo = pdfSubtitle.value || 'Transa√ß√µes Completas - Formato Paisagem';
            const fontSize = parseInt(pdfFontSize.value);
            const includeSummary = pdfIncludeSummary.value === 'true';
            const includeFilters = pdfIncludeFilters.value === 'true';
            const orientation = 'landscape'; // For√ßar paisagem para relat√≥rio detalhado
            const paperSize = pdfPaperSize.value;
            const margins = pdfMargins.value;
            
            // Configurar margens
            let marginLeft, marginRight, marginTop, marginBottom;
            switch(margins) {
                case 'small':
                    marginLeft = marginRight = marginTop = marginBottom = 10;
                    break;
                case 'large':
                    marginLeft = marginRight = marginTop = marginBottom = 25;
                    break;
                case 'minimal':
                    marginLeft = marginRight = marginTop = marginBottom = 5;
                    break;
                default:
                    marginLeft = marginRight = marginTop = marginBottom = 15;
            }
            
            // Criar documento PDF
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: paperSize
            });
            
            // Configurar fonte
            doc.setFont('helvetica');
            doc.setFontSize(fontSize);
            
            // Posi√ß√£o inicial
            let yPos = marginTop;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            
            // Cabe√ßalho do relat√≥rio
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('üè¶ B2B RESERVAS', marginLeft, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text(titulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(subtitulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Data de gera√ß√£o
            const dataGeracao = dayjs().format('DD/MM/YYYY HH:mm:ss');
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, yPos - 15, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Resumo r√°pido
            if (includeSummary) {
                const totalTrans = dadosFiltrados.length;
                const valorTotalSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
                const valorLiquidoSum = dadosFiltrados.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
                const aprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada').length;
                const canceladas = dadosFiltrados.filter(r => r.Status === 'Cancelada').length;
                
                // Criar mini tabela de resumo
                const summaryData = [
                    ['Transa√ß√µes', 'Aprovadas', 'Canceladas', 'Valor Total', 'Valor L√≠quido'],
                    [
                        totalTrans.toString(),
                        aprovadas.toString(),
                        canceladas.toString(),
                        `R$ ${valorTotalSum.toFixed(2).replace('.', ',')}`,
                        `R$ ${valorLiquidoSum.toFixed(2).replace('.', ',')}`
                    ]
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [summaryData[0]],
                    body: [summaryData[1]],
                    theme: 'grid',
                    headStyles: {
                        fillColor: [52, 152, 219],
                        textColor: 255,
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        fontSize: 11,
                        fontStyle: 'bold',
                        textColor: [44, 62, 80]
                    },
                    margin: { left: marginLeft, right: marginRight },
                    tableWidth: 'auto'
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
            }
            
            // Filtros aplicados
            if (includeFilters) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('FILTROS APLICADOS:', marginLeft, yPos);
                yPos += 7;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                let filtrosTexto = [];
                if (filterStatus.value) filtrosTexto.push(`Status: ${filterStatus.value}`);
                if (filterBandeira.value) filtrosTexto.push(`Bandeira: ${filterBandeira.value}`);
                if (filterDataInicio.value || filterDataFim.value) {
                    filtrosTexto.push(`Per√≠odo: ${filterDataInicio.value || ''} at√© ${filterDataFim.value || ''}`);
                }
                if (filterValorMin.value || filterValorMax.value) {
                    filtrosTexto.push(`Valor: R$ ${filterValorMin.value || '0,00'} - R$ ${filterValorMax.value || '0,00'}`);
                }
                
                if (filtrosTexto.length === 0) {
                    filtrosTexto.push('Nenhum filtro aplicado');
                }
                
                filtrosTexto.forEach(filtro => {
                    doc.text(`‚Ä¢ ${filtro}`, marginLeft + 5, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // Tabela detalhada
            // Identificar todas as colunas dispon√≠veis nos dados
            const todasColunas = new Set();
            dadosFiltrados.forEach(registro => {
                Object.keys(registro).forEach(key => {
                    if (!key.endsWith('_NUM')) {
                        todasColunas.add(key);
                    }
                });
            });
            
            // Selecionar colunas mais importantes para o relat√≥rio detalhado
            const colunasImportantes = [
                'Status',
                'Data Transacao',
                'Data Recebimento',
                'Total Diarias',
                'Valor Extras',
                'Valor Taxas',
                'Valor Impostos',
                'Valor total da transacao',
                'Tipo Tarifa',
                'Valor Comissoes',
                'Taxa de Servico B2B',
                'Valor Adquirencia',
                'Valor Liquido',
                'N√∫mero do Cartao',
                'Bandeira do Cartao'
            ];
            
            // Filtrar colunas que existem nos dados
            const headers = colunasImportantes.filter(coluna => 
                Array.from(todasColunas).some(tc => 
                    tc.toLowerCase().includes(coluna.toLowerCase().replace(/_/g, ' ')) ||
                    coluna.toLowerCase().includes(tc.toLowerCase().replace(/_/g, ' '))
                )
            );
            
            // Se n√£o encontrou as colunas padr√£o, usar as que existem
            if (headers.length === 0) {
                headers.push(...Array.from(todasColunas).slice(0, 10));
            }
            
            const data = dadosFiltrados.map(registro => {
                return headers.map(coluna => {
                    // Encontrar o nome exato da coluna nos dados
                    const chaveExata = Array.from(todasColunas).find(tc => 
                        tc.toLowerCase().includes(coluna.toLowerCase().replace(/_/g, ' ')) ||
                        coluna.toLowerCase().includes(tc.toLowerCase().replace(/_/g, ' '))
                    );
                    
                    let valor = registro[chaveExata] || '';
                    
                    // Formatar valores num√©ricos
                    if (registro[`${chaveExata}_NUM`] !== undefined) {
                        valor = `R$ ${registro[`${chaveExata}_NUM`].toFixed(2).replace('.', ',')}`;
                    }
                    
                    return valor;
                });
            });
            
            // Gerar tabela principal
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: 255,
                    fontSize: fontSize,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: fontSize - 1,
                    cellPadding: 3
                },
                margin: { left: marginLeft, right: marginRight },
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                didDrawPage: function(data) {
                    // Adicionar n√∫mero da p√°gina
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(
                        `P√°gina ${data.pageNumber} de ${pageCount}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                }
            });
            
            // Salvar PDF
            const fileName = `relatorio_detalhado_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            
            mostrarNotificacao(`‚úÖ Relat√≥rio detalhado gerado com sucesso!\nüìÇ ${fileName}`, 'success');
        }
        
        // Gerar PDF Resumo Aprovadas (Filipeta com todas as transa√ß√µes aprovadas)
        function gerarPDFResumoAprovadas() {
            // Filtrar apenas transa√ß√µes aprovadas
            const transacoesAprovadas = dadosFiltrados.filter(r => r.Status === 'Aprovada');
            
            if (transacoesAprovadas.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è N√£o h√° transa√ß√µes aprovadas para gerar o relat√≥rio.', 'error');
                return;
            }
            
            // Obter configura√ß√µes
            const titulo = 'RELAT√ìRIO DE TRANSA√á√ïES APROVADAS';
            const subtitulo = 'Resumo Completo - Formato Filipeta';
            const fontSize = parseInt(pdfFontSize.value);
            const paperSize = 'a4';
            const orientation = 'portrait';
            
            // Criar documento PDF
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: paperSize
            });
            
            // Configurar fonte
            doc.setFont('helvetica');
            doc.setFontSize(fontSize);
            
            // Posi√ß√£o inicial
            let yPos = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const marginLeft = 15;
            const marginRight = 15;
            
            // Cabe√ßalho do relat√≥rio
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('‚úÖ B2B RESERVAS', marginLeft, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text(titulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(subtitulo, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Data de gera√ß√£o
            const dataGeracao = dayjs().format('DD/MM/YYYY HH:mm:ss');
            doc.setFontSize(9);
            doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, yPos - 15, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(46, 204, 113); // Verde para aprovadas
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Resumo estat√≠stico das aprovadas
            const totalAprovadas = transacoesAprovadas.length;
            const valorTotalAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor total da transacao_NUM'] || 0), 0);
            const valorLiquidoAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Valor Liquido_NUM'] || 0), 0);
            const diariasAprovadas = transacoesAprovadas.reduce((sum, r) => sum + (r['Total Diarias_NUM'] || 0), 0);
            const valorMedioAprovadas = valorTotalAprovadas / totalAprovadas;
            
            // Criar cart√µes de resumo
            const summaryCards = [
                { label: 'Transa√ß√µes Aprovadas', value: totalAprovadas.toString(), color: [46, 204, 113] },
                { label: 'Valor Total', value: `R$ ${valorTotalAprovadas.toFixed(2).replace('.', ',')}`, color: [52, 152, 219] },
                { label: 'Valor L√≠quido', value: `R$ ${valorLiquidoAprovadas.toFixed(2).replace('.', ',')}`, color: [155, 89, 182] },
                { label: 'Di√°rias Totais', value: diariasAprovadas.toString(), color: [241, 196, 15] },
                { label: 'Valor M√©dio', value: `R$ ${valorMedioAprovadas.toFixed(2).replace('.', ',')}`, color: [230, 126, 34] },
                { label: 'Ticket M√©dio', value: `R$ ${(valorLiquidoAprovadas / totalAprovadas).toFixed(2).replace('.', ',')}`, color: [231, 76, 60] }
            ];
            
            // Desenhar cart√µes de resumo
            const cardWidth = (pageWidth - marginLeft - marginRight - 20) / 3;
            const cardHeight = 25;
            
            summaryCards.forEach((card, index) => {
                const row = Math.floor(index / 3);
                const col = index % 3;
                const x = marginLeft + (col * (cardWidth + 10));
                const y = yPos + (row * (cardHeight + 10));
                
                // Fundo do cart√£o
                doc.setFillColor(card.color[0], card.color[1], card.color[2]);
                doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'F');
                
                // Texto do cart√£o
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(card.value, x + cardWidth / 2, y + 10, { align: 'center' });
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(card.label, x + cardWidth / 2, y + 16, { align: 'center' });
            });
            
            yPos += (Math.ceil(summaryCards.length / 3) * (cardHeight + 10)) + 15;
            
            // Linha separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // Tabela de transa√ß√µes aprovadas
            const headers = ['#', 'Data', 'Valor Total', 'Valor L√≠quido', 'Cart√£o', 'Bandeira', 'Di√°rias'];
            const data = transacoesAprovadas.map((registro, index) => {
                return [
                    (index + 1).toString(),
                    registro['Data Transacao'] || '',
                    `R$ ${(registro['Valor total da transacao_NUM'] || 0).toFixed(2).replace('.', ',')}`,
                    `R$ ${(registro['Valor Liquido_NUM'] || 0).toFixed(2).replace('.', ',')}`,
                    registro['N√∫mero do Cartao'] || registro['Cart√£o'] || '',
                    registro['Bandeira do Cartao'] || registro['Bandeira'] || '',
                    registro['Total Diarias'] || registro['Di√°rias'] || '0'
                ];
            });
            
            // Configura√ß√µes da tabela
            const columnStyles = {
                0: { cellWidth: 10, halign: 'center' },
                1: { cellWidth: 30 },
                2: { cellWidth: 25, halign: 'right' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 30 },
                5: { cellWidth: 25 },
                6: { cellWidth: 20, halign: 'center' }
            };
            
            // Gerar tabela principal
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: data,
                theme: 'grid',
                headStyles: {
                    fillColor: [46, 204, 113], // Verde para aprovadas
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                margin: { left: marginLeft, right: marginRight },
                columnStyles: columnStyles,
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                didDrawPage: function(data) {
                    // Adicionar n√∫mero da p√°gina
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(
                        `P√°gina ${data.pageNumber} de ${pageCount}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                    
                    // Adicionar rodap√©
                    doc.setFontSize(7);
                    doc.text(
                        'Relat√≥rio de Transa√ß√µes Aprovadas - B2B Reservas',
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: 'center' }
                    );
                }
            });
            
            // Adicionar totalizadores no final
            const finalY = doc.lastAutoTable.finalY + 10;
            if (finalY < pageHeight - 20) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                
                // Linha de totais
                doc.setDrawColor(46, 204, 113);
                doc.setLineWidth(0.5);
                doc.line(marginLeft, finalY - 5, pageWidth - marginRight, finalY - 5);
                
                doc.text('TOTAIS:', marginLeft, finalY);
                doc.text(`R$ ${valorTotalAprovadas.toFixed(2).replace('.', ',')}`, marginLeft + 100, finalY);
                doc.text(`R$ ${valorLiquidoAprovadas.toFixed(2).replace('.', ',')}`, pageWidth - marginRight, finalY, { align: 'right' });
            }
            
            // Salvar PDF
            const fileName = `relatorio_aprovadas_${dayjs().format('YYYY-MM-DD_HHmm')}.pdf`;
            doc.save(fileName);
            
            mostrarNotificacao(`‚úÖ Relat√≥rio de transa√ß√µes aprovadas gerado com sucesso!\nüìÇ ${fileName}`, 'success');
        }
        
        // Gerar Todas as Filipetas Individuais
        function gerarTodasFilipetas() {
            if (dadosFiltrados.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è N√£o h√° dados para gerar filipetas.', 'error');
                return;
            }
            
            mostrarLoading(true);
            
            setTimeout(() => {
                try {
                    // Criar um PDF para cada transa√ß√£o
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 150] // Tamanho similar a uma filipeta
                    });
                    
                    // Para cada transa√ß√£o, criar uma p√°gina
                    dadosFiltrados.forEach((registro, index) => {
                        if (index > 0) {
                            doc.addPage([80, 150]); // Adicionar nova p√°gina para cada filipeta
                        }
                        
                        doc.setFont('helvetica');
                        
                        // Cabe√ßalho da filipeta
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('B2B RESERVAS', 40, 10, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.text('COMPROVANTE DE VENDA', 40, 15, { align: 'center' });
                        
                        // Linha separadora
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.5);
                        doc.line(5, 18, 75, 18);
                        
                        // Detalhes da transa√ß√£o
                        let yPos = 25;
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Transa√ß√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Data Transacao'] || '', 25, yPos);
                        yPos += 7;
                        
                        // Status com cor
                        doc.setFont('helvetica', 'bold');
                        doc.text('Status:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        const status = registro.Status || '';
                        if (status === 'Aprovada') {
                            doc.setTextColor(46, 204, 113); // Verde
                        } else if (status === 'Cancelada') {
                            doc.setTextColor(231, 76, 60); // Vermelho
                        } else {
                            doc.setTextColor(0, 0, 0); // Preto
                        }
                        doc.text(status, 25, yPos);
                        doc.setTextColor(0, 0, 0); // Resetar cor
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor Total:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${(registro['Valor total da transacao_NUM'] || 0).toFixed(2).replace('.', ',')}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Valor L√≠quido:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`R$ ${(registro['Valor Liquido_NUM'] || 0).toFixed(2).replace('.', ',')}`, 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Cart√£o:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['N√∫mero do Cartao'] || registro['Cart√£o'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Bandeira:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Bandeira do Cartao'] || registro['Bandeira'] || '', 25, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text('Di√°rias:', 5, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(registro['Total Diarias'] || registro['Di√°rias'] || '0', 25, yPos);
                        yPos += 7;
                        
                        // Linha separadora
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.3);
                        doc.line(5, yPos, 75, yPos);
                        yPos += 5;
                        
                        // Informa√ß√µes adicionais
                        doc.setFontSize(7);
                        doc.text('Taxas e Comiss√µes:', 5, yPos);
                        yPos += 4;
                        
                        doc.text(`‚Ä¢ Comiss√µes: R$ ${(registro['Valor Comissoes_NUM'] || 0).toFixed(2).replace('.', ',')}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Taxa B2B: R$ ${(registro['Taxa de Servico B2B_NUM'] || 0).toFixed(2).replace('.', ',')}`, 10, yPos);
                        yPos += 3.5;
                        
                        doc.text(`‚Ä¢ Adquirente: R$ ${(registro['Valor Adquirencia_NUM'] || 0).toFixed(2).replace('.', ',')}`, 10, yPos);
                        yPos += 5;
                        
                        // Rodap√©
                        doc.setFontSize(6);
                        doc.text('Sistema B2B Reservas - Comprovante n√£o fiscal', 40, 140, { align: 'center' });
                        doc.text(dayjs().format('DD/MM/YYYY HH:mm:ss'), 40, 143, { align: 'center' });
                        doc.text(`Transa√ß√£o ${index + 1} de ${dadosFiltrados.length}`, 40, 146, { align: 'center' });
                    });
                    
                    // Salvar PDF
                    const fileName = `filipetas_individuais_${dayjs().format('YYYY-MM-DD')}.pdf`;
                    doc.save(fileName);
                    
                    mostrarNotificacao(`‚úÖ ${dadosFiltrados.length} filipetas individuais geradas com sucesso!`, 'success');
                    
                } catch (error) {
                    mostrarNotificacao(`Erro ao gerar filipetas: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    mostrarLoading(false);
                }
            }, 100);
        }
        
        // Inicializar aplica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar datas padr√£o
            const hoje = dayjs();
            const primeiroDiaMes = hoje.startOf('month');
            
            filterDataInicio.value = primeiroDiaMes.format('YYYY-MM-DD');
            filterDataFim.value = hoje.format('YYYY-MM-DD');
            
            // Carregar configura√ß√µes salvas
            carregarConfiguracoes();
            
            console.log('‚úÖ Sistema B2B PDF inicializado. Pronto para uso!');
        });
    </script>
</body>
</html>
