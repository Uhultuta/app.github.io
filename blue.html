<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impressora JP-80H Bluetooth</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px 25px;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-label {
            font-weight: 600;
            color: #495057;
        }

        #status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-offline {
            background: #dc3545;
            color: white;
        }

        .status-online {
            background: #28a745;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .device-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }

        .device-item {
            padding: 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-item:hover {
            background: #e9ecef;
        }

        .device-item.active {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-control {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        textarea.form-control {
            width: 100%;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 150px;
        }

        .quick-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .command-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .btn-command {
            padding: 12px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-command:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }

        .log-container {
            height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .log-entry.info {
            color: #17a2b8;
        }

        footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }

        .warning {
            color: #ffc107;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: white;
        }

        .close:hover {
            color: #ffc107;
        }

        .modal-body {
            padding: 20px;
        }

        #modalDeviceList {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .modal-footer {
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            .command-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #323232;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Impressora JP-80H Bluetooth</h1>
            <p class="subtitle">Controle via Web Bluetooth API</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Status:</span>
                <span id="status" class="status-offline">Desconectado</span>
            </div>
            <div class="status-item">
                <span class="status-label">Impressora:</span>
                <span id="deviceName">Nenhuma</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Painel de Controle -->
            <div class="control-panel">
                <div class="section">
                    <h2><i class="fas fa-bluetooth-b"></i> Conexão Bluetooth</h2>
                    
                    <div class="button-group">
                        <button id="btnConnect" class="btn btn-primary">
                            <i class="fas fa-link"></i> Conectar Impressora
                        </button>
                        <button id="btnDisconnect" class="btn btn-secondary" disabled>
                            <i class="fas fa-unlink"></i> Desconectar
                        </button>
                        <button id="btnScan" class="btn btn-info">
                            <i class="fas fa-search"></i> Buscar Dispositivos
                        </button>
                    </div>

                    <div id="deviceList" class="device-list">
                        <!-- Lista de dispositivos aparecerá aqui -->
                    </div>
                </div>

                <div class="section">
                    <h2><i class="fas fa-sliders-h"></i> Configurações</h2>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="fontSize">Tamanho da Fonte:</label>
                            <select id="fontSize" class="form-control">
                                <option value="normal">Normal</option>
                                <option value="double-height">Dupla Altura</option>
                                <option value="double-width">Dupla Largura</option>
                                <option value="double-both">Duplo Ambos</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <label for="alignment">Alinhamento:</label>
                            <select id="alignment" class="form-control">
                                <option value="left">Esquerda</option>
                                <option value="center">Centro</option>
                                <option value="right">Direita</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <label for="bold">Estilo:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="bold"> Negrito
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="underline"> Sublinhado
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Impressão -->
            <div class="print-panel">
                <div class="section">
                    <h2><i class="fas fa-edit"></i> Texto para Impressão</h2>
                    
                    <div class="form-group">
                        <label for="printText">Conteúdo:</label>
                        <textarea id="printText" class="form-control" rows="8" 
                                  placeholder="Digite o texto para impressão...">
================================
   LOJA EXEMPLO - RECIBO
================================
Produto 1          R$ 10,00
Produto 2          R$ 20,00
Produto 3          R$ 15,50
================================
TOTAL              R$ 45,50
================================
Obrigado pela preferência!
                        </textarea>
                    </div>

                    <div class="quick-buttons">
                        <button id="btnPrintTest" class="btn btn-success">
                            <i class="fas fa-print"></i> Imprimir Teste
                        </button>
                        <button id="btnPrintCustom" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Imprimir Personalizado
                        </button>
                        <button id="btnClear" class="btn btn-warning">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>

                <div class="section">
                    <h2><i class="fas fa-barcode"></i> Comandos Rápidos</h2>
                    
                    <div class="command-grid">
                        <button class="btn-command" data-command="feed">
                            <i class="fas fa-arrow-down"></i> Avançar Papel
                        </button>
                        <button class="btn-command" data-command="cut">
                            <i class="fas fa-cut"></i> Cortar Papel
                        </button>
                        <button class="btn-command" data-command="beep">
                            <i class="fas fa-bell"></i> Bip Sonoro
                        </button>
                        <button class="btn-command" data-command="qrcode">
                            <i class="fas fa-qrcode"></i> QR Code Teste
                        </button>
                        <button class="btn-command" data-command="barcode">
                            <i class="fas fa-barcode"></i> Código de Barras
                        </button>
                        <button class="btn-command" data-command="init">
                            <i class="fas fa-sync"></i> Inicializar
                        </button>
                    </div>
                </div>

                <div class="section">
                    <h2><i class="fas fa-history"></i> Log de Atividades</h2>
                    <div id="log" class="log-container">
                        <div class="log-entry">Aguardando conexão...</div>
                    </div>
                    <button id="btnClearLog" class="btn btn-small">
                        <i class="fas fa-trash"></i> Limpar Log
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>JP-80H Bluetooth Web Controller v1.0 | Compatível com Chrome/Edge</p>
            <p class="warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Requer Web Bluetooth API habilitada
            </p>
        </footer>
    </div>

    <!-- Modal para dispositivos -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bluetooth-b"></i> Dispositivos Bluetooth</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalDeviceList"></div>
                <div class="modal-footer">
                    <button id="btnRefresh" class="btn btn-info">
                        <i class="fas fa-redo"></i> Atualizar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para mensagens -->
    <div id="toast" class="toast"></div>

    <script>
        // Comandos ESC/POS para impressora térmica
        class EscPosCommands {
            // Inicialização
            static INIT = [0x1B, 0x40];
            
            // Alinhamento
            static ALIGN_LEFT = [0x1B, 0x61, 0x00];
            static ALIGN_CENTER = [0x1B, 0x61, 0x01];
            static ALIGN_RIGHT = [0x1B, 0x61, 0x02];
            
            // Estilos de fonte
            static FONT_NORMAL = [0x1B, 0x4D, 0x00];
            static FONT_COMPRESSED = [0x1B, 0x4D, 0x01];
            
            // Tamanhos
            static SIZE_NORMAL = [0x1D, 0x21, 0x00];
            static SIZE_DOUBLE_HEIGHT = [0x1B, 0x21, 0x10];
            static SIZE_DOUBLE_WIDTH = [0x1B, 0x21, 0x20];
            static SIZE_DOUBLE_BOTH = [0x1B, 0x21, 0x30];
            
            // Estilos
            static BOLD_ON = [0x1B, 0x45, 0x01];
            static BOLD_OFF = [0x1B, 0x45, 0x00];
            static UNDERLINE_ON = [0x1B, 0x2D, 0x01];
            static UNDERLINE_OFF = [0x1B, 0x2D, 0x00];
            
            // Alimentação de papel
            static LINE_FEED = [0x0A];
            static FEED_LINES = (n) => [0x1B, 0x64, n];
            
            // Corte de papel
            static CUT_PAPER = [0x1D, 0x56, 0x41, 0x00];
            static CUT_PAPER_FULL = [0x1D, 0x56, 0x00];
            
            // Bip sonoro
            static BEEP = [0x1B, 0x42, 0x05, 0x05];
            
            // QR Code
            static QR_CODE_MODEL = [0x1D, 0x28, 0x6B, 0x04, 0x00, 0x31, 0x41, 0x32, 0x00];
            static QR_CODE_SIZE = (size) => [0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x43, size];
            static QR_CODE_ERROR_CORRECTION = (level) => [0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x45, level];
            static QR_CODE_STORE = (data) => {
                const len = data.length + 3;
                return [0x1D, 0x28, 0x6B, len % 256, Math.floor(len / 256), 0x31, 0x50, 0x30]
                    .concat(Array.from(data).map(c => c.charCodeAt(0)));
            };
            static QR_CODE_PRINT = [0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x51, 0x30];
            
            // Código de barras
            static BARCODE_TYPE_CODE128 = [0x1D, 0x6B, 0x49];
            static BARCODE_HEIGHT = (height) => [0x1D, 0x68, height];
            static BARCODE_WIDTH = [0x1D, 0x77, 0x02];
            static BARCODE_TEXT_BELOW = [0x1D, 0x48, 0x02];
            static BARCODE_DATA = (data) => data.split('').map(c => c.charCodeAt(0)).concat([0x00]);
            
            // Método para criar um recibo
            static createReceipt(header, items, total, footer) {
                let commands = [];
                
                // Inicializar
                commands.push(...this.INIT);
                commands.push(...this.ALIGN_CENTER);
                commands.push(...this.SIZE_DOUBLE_HEIGHT);
                
                // Cabeçalho
                commands.push(...this.textToBytes(header));
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.SIZE_NORMAL);
                commands.push(...this.ALIGN_LEFT);
                commands.push(...this.textToBytes("================================"));
                commands.push(...this.LINE_FEED);
                
                // Itens
                items.forEach(item => {
                    commands.push(...this.textToBytes(item));
                    commands.push(...this.LINE_FEED);
                });
                
                commands.push(...this.textToBytes("================================"));
                commands.push(...this.LINE_FEED);
                
                // Total
                commands.push(...this.BOLD_ON);
                commands.push(...this.textToBytes(`TOTAL: ${total}`));
                commands.push(...this.BOLD_OFF);
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                
                // Rodapé
                commands.push(...this.ALIGN_CENTER);
                commands.push(...this.textToBytes(footer));
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                
                // Cortar papel
                commands.push(...this.CUT_PAPER);
                
                return new Uint8Array(commands);
            }
            
            // Converter texto para bytes
            static textToBytes(text) {
                return Array.from(text).map(c => c.charCodeAt(0));
            }
            
            // Gerar teste de impressão
            static generateTestPrint() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('pt-BR');
                const timeStr = now.toLocaleTimeString('pt-BR');
                
                let commands = [];
                
                commands.push(...this.INIT);
                commands.push(...this.ALIGN_CENTER);
                commands.push(...this.SIZE_DOUBLE_BOTH);
                commands.push(...this.BOLD_ON);
                commands.push(...this.textToBytes("TESTE DE IMPRESSÃO"));
                commands.push(...this.BOLD_OFF);
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.SIZE_NORMAL);
                commands.push(...this.textToBytes("JP-80H Bluetooth"));
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.ALIGN_LEFT);
                commands.push(...this.textToBytes("Data: " + dateStr));
                commands.push(...this.LINE_FEED);
                commands.push(...this.textToBytes("Hora: " + timeStr));
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.textToBytes("--------------------------------"));
                commands.push(...this.LINE_FEED);
                
                // Tabela de teste
                const items = [
                    "Produto 1          R$ 10,00",
                    "Produto 2          R$ 20,00",
                    "Produto 3          R$ 15,50",
                    "Produto 4          R$  8,75"
                ];
                
                items.forEach(item => {
                    commands.push(...this.textToBytes(item));
                    commands.push(...this.LINE_FEED);
                });
                
                commands.push(...this.textToBytes("--------------------------------"));
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.BOLD_ON);
                commands.push(...this.textToBytes("TOTAL: R$ 54,25"));
                commands.push(...this.BOLD_OFF);
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.ALIGN_CENTER);
                commands.push(...this.textToBytes("Teste concluído com sucesso!"));
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                commands.push(...this.LINE_FEED);
                
                commands.push(...this.CUT_PAPER);
                
                return new Uint8Array(commands);
            }
        }

        // Bluetooth Printer Controller
        class BluetoothPrinter {
            constructor() {
                this.device = null;
                this.server = null;
                this.service = null;
                this.characteristic = null;
                this.isConnected = false;
                
                // UUIDs para Bluetooth SPP (Serial Port Profile)
                this.SERVICE_UUID = '00001101-0000-1000-8000-00805f9b34fb';
                this.CHARACTERISTIC_UUID = '00001101-0000-1000-8000-00805f9b34fb';
            }
            
            // Solicitar dispositivo Bluetooth
            async requestDevice() {
                try {
                    if (!navigator.bluetooth) {
                        throw new Error('Web Bluetooth API não suportada neste navegador.');
                    }
                    
                    this.log('Procurando dispositivos Bluetooth...', 'info');
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { name: 'JP' },
                            { name: 'BT' },
                            { namePrefix: 'JP' },
                            { namePrefix: 'BT' }
                        ],
                        optionalServices: [this.SERVICE_UUID]
                    });
                    
                    this.device = device;
                    this.log(`Dispositivo selecionado: ${device.name}`, 'success');
                    
                    // Adicionar listeners
                    device.addEventListener('gattserverdisconnected', () => {
                        this.onDisconnected();
                    });
                    
                    return device;
                } catch (error) {
                    if (error.name === 'NotFoundError') {
                        this.log('Nenhum dispositivo encontrado.', 'error');
                        showToast('Nenhum dispositivo Bluetooth encontrado. Certifique-se que a impressora está ligada e visível.');
                    } else if (error.name === 'SecurityError') {
                        this.log('Permissão Bluetooth negada.', 'error');
                        showToast('Permissão Bluetooth negada. Por favor, conceda permissão para usar Bluetooth.');
                    } else if (error.name === 'AbortError') {
                        this.log('Seleção de dispositivo cancelada.', 'info');
                    } else {
                        this.log(`Erro: ${error.message}`, 'error');
                        showToast(`Erro: ${error.message}`);
                    }
                    throw error;
                }
            }
            
            // Conectar ao dispositivo
            async connect() {
                if (!this.device) {
                    throw new Error('Nenhum dispositivo selecionado.');
                }
                
                try {
                    this.log('Conectando...', 'info');
                    showToast('Conectando à impressora...');
                    
                    this.server = await this.device.gatt.connect();
                    this.log('Conectado ao servidor GATT', 'success');
                    
                    // Obter serviço
                    this.service = await this.server.getPrimaryService(this.SERVICE_UUID);
                    this.log('Serviço obtido', 'success');
                    
                    // Obter característica
                    this.characteristic = await this.service.getCharacteristic(this.CHARACTERISTIC_UUID);
                    this.log('Característica obtida', 'success');
                    
                    this.isConnected = true;
                    const msg = `Conectado com sucesso a ${this.device.name}!`;
                    this.log(msg, 'success');
                    showToast(msg);
                    
                    return true;
                } catch (error) {
                    const errMsg = `Falha na conexão: ${error.message}`;
                    this.log(errMsg, 'error');
                    showToast(errMsg, 'error');
                    this.isConnected = false;
                    throw error;
                }
            }
            
            // Desconectar
            async disconnect() {
                if (!this.device) return;
                
                try {
                    if (this.device.gatt.connected) {
                        await this.device.gatt.disconnect();
                    }
                    this.onDisconnected();
                    this.log('Desconectado', 'info');
                    showToast('Desconectado da impressora');
                } catch (error) {
                    this.log(`Erro ao desconectar: ${error.message}`, 'error');
                }
            }
            
            // Handler de desconexão
            onDisconnected() {
                this.isConnected = false;
                this.device = null;
                this.server = null;
                this.service = null;
                this.characteristic = null;
                this.log('Dispositivo desconectado', 'error');
                window.dispatchEvent(new CustomEvent('printerDisconnected'));
            }
            
            // Enviar dados para impressora
            async sendData(data) {
                if (!this.isConnected || !this.characteristic) {
                    throw new Error('Não conectado à impressora.');
                }
                
                try {
                    // Garantir que estamos conectados
                    if (!this.device.gatt.connected) {
                        await this.connect();
                    }
                    
                    // Enviar dados
                    await this.characteristic.writeValue(data);
                    this.log('Dados enviados para impressora', 'success');
                    return true;
                } catch (error) {
                    this.log(`Erro ao enviar dados: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            // Enviar texto simples
            async printText(text, options = {}) {
                let commands = [];
                
                // Configurar formatação
                commands.push(...EscPosCommands.INIT);
                
                // Alinhamento
                switch(options.alignment || 'left') {
                    case 'left':
                        commands.push(...EscPosCommands.ALIGN_LEFT);
                        break;
                    case 'center':
                        commands.push(...EscPosCommands.ALIGN_CENTER);
                        break;
                    case 'right':
                        commands.push(...EscPosCommands.ALIGN_RIGHT);
                        break;
                }
                
                // Tamanho da fonte
                switch(options.fontSize || 'normal') {
                    case 'normal':
                        commands.push(...EscPosCommands.SIZE_NORMAL);
                        break;
                    case 'double-height':
                        commands.push(...EscPosCommands.SIZE_DOUBLE_HEIGHT);
                        break;
                    case 'double-width':
                        commands.push(...EscPosCommands.SIZE_DOUBLE_WIDTH);
                        break;
                    case 'double-both':
                        commands.push(...EscPosCommands.SIZE_DOUBLE_BOTH);
                        break;
                }
                
                // Estilos
                if (options.bold) {
                    commands.push(...EscPosCommands.BOLD_ON);
                }
                if (options.underline) {
                    commands.push(...EscPosCommands.UNDERLINE_ON);
                }
                
                // Adicionar texto
                commands.push(...EscPosCommands.textToBytes(text));
                
                // Resetar estilos
                if (options.bold) {
                    commands.push(...EscPosCommands.BOLD_OFF);
                }
                if (options.underline) {
                    commands.push(...EscPosCommands.UNDERLINE_OFF);
                }
                
                // Linhas extras e corte
                if (options.lineFeed !== false) {
                    commands.push(...EscPosCommands.LINE_FEED);
                    commands.push(...EscPosCommands.LINE_FEED);
                }
                
                if (options.cutPaper) {
                    commands.push(...EscPosCommands.CUT_PAPER);
                }
                
                // Converter para Uint8Array e enviar
                const data = new Uint8Array(commands);
                return await this.sendData(data);
            }
            
            // Enviar comando específico
            async sendCommand(command) {
                let data;
                
                switch(command) {
                    case 'feed':
                        data = new Uint8Array([...EscPosCommands.LINE_FEED, ...EscPosCommands.LINE_FEED]);
                        break;
                    case 'cut':
                        data = new Uint8Array(EscPosCommands.CUT_PAPER);
                        break;
                    case 'beep':
                        data = new Uint8Array(EscPosCommands.BEEP);
                        break;
                    case 'init':
                        data = new Uint8Array(EscPosCommands.INIT);
                        break;
                    case 'qrcode':
                        await this.printQRCode('https://github.com/jp80h-web-printer', 'Teste QR Code');
                        return;
                    case 'barcode':
                        await this.printBarcode('123456789012');
                        return;
                    default:
                        throw new Error(`Comando desconhecido: ${command}`);
                }
                
                return await this.sendData(data);
            }
            
            // Imprimir QR Code
            async printQRCode(data, label = '') {
                let commands = [];
                
                commands.push(...EscPosCommands.INIT);
                commands.push(...EscPosCommands.ALIGN_CENTER);
                
                // Configurar QR Code
                commands.push(...EscPosCommands.QR_CODE_MODEL);
                commands.push(...EscPosCommands.QR_CODE_SIZE(6));
                commands.push(...EscPosCommands.QR_CODE_ERROR_CORRECTION(48));
                
                // Armazenar dados
                commands.push(...EscPosCommands.QR_CODE_STORE(data));
                
                // Imprimir
                commands.push(...EscPosCommands.QR_CODE_PRINT);
                
                // Adicionar label se fornecido
                if (label) {
                    commands.push(...EscPosCommands.LINE_FEED);
                    commands.push(...EscPosCommands.textToBytes(label));
                }
                
                commands.push(...EscPosCommands.LINE_FEED);
                commands.push(...EscPosCommands.LINE_FEED);
                
                const qrData = new Uint8Array(commands);
                return await this.sendData(qrData);
            }
            
            // Imprimir código de barras
            async printBarcode(data, type = 'CODE128') {
                let commands = [];
                
                commands.push(...EscPosCommands.INIT);
                commands.push(...EscPosCommands.ALIGN_CENTER);
                
                // Configurar código de barras
                commands.push(...EscPosCommands.BARCODE_HEIGHT(50));
                commands.push(...EscPosCommands.BARCODE_WIDTH);
                commands.push(...EscPosCommands.BARCODE_TEXT_BELOW);
                
                // Selecionar tipo
                if (type === 'CODE128') {
                    commands.push(...EscPosCommands.BARCODE_TYPE_CODE128);
                }
                
                // Adicionar dados
                commands.push(...EscPosCommands.BARCODE_DATA(data));
                
                commands.push(...EscPosCommands.LINE_FEED);
                commands.push(...EscPosCommands.LINE_FEED);
                
                const barcodeData = new Uint8Array(commands);
                return await this.sendData(barcodeData);
            }
            
            // Imprimir recibo de teste
            async printTest() {
                const testData = EscPosCommands.generateTestPrint();
                return await this.sendData(testData);
            }
            
            // Método de log
            log(message, type = 'info') {
                const event = new CustomEvent('printerLog', {
                    detail: { message, type, timestamp: new Date() }
                });
                window.dispatchEvent(event);
            }
        }

        // App principal
        document.addEventListener('DOMContentLoaded', function() {
            const printer = new BluetoothPrinter();
            
            // Elementos DOM
            const elements = {
                status: document.getElementById('status'),
                deviceName: document.getElementById('deviceName'),
                btnConnect: document.getElementById('btnConnect'),
                btnDisconnect: document.getElementById('btnDisconnect'),
                btnScan: document.getElementById('btnScan'),
                btnPrintTest: document.getElementById('btnPrintTest'),
                btnPrintCustom: document.getElementById('btnPrintCustom'),
                btnClear: document.getElementById('btnClear'),
                printText: document.getElementById('printText'),
                log: document.getElementById('log'),
                deviceList: document.getElementById('deviceList'),
                modal: document.getElementById('deviceModal'),
                modalDeviceList: document.getElementById('modalDeviceList'),
                btnRefresh: document.getElementById('btnRefresh'),
                btnClearLog: document.getElementById('btnClearLog'),
                fontSize: document.getElementById('fontSize'),
                alignment: document.getElementById('alignment'),
                bold: document.getElementById('bold'),
                underline: document.getElementById('underline'),
                commandButtons: document.querySelectorAll('.btn-command'),
                toast: document.getElementById('toast')
            };
            
            // Estado da aplicação
            let appState = {
                connected: false,
                currentDevice: null,
                devices: []
            };
            
            // Função para mostrar toast
            function showToast(message, type = 'info') {
                elements.toast.textContent = message;
                elements.toast.style.display = 'block';
                elements.toast.style.background = type === 'error' ? '#dc3545' : 
                                                 type === 'success' ? '#28a745' : '#323232';
                
                setTimeout(() => {
                    elements.toast.style.display = 'none';
                }, 3000);
            }
            
            // Configurar listeners de log
            window.addEventListener('printerLog', (event) => {
                addLog(event.detail.message, event.detail.type);
            });
            
            // Listener para desconexão
            window.addEventListener('printerDisconnected', () => {
                updateConnectionStatus();
            });
            
            // Inicializar interface
            function initUI() {
                updateConnectionStatus();
                
                // Configurar evento para fechar modal
                document.querySelector('.close').addEventListener('click', () => {
                    elements.modal.style.display = 'none';
                });
                
                // Fechar modal ao clicar fora
                window.addEventListener('click', (event) => {
                    if (event.target === elements.modal) {
                        elements.modal.style.display = 'none';
                    }
                });
            }
            
            // Atualizar status da conexão
            function updateConnectionStatus() {
                if (printer.isConnected && printer.device) {
                    elements.status.textContent = 'Conectado';
                    elements.status.className = 'status-online';
                    elements.deviceName.textContent = printer.device.name;
                    
                    elements.btnConnect.disabled = true;
                    elements.btnDisconnect.disabled = false;
                    elements.btnPrintTest.disabled = false;
                    elements.btnPrintCustom.disabled = false;
                    
                    // Habilitar botões de comando
                    elements.commandButtons.forEach(btn => btn.disabled = false);
                } else {
                    elements.status.textContent = 'Desconectado';
                    elements.status.className = 'status-offline';
                    elements.deviceName.textContent = 'Nenhuma';
                    
                    elements.btnConnect.disabled = false;
                    elements.btnDisconnect.disabled = true;
                    elements.btnPrintTest.disabled = true;
                    elements.btnPrintCustom.disabled = true;
                    
                    // Desabilitar botões de comando
                    elements.commandButtons.forEach(btn => btn.disabled = true);
                }
            }
            
            // Adicionar mensagem ao log
            function addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                
                elements.log.appendChild(logEntry);
                
                // Auto-scroll para baixo
                elements.log.scrollTop = elements.log.scrollHeight;
            }
            
            // Conectar à impressora
            async function connectToPrinter() {
                try {
                    elements.btnConnect.innerHTML = '<div class="loading"></div> Conectando...';
                    elements.btnConnect.disabled = true;
                    
                    addLog('Solicitando dispositivo Bluetooth...', 'info');
                    await printer.requestDevice();
                    
                    addLog('Conectando ao dispositivo...', 'info');
                    await printer.connect();
                    
                    appState.connected = true;
                    appState.currentDevice = printer.device;
                    
                    updateConnectionStatus();
                } catch (error) {
                    addLog(`Erro: ${error.message}`, 'error');
                } finally {
                    elements.btnConnect.innerHTML = '<i class="fas fa-link"></i> Conectar Impressora';
                    elements.btnConnect.disabled = false;
                }
            }
            
            // Desconectar impressora
            async function disconnectPrinter() {
                try {
                    await printer.disconnect();
                    
                    appState.connected = false;
                    appState.currentDevice = null;
                    
                    updateConnectionStatus();
                } catch (error) {
                    addLog(`Erro: ${error.message}`, 'error');
                }
            }
            
            // Imprimir teste
            async function printTest() {
                if (!printer.isConnected) {
                    addLog('Conecte-se a uma impressora primeiro', 'error');
                    showToast('Conecte-se a uma impressora primeiro', 'error');
                    return;
                }
                
                try {
                    elements.btnPrintTest.innerHTML = '<div class="loading"></div> Imprimindo...';
                    elements.btnPrintTest.disabled = true;
                    
                    addLog('Enviando teste de impressão...', 'info');
                    await printer.printTest();
                    addLog('Teste enviado com sucesso!', 'success');
                    showToast('Teste enviado para impressão!', 'success');
                } catch (error) {
                    addLog(`Erro ao imprimir: ${error.message}`, 'error');
                    showToast(`Erro: ${error.message}`, 'error');
                } finally {
                    elements.btnPrintTest.innerHTML = '<i class="fas fa-print"></i> Imprimir Teste';
                    elements.btnPrintTest.disabled = false;
                }
            }
            
            // Imprimir texto personalizado
            async function printCustomText() {
                if (!printer.isConnected) {
                    addLog('Conecte-se a uma impressora primeiro', 'error');
                    showToast('Conecte-se a uma impressora primeiro', 'error');
                    return;
                }
                
                const text = elements.printText.value;
                if (!text.trim()) {
                    addLog('Digite algum texto para imprimir', 'error');
                    showToast('Digite algum texto para imprimir', 'error');
                    return;
                }
                
                const options = {
                    alignment: elements.alignment.value,
                    fontSize: elements.fontSize.value,
                    bold: elements.bold.checked,
                    underline: elements.underline.checked,
                    cutPaper: true
                };
                
                try {
                    elements.btnPrintCustom.innerHTML = '<div class="loading"></div> Enviando...';
                    elements.btnPrintCustom.disabled = true;
                    
                    addLog('Enviando texto para impressão...', 'info');
                    await printer.printText(text, options);
                    addLog('Texto enviado com sucesso!', 'success');
                    showToast('Texto enviado para impressão!', 'success');
                } catch (error) {
                    addLog(`Erro ao imprimir: ${error.message}`, 'error');
                    showToast(`Erro: ${error.message}`, 'error');
                } finally {
                    elements.btnPrintCustom.innerHTML = '<i class="fas fa-paper-plane"></i> Imprimir Personalizado';
                    elements.btnPrintCustom.disabled = false;
                }
            }
            
            // Executar comando rápido
            async function executeCommand(command) {
                if (!printer.isConnected) {
                    addLog('Conecte-se a uma impressora primeiro', 'error');
                    showToast('Conecte-se a uma impressora primeiro', 'error');
                    return;
                }
                
                try {
                    const button = document.querySelector(`[data-command="${command}"]`);
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<div class="loading"></div>';
                        button.disabled = true;
                        
                        addLog(`Executando comando: ${command}`, 'info');
                        await printer.sendCommand(command);
                        addLog(`Comando ${command} executado`, 'success');
                        
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }, 1000);
                    }
                } catch (error) {
                    addLog(`Erro no comando: ${error.message}`, 'error');
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }
            
            // Limpar área de texto
            function clearText() {
                elements.printText.value = '';
                addLog('Área de texto limpa', 'info');
                showToast('Texto limpo');
            }
            
            // Limpar log
            function clearLog() {
                elements.log.innerHTML = '';
                addLog('Log limpo', 'info');
            }
            
            // Buscar dispositivos (mostrar modal)
            function scanDevices() {
                try {
                    addLog('Buscando dispositivos Bluetooth...', 'info');
                    
                    // Mostrar instruções no modal
                    showDeviceModal();
                    
                } catch (error) {
                    addLog(`Erro ao buscar dispositivos: ${error.message}`, 'error');
                }
            }
            
            // Mostrar modal com dispositivos
            function showDeviceModal() {
                elements.modalDeviceList.innerHTML = `
                    <div class="device-item">
                        <div>
                            <strong><i class="fas fa-info-circle"></i> Instruções:</strong>
                            <p>1. Certifique-se que a impressora está ligada e em modo de pareamento</p>
                            <p>2. Clique em "Conectar Impressora" no painel principal</p>
                            <p>3. Selecione o dispositivo "JP-80H" ou similar na lista do navegador</p>
                            <p>4. Aguarde a conexão ser estabelecida</p>
                            <p><strong>Dispositivos compatíveis:</strong></p>
                            <ul>
                                <li>JP-80H</li>
                                <li>JP-...</li>
                                <li>BT-... (Bluetooth)</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                elements.modal.style.display = 'block';
            }
            
            // Event Listeners
            elements.btnConnect.addEventListener('click', connectToPrinter);
            elements.btnDisconnect.addEventListener('click', disconnectPrinter);
            elements.btnScan.addEventListener('click', scanDevices);
            elements.btnPrintTest.addEventListener('click', printTest);
            elements.btnPrintCustom.addEventListener('click', printCustomText);
            elements.btnClear.addEventListener('click', clearText);
            elements.btnClearLog.addEventListener('click', clearLog);
            elements.btnRefresh.addEventListener('click', scanDevices);
            
            // Comandos rápidos
            elements.commandButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    executeCommand(command);
                });
            });
            
            // Atalhos de teclado
            document.addEventListener('keydown', (e) => {
                // Ctrl + Enter para imprimir
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    printCustomText();
                }
                
                // Ctrl + L para limpar
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    clearText();
                }
                
                // Ctrl + D para desconectar
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    if (printer.isConnected) {
                        disconnectPrinter();
                    }
                }
            });
            
            // Inicializar
            initUI();
            addLog('Aplicação iniciada. Clique em "Conectar Impressora" para começar.', 'info');
            
            // Verificar suporte a Web Bluetooth
            if (!navigator.bluetooth) {
                const errorMsg = 'Web Bluetooth API não é suportada neste navegador. Use Chrome 56+, Edge 79+ ou Opera 43+';
                addLog(`ERRO: ${errorMsg}`, 'error');
                showToast(errorMsg, 'error');
                
                // Desabilitar botões
                elements.btnConnect.disabled = true;
                elements.btnScan.disabled = true;
                elements.btnConnect.title = 'Web Bluetooth não suportado';
                elements.btnConnect.innerHTML = '<i class="fas fa-ban"></i> Não Suportado';
            }
            
            // Verificar se é HTTPS (requerido para Web Bluetooth)
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                addLog('AVISO: Web Bluetooth requer HTTPS em produção', 'info');
            }
        });
    </script>
</body>
</html>
